var P=Object.defineProperty;var N=(d,s,y)=>s in d?P(d,s,{enumerable:!0,configurable:!0,writable:!0,value:y}):d[s]=y;var c=(d,s,y)=>(N(d,typeof s!="symbol"?s+"":s,y),y);import{o as h,_ as k,R as O,q as L,D as j,c as R,F as V,B,d as A}from"./vendor-c23458f1.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const n of l.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&e(n)}).observe(document,{childList:!0,subtree:!0});function y(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function e(i){if(i.ep)return;i.ep=!0;const l=y(i);fetch(i.href,l)}})();function g(d,...s){console.log(`[${d}]`,JSON.stringify([...s]))}function _(d){return d.isAuthenticated?(location.href="/#/logging-in",h(k,{})):h(k,{children:["Main page -"," ",h("a",{href:"https://o2g.itssimple.se/authenticate/everversedata?state=dataverse-"+new Date().getTime(),children:"Log in"})]})}function $(){const d=window.apiClient,s=O();g("Auth","Authenticated page, getting code",s);const e=new URL(s,location.origin).searchParams.get("code");return e?(d.getToken("",e).then(()=>{g("Auth","Got token, redirecting to dashboard"),location.href="/#/logging-in"}).catch(i=>{g("Auth","Failed to get token, redirecting to main page"),location.href="/"}),h(k,{children:"Authenticated, redirecting to Dashboard"})):(g("Auth","No code found, redirecting to main page"),location.href="/",h(k,{children:"Redirecting to main page"}))}function U(d){return d.isAuthenticated.value?d.isDataLoaded.value?h(k,{children:"Blep"}):(location.href="/#/logging-in",h(k,{})):(location.href="/",h(k,{}))}function F(){return h("footer",{className:"fui body fiction",children:["Â© 2023",new Date().getUTCFullYear()!=2023?" - "+new Date().getUTCFullYear():null," ","NoLifeKing85#2914"]})}function J(d){const s=window.apiClient,y=window.eventEmitter;y.addEventListener("loading-text",i=>{i&&e(i)});function e(i){let l=document.getElementById("loading-text");l&&(l.innerText=i)}return s.checkIfAuthenticated().then(async i=>{if(!i){location.href="/";return}g("LOGIN","Authenticated, checking manifests"),e("Checking manifest ...");let l=await s.checkManifestVersion();if(l==null){e("Something is wrong with Destiny 2, please reload the page.");return}g("LOGIN",l);let n=await s.checkStoredDefinitions(!1);n.length>0&&(e(`Downloading ${n.length} missing definition(s)`),await s.checkStoredDefinitions(!0)),e("Loading data..."),await s.loadDataFromStorage(),e("Loading data... done"),d.isDataLoaded.value=!0,setTimeout(()=>{e("Opening application..."),y.emit("manifests-loaded"),setTimeout(()=>{location.href="/#/dashboard"},1e3)},1e3)}),h(k,{children:h("span",{class:"fui body",id:"loading-text",children:"..."})})}function q(){const d=L(window.appState);return h(k,{children:[h("header",{className:"header subscreen",children:"Dataverse"}),h("div",{class:"app",children:h(j,{history:R(),children:[h(k,{path:"/",children:h(_,{...d})}),h(k,{path:"/authenticated",children:h($,{})}),h(k,{path:"/logging-in",children:h(J,{...d})}),h(k,{path:"/dashboard",children:h(U,{...d})})]})}),h(F,{})]})}class G{constructor(){c(this,"DBInstance");c(this,"initializeDatabase");c(this,"setItem");c(this,"setItems");c(this,"getItem");c(this,"removeItem");c(this,"setStorageItem");c(this,"setStorageItems");c(this,"getStorageItem");c(this,"getStorageItems");c(this,"removeStorageItem");this.DBInstance=null,this.initializeDatabase=async function(){return new Promise((n,r)=>{let m=window.indexedDB.open("destiny2-dataverse",2);m.onupgradeneeded=function(o){const D=m.result;g("DB","Old",o.oldVersion,"New",o.newVersion),o.oldVersion<1&&(g("DB","Creating first version of database, since it never existed on this installation."),D.createObjectStore("storage",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key")),o.oldVersion<2&&(g("DB","Creating object store for player/character activity"),D.createObjectStore("playerActivity",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"),D.createObjectStore("activityDetails",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"))},m.onsuccess=function(o){g("DB","Loaded database"),l.DBInstance=o.target.result,n()},m.onerror=function(o){g("DB","Failed to load database"),r(o)}})};async function s(n,r,m){return new Promise((o,D)=>{const w=l.DBInstance.transaction(n,"readwrite").objectStore(n).put({key:r,value:m});w.onsuccess=function(){o()},w.onerror=function(u){D(u)}})}async function y(n,r=null){return new Promise((m,o)=>{const S=l.DBInstance.transaction(n,"readonly").objectStore(n).getAll();S.onsuccess=function(){const w=S.result;m(r?w.filter(r):w)},S.onerror=function(w){o(w)}})}async function e(n,r,m=null){return new Promise((o,D)=>{const w=l.DBInstance.transaction(n,"readonly").objectStore(n).get(r);w.onsuccess=function(u){u.target.result?o(u.target.result.value):o(m)},w.onerror=function(u){D(u)}})}async function i(n,r){return new Promise((m,o)=>{const S=l.DBInstance.transaction(n,"readwrite").objectStore(n).delete(r);S.onsuccess=function(){m()},S.onerror=function(w){o(w)}})}this.setItem=async function(n,r){return await s("storage",n,r)},this.setItems=async function(n){for(let r of n)await s("storage",r.key,r.value)},this.getItem=async function(n,r=null){return await e("storage",n,r)},this.removeItem=async function(n){return await i("storage",n)},this.setStorageItem=async function(n,r,m){return await s(n,r,m)},this.setStorageItems=async function(n,r){for(let m of r)await s(n,m.key,m.value)},this.getStorageItem=async function(n,r,m=null){return await e(n,r,m)},this.getStorageItems=async function(n,r=null){return await y(n,r)},this.removeStorageItem=async function(n,r){return await i(n,r)};var l=this;return this}}class z{constructor(){c(this,"eventListeners");c(this,"addEventListener");c(this,"emit");return this.eventListeners=[],this.addEventListener=function(s,y){g("EVENT:REGISTERED",s),this.eventListeners.push({eventName:s,handler:y})},this.emit=async function(s,...y){return JSON.parse(await window.db.getItem("d2-debugmode")??"false")?g("EVENT:EMITTING",s,...y):g("EVENT:EMITTING",s),new Promise((i,l)=>{this.eventListeners.filter(n=>n.eventName==s).forEach(async n=>{try{await n.handler(...y)}catch(r){g("EVENT:ERROR",s,r),console.error(r),l(r)}}),i(!0)})},g("EventEmitter","Initialized"),this}}class H{constructor(s,y){c(this,"checkIfAuthenticated");c(this,"getToken");c(this,"refreshToken");c(this,"checkManifestVersion");c(this,"checkStoredDefinitions");c(this,"loadDestinyContentData");c(this,"loadDataFromStorage");c(this,"getManifest");c(this,"loadCommonSettings");c(this,"getUserToken");c(this,"apiToken");c(this,"applicationName");c(this,"cachedManifest");c(this,"destinyDataDefinition");c(this,"lastVersion");c(this,"profile");c(this,"linkedProfiles");o("Initializing");const e=window.db,i=window.eventEmitter,l="https://o2g.itssimple.se",n="https://www.bungie.net",r="https://www.bungie.net/Platform",m=["DestinyActivityTypeDefinition","DestinyActivityDefinition","DestinyArtifactDefinition","DestinyChecklistDefinition","DestinyClassDefinition","DestinyDestinationDefinition","DestinyDamageTypeDefinition","DestinyFactionDefinition","DestinyGenderDefinition","DestinyItemCategoryDefinition","DestinyItemTierTypeDefinition","DestinyInventoryBucketDefinition","DestinyInventoryItemDefinition","DestinyMedalTierDefinition","DestinyMetricDefinition","DestinyMilestoneDefinition","DestinyObjectiveDefinition","DestinyPlaceDefinition","DestinyPresentationNodeDefinition","DestinyProgressionDefinition","DestinyRaceDefinition","DestinyRecordDefinition","DestinySeasonDefinition","DestinySeasonPassDefinition","DestinyStatDefinition","DestinyTraitDefinition"];this.lastVersion=null,this.applicationName=y,this.apiToken=s,this.destinyDataDefinition={};function o(...t){g("D2API",t)}async function D(t,f,a=null,p=null){let I={};return a!==null&&(I["Content-Type"]="application/json",I["x-api-key"]=u.apiToken,p!==null&&(I.authorization=`Bearer ${p}`)),a!==null?await fetch(f,{method:t,headers:I,body:a}):await fetch(f,{method:t,headers:I})}async function T(){await e.getItem("destinyTokenExpires")<Date.now()&&(o("Token expired, refreshing"),await u.refreshToken())}function S(t){if(t.error)return o("Error handling token",JSON.stringify(t)),e.removeItem("destinyToken"),e.removeItem("destinyRefreshToken"),e.removeItem("destinyTokenExpires"),e.removeItem("destinyRefreshTokenExpires"),e.removeItem("destinyBungieMembershipId"),!1;e.setItem("destinyToken",t.access_token),e.setItem("destinyRefreshToken",t.refresh_token);let f=Date.now()+t.expires_in*1e3;e.setItem("destinyTokenExpires",f);let a=Date.now()+t.refresh_expires_in*1e3;return e.setItem("destinyRefreshTokenExpires",a),e.setItem("destinyBungieMembershipId",t.membership_id),!0}this.loadDataFromStorage=async()=>{o("Loading data from storage");let t=await e.getItem("manifest");t!==null&&(u.cachedManifest=JSON.parse(t));let f=await e.getItem("manifestVersion");f!==null&&(u.lastVersion=f),u.checkStoredDefinitions();for(let I of m){let v=await e.getItem(`destinyContent-${I}`);v!==null&&(u.destinyDataDefinition[I]=JSON.parse(v))}let a=await e.getItem("destiny-profile");a!==null&&(u.profile=JSON.parse(a));let p=await e.getItem("destiny-linkedProfiles");p!==null&&(u.linkedProfiles=JSON.parse(p)),o("Data loaded from storage"),i.emit("destiny-data-loaded")},this.checkIfAuthenticated=async()=>{try{await T();const t=await e.getItem("destinyToken")!==null;return i.emit("destiny2:authenticated",t),t}catch(t){return o("Error checking if authenticated",t),i.emit("destiny2:authenticated",!1),!1}},this.getToken=async(t,f)=>{const a=await D("POST",`${l}/token/${u.applicationName}`,JSON.stringify({code:f}));if(a.status===200){let p=await a.json();return S(p)?i.emit("destiny2:auth-success"):i.emit("destiny2:auth-failed"),p}o("Error getting token",a.status,a.statusText,await a.text()),i.emit("destiny2:auth-failed")},this.refreshToken=async()=>{const t=await e.getItem("destinyRefreshToken");if(t==null)return i.emit("destiny2:refreshToken",null),null;const f=await D("POST",`${l}/refresh/${u.applicationName}`,JSON.stringify({refresh_token:t}));if(f.status===200){let a=await f.json();S(a)?i.emit("destiny2:refresh-success"):i.emit("destiny2:refresh-failed");return}else i.emit("destiny2:refresh-failed")},this.checkManifestVersion=async()=>(o("Checking manifest version"),new Promise(async function(t,f){let a=await u.getManifest();if(a==null)return o("Failed to fetch API"),null;let p=await e.getItem("manifestVersion")??"null";if(console.log(a,p),a.Response.version!==p){await e.removeItem("lastManifestUpdate"),await e.removeItem("manifest"),await e.removeItem("manifestVersion");for(let I of m)await e.removeItem(`destinyContent-${I}`);u.cachedManifest=a.Response,await e.setItem("manifestVersion",a.Response.version),await e.setItem("manifest",JSON.stringify(u.cachedManifest)),await e.setItem("lastManifestUpdate",Date.now()),t({updatedManifest:!0,version:u.lastVersion}),o("Manifest updated");return}u.cachedManifest=a.Response,t({updatedManifest:!1,version:u.lastVersion}),o("Manifest version is up to date")})),this.checkStoredDefinitions=async function(t=!0){let f=[];for(let a of m)await e.getItem(`destinyContent-${a}`)===null&&f.push(a);if(f.length>0&&t){for(let a of f)await e.removeItem(`destinyContent-${a}`);await u.loadDestinyContentData(f)}return f},this.loadDestinyContentData=async function(t=[]){for(let f of t)await w(f)};async function w(t){let f=u.cachedManifest;const a=t.replace("Destiny","").split(/(?=[A-Z])/).join(" ");i.emit("loading-text",`Loading ${a}`);const p=await D("GET",`${n}${f.jsonWorldComponentContentPaths.en[t]}`);p.headers.get("content-length");let I=0;const v=new Response(new ReadableStream({async start(M){const C=p.body.getReader();for(;;){var b=await C.read();if(b.done)break;I+=b.value.byteLength,i.emit("loading-text",`Loading ${a} (${new Intl.NumberFormat("sv-SE").format(I/1024/1024)} MB)`),M.enqueue(b.value)}M.close()}}));if(p.status!==200){g("Manifest download error",await v.json());return}const E=await v.json();u.destinyDataDefinition[t]=E,e.setItem(`destinyContent-${t}`,JSON.stringify(E))}this.getManifest=async function(){let t=await e.getItem("lastManifestUpdate");if(o("Checking if manifest is cached"),t!==null&&Date.now()-t<6e4*60){let a=await e.getItem("manifest");if(a!==null)return o("Manifest is cached"),{Response:JSON.parse(a)}}let f=await D("GET",`${r}/Destiny2/Manifest/`);if(f.status===200){let a=await f.json();return a.ErrorStatus=="Success"?(e.setItem("lastManifestUpdate",Date.now()),e.setItem("manifest",JSON.stringify(a.Response)),o("Manifest updated from API"),{Response:a.Response}):(o("Manifesterror"),o(a.Response),null)}else{let a=f.json();return o("Error when fetching Manifest"),o(a),null}},this.loadCommonSettings=async function(){await T();const t=await D("GET",`${r}/Settings`,null,await this.getUserToken());return t.status===200?await t.json():(o("Error fetching common settings",t.status,t.statusText),null)},this.getUserToken=async function(){return await e.getItem("destinyToken")};let u=this;return o("Initialized"),this}}g("MAIN","Starting app...");window.eventEmitter=new z;window.db=new G;window.apiClient=new H("5625a52ed6b54ecfb8246071cfcd6085","everversedata");function K(){const d=A(!1),s=A(!1);return{isDataLoaded:d,isAuthenticated:s}}const x=K();window.appState=V(x);window.db.initializeDatabase().then(async()=>{g("MAIN","Database initialized, checking for updates..."),x.isAuthenticated.value=await window.apiClient.checkIfAuthenticated(),B(h(q,{}),document.getElementById("app"))});
//# sourceMappingURL=index-fb4616a0.js.map
