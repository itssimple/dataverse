{"version":3,"file":"index-d63b9753.js","sources":["../../src/scripts/log.ts","../../src/pages/main-page.tsx","../../src/pages/authenticated.tsx","../../src/pages/dashboard.tsx","../../src/components/footer.tsx","../../src/pages/logging-in.tsx","../../src/app.tsx","../../src/scripts/indexedDB.ts","../../src/scripts/eventEmitter.ts","../../src/scripts/apiClient.ts","../../src/main.tsx"],"sourcesContent":["/**\n *\n * @param {string} category What part of the script we currently are in\n * @param {...any} params   Everything else, text, objects and so forth.\n */\nexport function log(category: string, ...params: any[]): void {\n  if (timestampLogs) {\n    params = [...params, new Date().toISOString()];\n  }\n  console.log(`[${category}]`, JSON.stringify([...params]));\n}\n\nvar timestampLogs = false;\n","export default function MainPage(props: { authenticated: boolean }) {\n  if (props.authenticated) {\n    // User is supposedly logged in, redirecting to login page to check auth and manifest\n    location.href = \"/#/logging-in\";\n    return <></>;\n  }\n\n  return (\n    <>\n      Main page -{\" \"}\n      <a\n        href={\n          import.meta.env.VITE_BUNGIE_API_AUTHURL +\n          \"?state=dataverse-\" +\n          new Date().getTime()\n        }\n      >\n        Log in\n      </a>\n    </>\n  );\n}\n","import { getCurrentUrl } from \"preact-router\";\nimport { log } from \"../scripts/log\";\n\nexport default function Authenticated() {\n  const apiClient = window.apiClient;\n\n  const url = getCurrentUrl();\n  log(\"Auth\", \"Authenticated page, getting code\", url);\n  const authUrl = new URL(url, location.origin).searchParams;\n\n  const code = authUrl.get(\"code\");\n\n  log(\"Auth\", \"Code\", code);\n\n  if (!code) {\n    log(\"Auth\", \"No code found, redirecting to main page\");\n    location.href = \"/\";\n    return <>Redirecting to main page</>;\n  }\n\n  apiClient\n    .getToken(\"\", code)\n    .then(() => {\n      log(\"Auth\", \"Got token, redirecting to dashboard\");\n      location.href = \"/#/logging-in\";\n    })\n    .catch((err) => {\n      log(\"Auth\", \"Failed to get token, redirecting to main page\");\n      location.href = \"/\";\n    });\n\n  return <>Authenticated, redirecting to Dashboard</>;\n}\n","export default function Dashboard() {\n  const apiClient = window.apiClient;\n\n  apiClient.checkIfAuthenticated().then((result) => {\n    if (!result) {\n      location.href = \"/\";\n    }\n  });\n\n  return <>Blep</>;\n}\n","export function Footer() {\n  return (\n    <footer className=\"fui body fiction\">\n      Â© 2023\n      {new Date().getUTCFullYear() != 2023\n        ? \" - \" + new Date().getUTCFullYear()\n        : null}{\" \"}\n      NoLifeKing85#2914\n    </footer>\n  );\n}\n","import { log } from \"../scripts/log\";\n\nexport default function LoggingIn() {\n  const apiClient = window.apiClient;\n\n  const eventEmitter = window.eventEmitter;\n\n  eventEmitter.addEventListener(\"loading-text\", (data: any) => {\n    if (!!data) {\n      setLoadingText(data);\n    }\n  });\n\n  function setLoadingText(text: string) {\n    let loadingText = document.getElementById(\"loading-text\");\n    if (loadingText) {\n      loadingText.innerText = text;\n    }\n  }\n\n  // Check if the user has a valid token and/or is authenticated, if not, redirect to the main page so they can login\n  apiClient.checkIfAuthenticated().then(async (result) => {\n    if (!result) {\n      location.href = \"/\";\n      return;\n    }\n\n    log(\"LOGIN\", \"Authenticated, checking manifests\");\n\n    setLoadingText(\"Checking manifest ...\");\n    let manifestVersion = await apiClient.checkManifestVersion();\n\n    if (manifestVersion === null || manifestVersion === undefined) {\n      setLoadingText(\n        \"Something is wrong with Destiny 2, please reload the page.\"\n      );\n      return;\n    }\n\n    log(\"LOGIN\", manifestVersion);\n\n    let missingDefinitions = await apiClient.checkStoredDefinitions(false);\n\n    if (missingDefinitions.length > 0) {\n      setLoadingText(\n        `Downloading ${missingDefinitions.length} missing definition(s)`\n      );\n      await apiClient.checkStoredDefinitions(true);\n    }\n\n    setLoadingText(\"Loading data...\");\n    await apiClient.loadDataFromStorage();\n    setLoadingText(\"Loading data... done\");\n\n    setTimeout(() => {\n      setLoadingText(\"Opening application...\");\n      eventEmitter.emit(\"manifests-loaded\");\n    }, 1000);\n  });\n\n  return (\n    <>\n      <span class=\"fui body\" id=\"loading-text\">\n        ...\n      </span>\n    </>\n  );\n}\n","import { Router } from \"preact-router\";\nimport { Fragment } from \"preact/jsx-runtime\";\nimport { createHashHistory } from \"history\";\nimport \"./app.css\";\nimport MainPage from \"./pages/main-page\";\nimport Authenticated from \"./pages/authenticated\";\nimport Dashboard from \"./pages/dashboard\";\nimport { Footer } from \"./components/footer\";\nimport LoggingIn from \"./pages/logging-in\";\n\nexport function App(props: { authenticated: boolean }) {\n  return (\n    <>\n      <header className=\"header subscreen\">Dataverse</header>\n      <div class=\"app\">\n        <Router history={createHashHistory()}>\n          <Fragment path=\"/\">\n            <MainPage {...props} />\n          </Fragment>\n          <Fragment path=\"/authenticated\">\n            <Authenticated />\n          </Fragment>\n          <Fragment path=\"/logging-in\">\n            <LoggingIn />\n          </Fragment>\n          <Fragment path=\"/dashboard\">\n            <Dashboard />\n          </Fragment>\n        </Router>\n      </div>\n      <Footer />\n    </>\n  );\n}\n","import { log } from \"./log\";\nexport class Destiny2Database {\n  DBInstance: IDBDatabase | null;\n  initializeDatabase: () => Promise<void>;\n  setItem: (key: string, value: any) => Promise<void>;\n  setItems: (items: { key: string; value: any }[]) => Promise<void>;\n  getItem: (key: string, defaultValue?: null) => Promise<any>;\n  removeItem: (key: string) => Promise<void>;\n  setStorageItem: (\n    storageName: string,\n    key: string,\n    value: any\n  ) => Promise<void>;\n  setStorageItems: (\n    storageName: string,\n    items: { key: string; value: any }[]\n  ) => Promise<void>;\n  getStorageItem: (\n    storageName: string,\n    key: string,\n    defaultValue?: null\n  ) => Promise<any>;\n  getStorageItems: (storageName: string, filter?: null) => Promise<any>;\n  removeStorageItem: (storageName: string, key: string) => Promise<void>;\n  constructor() {\n    this.DBInstance = null;\n\n    this.initializeDatabase = async function () {\n      return new Promise<void>((resolve, reject) => {\n        let dbRequest = window.indexedDB.open(\"destiny2-dataverse\", 2);\n\n        dbRequest.onupgradeneeded = function (event) {\n          const db = dbRequest.result;\n\n          log(\"DB\", \"Old\", event.oldVersion, \"New\", event.newVersion);\n          if (event.oldVersion < 1) {\n            log(\n              \"DB\",\n              \"Creating first version of database, since it never existed on this installation.\"\n            );\n            const keyValueStore = db.createObjectStore(\"storage\", {\n              autoIncrement: false,\n              keyPath: \"key\",\n            });\n\n            keyValueStore.createIndex(\"by_key\", \"key\");\n          }\n          if (event.oldVersion < 2) {\n            log(\"DB\", \"Creating object store for player/character activity\");\n\n            const playerActivityStore = db.createObjectStore(\"playerActivity\", {\n              autoIncrement: false,\n              keyPath: \"key\",\n            });\n\n            playerActivityStore.createIndex(\"by_key\", \"key\");\n\n            const activityDetailsStore = db.createObjectStore(\n              \"activityDetails\",\n              {\n                autoIncrement: false,\n                keyPath: \"key\",\n              }\n            );\n\n            activityDetailsStore.createIndex(\"by_key\", \"key\");\n          }\n        };\n\n        dbRequest.onsuccess = function (e: any) {\n          log(\"DB\", \"Loaded database\");\n          self.DBInstance = e.target.result;\n\n          resolve();\n        };\n\n        dbRequest.onerror = function (event) {\n          log(\"DB\", \"Failed to load database\");\n          reject(event);\n        };\n      });\n    };\n\n    async function _setItem(storeName: string, key: string, value: any) {\n      return new Promise<void>((resolve, reject) => {\n        const transaction = self.DBInstance!.transaction(\n          storeName,\n          \"readwrite\"\n        );\n        const objectStore = transaction.objectStore(storeName);\n        const request = objectStore.put({\n          key: key,\n          value: value,\n        });\n\n        request.onsuccess = function () {\n          resolve();\n        };\n\n        request.onerror = function (event) {\n          reject(event);\n        };\n      });\n    }\n\n    async function _getFilteredItems(storeName: string, filter = null) {\n      return new Promise((resolve, reject) => {\n        const transaction = self.DBInstance!.transaction(storeName, \"readonly\");\n        const objectStore = transaction.objectStore(storeName);\n        const request = objectStore.getAll();\n\n        request.onsuccess = function () {\n          const result = request.result;\n\n          if (filter) {\n            resolve(result.filter(filter));\n          } else {\n            resolve(result);\n          }\n        };\n\n        request.onerror = function (event) {\n          reject(event);\n        };\n      });\n    }\n\n    async function _getItem(\n      storeName: string,\n      key: string,\n      defaultValue: any | null = null\n    ) {\n      return new Promise((resolve, reject) => {\n        const transaction = self.DBInstance!.transaction(storeName, \"readonly\");\n        const objectStore = transaction.objectStore(storeName);\n        const request = objectStore.get(key);\n\n        request.onsuccess = function (event: any) {\n          if (event.target.result) {\n            resolve(event.target.result.value);\n          } else {\n            resolve(defaultValue);\n          }\n        };\n\n        request.onerror = function (event) {\n          reject(event);\n        };\n      });\n    }\n\n    async function _removeItem(storeName: string, key: string) {\n      return new Promise<void>((resolve, reject) => {\n        const transaction = self.DBInstance!.transaction(\n          storeName,\n          \"readwrite\"\n        );\n        const objectStore = transaction.objectStore(storeName);\n        const request = objectStore.delete(key);\n\n        request.onsuccess = function () {\n          resolve();\n        };\n\n        request.onerror = function (event) {\n          reject(event);\n        };\n      });\n    }\n\n    this.setItem = async function (key: string, value: any) {\n      return await _setItem(\"storage\", key, value);\n    };\n\n    this.setItems = async function (items: { key: string; value: any }[]) {\n      for (let item of items) {\n        await _setItem(\"storage\", item.key, item.value);\n      }\n    };\n\n    this.getItem = async function (\n      key: string,\n      defaultValue: any | null = null\n    ) {\n      return await _getItem(\"storage\", key, defaultValue);\n    };\n\n    this.removeItem = async function (key: string) {\n      return await _removeItem(\"storage\", key);\n    };\n\n    this.setStorageItem = async function (\n      storageName: string,\n      key: string,\n      value: any | null\n    ) {\n      return await _setItem(storageName, key, value);\n    };\n\n    this.setStorageItems = async function (\n      storageName: string,\n      items: { key: string; value: any }[]\n    ) {\n      for (let item of items) {\n        await _setItem(storageName, item.key, item.value);\n      }\n    };\n\n    this.getStorageItem = async function (\n      storageName,\n      key,\n      defaultValue = null\n    ) {\n      return await _getItem(storageName, key, defaultValue);\n    };\n\n    this.getStorageItems = async function (storageName: string, filter = null) {\n      return await _getFilteredItems(storageName, filter);\n    };\n\n    this.removeStorageItem = async function (storageName: string, key: string) {\n      return await _removeItem(storageName, key);\n    };\n\n    var self = this;\n\n    return this;\n  }\n}\n","import { log } from \"./log.js\";\n\nclass D2Event {\n  eventName!: string;\n  handler!: CallableFunction;\n}\n\nexport class EventEmitter {\n  eventListeners: D2Event[];\n  addEventListener: (eventName: string, eventHandler: any) => void;\n  emit: (eventName: string, ...params: any[]) => Promise<unknown>;\n  constructor() {\n    this.eventListeners = [];\n\n    /**\n     * Listen to an event sent from this event emitter\n     * @param {String} eventName The event that you want to listen to\n     * @param {CallableFunction} eventHandler The method that should run whenever the event occurs\n     */\n    this.addEventListener = function (\n      eventName: string,\n      eventHandler: CallableFunction\n    ) {\n      log(`EVENT:REGISTERED`, eventName);\n      this.eventListeners.push({ eventName: eventName, handler: eventHandler });\n    };\n\n    /**\n     * Triggers an event, that will invoke all listeners\n     * @param {String} eventName\n     * @param {any[]} params\n     */\n    this.emit = async function (eventName: string, ...params: any[]) {\n      let logArguments = JSON.parse(\n        (await window.db.getItem(\"d2-debugmode\")) ?? \"false\"\n      );\n      if (logArguments) {\n        log(\"EVENT:EMITTING\", eventName, ...params);\n      } else {\n        log(\"EVENT:EMITTING\", eventName);\n      }\n      return new Promise((resolve, reject) => {\n        this.eventListeners\n          .filter((ev) => ev.eventName == eventName)\n          .forEach(async (l) => {\n            try {\n              await l.handler(...params);\n            } catch (e) {\n              log(\"EVENT:ERROR\", eventName, e);\n              console.error(e);\n              reject(e);\n            }\n          });\n\n        resolve(true);\n      });\n    };\n\n    log(\"EventEmitter\", \"Initialized\");\n\n    return this;\n  }\n}\n","import { log } from \"./log\";\n\nexport class Destiny2ApiClient {\n  checkIfAuthenticated: () => Promise<boolean>;\n  getToken: (state: string, code: string) => Promise<any>;\n  refreshToken: () => Promise<any>;\n  checkManifestVersion: () => Promise<{\n    updatedManifest: boolean;\n    version: string | null;\n  } | null>;\n  checkStoredDefinitions: (\n    downloadMissingDefinitions?: boolean\n  ) => Promise<string[]>;\n  loadDestinyContentData: (definitions: string[]) => Promise<void>;\n  loadDataFromStorage: () => Promise<void>;\n  getManifest: () => Promise<{\n    Response: any;\n  } | null>;\n\n  apiToken: string;\n  applicationName: string;\n  cachedManifest: any;\n  destinyDataDefinition: { [key: string]: any };\n  lastVersion: string | null;\n  profile: any | null;\n  linkedProfiles: any | null;\n\n  constructor(apiToken: string, appName: string) {\n    _log(\"Initializing\");\n\n    const db = window.db;\n    const eventEmitter = window.eventEmitter;\n\n    const authGatewayUrl = \"https://o2g.itssimple.se\";\n    const destinyBaseUrl = \"https://www.bungie.net\";\n    const destinyApiUrl = \"https://www.bungie.net/Platform\";\n\n    const maxActivitiesPerFetch = 250;\n\n    /**\n     * @description The datatypes we are interested in.\n     */\n    const destinyDataTypes = [\n      \"DestinyActivityTypeDefinition\",\n      \"DestinyActivityDefinition\",\n      \"DestinyArtifactDefinition\",\n      \"DestinyChecklistDefinition\",\n      \"DestinyClassDefinition\",\n      \"DestinyDestinationDefinition\",\n      \"DestinyDamageTypeDefinition\",\n      \"DestinyFactionDefinition\",\n      \"DestinyGenderDefinition\",\n      \"DestinyItemCategoryDefinition\",\n      \"DestinyItemTierTypeDefinition\",\n      \"DestinyInventoryBucketDefinition\",\n      \"DestinyInventoryItemDefinition\",\n      \"DestinyMedalTierDefinition\",\n      \"DestinyMetricDefinition\",\n      \"DestinyMilestoneDefinition\",\n      \"DestinyObjectiveDefinition\",\n      \"DestinyPlaceDefinition\",\n      \"DestinyPresentationNodeDefinition\",\n      \"DestinyProgressionDefinition\",\n      \"DestinyRaceDefinition\",\n      \"DestinyRecordDefinition\",\n      \"DestinySeasonDefinition\",\n      \"DestinySeasonPassDefinition\",\n      \"DestinyStatDefinition\",\n      \"DestinyTraitDefinition\",\n    ];\n\n    const DestinyItemState = {\n      None: 0,\n      Locked: 1,\n      Tracked: 2,\n      Masterwork: 4,\n    };\n\n    this.lastVersion = null;\n\n    this.applicationName = appName;\n\n    this.apiToken = apiToken;\n\n    this.destinyDataDefinition = {};\n\n    function _log(...params: any[]) {\n      log(\"D2API\", params);\n    }\n\n    async function callUrl(\n      method: \"GET\" | \"POST\" | \"PUT\" | \"PATCH\" | \"DELETE\",\n      url: string,\n      body: any | null = null,\n      authorization: any | null = null\n    ) {\n      let headers: RequestInit[\"headers\"] = {};\n\n      if (body !== null) {\n        headers[\"Content-Type\"] = \"application/json\";\n        headers[\"x-api-key\"] = self.apiToken;\n        if (authorization !== null) {\n          headers.authorization = `Bearer ${authorization}`;\n        }\n      }\n\n      if (body !== null) {\n        return await fetch(url, {\n          method: method,\n          headers: headers,\n          body: body,\n        });\n      } else {\n        return await fetch(url, {\n          method: method,\n          headers: headers,\n        });\n      }\n    }\n\n    async function refreshTokenIfExpired() {\n      const tokenExpires = await db.getItem(\"destinyTokenExpires\");\n\n      if (tokenExpires < Date.now()) {\n        _log(\"Token expired, refreshing\");\n        await self.refreshToken();\n      }\n    }\n\n    function handleTokenResponse(tokenResponse: any) {\n      // Check if tokenResponse contains a property called error, and if so, log the error and return\n      if (tokenResponse.error) {\n        _log(\"Error handling token\", JSON.stringify(tokenResponse));\n\n        db.removeItem(\"destinyToken\");\n        db.removeItem(\"destinyRefreshToken\");\n        db.removeItem(\"destinyTokenExpires\");\n        db.removeItem(\"destinyRefreshTokenExpires\");\n        db.removeItem(\"destinyBungieMembershipId\");\n\n        return false;\n      }\n\n      // Set the token and refresh token in the database\n      db.setItem(\"destinyToken\", tokenResponse.access_token);\n      db.setItem(\"destinyRefreshToken\", tokenResponse.refresh_token);\n\n      // Calculate when the token expires and set it in the database\n      let tokenExpires = Date.now() + tokenResponse.expires_in * 1000;\n      db.setItem(\"destinyTokenExpires\", tokenExpires);\n\n      // Calculate when the refresh token expires and set it in the database\n      let refreshTokenExpires =\n        Date.now() + tokenResponse.refresh_expires_in * 1000;\n      db.setItem(\"destinyRefreshTokenExpires\", refreshTokenExpires);\n\n      // Set the membership_id in the database\n      db.setItem(\"destinyBungieMembershipId\", tokenResponse.membership_id);\n\n      return true;\n    }\n\n    this.loadDataFromStorage = async () => {\n      _log(\"Loading data from storage\");\n\n      let _cachedManifest = await db.getItem(\"manifest\");\n      if (_cachedManifest !== null) {\n        self.cachedManifest = JSON.parse(_cachedManifest);\n      }\n\n      let _cachedManifestVersion = await db.getItem(\"manifestVersion\");\n      if (_cachedManifestVersion !== null) {\n        self.lastVersion = _cachedManifestVersion;\n      }\n\n      self.checkStoredDefinitions();\n\n      for (let dataType of destinyDataTypes) {\n        let _cachedData = await db.getItem(`destinyContent-${dataType}`);\n        if (_cachedData !== null) {\n          self.destinyDataDefinition[dataType] = JSON.parse(_cachedData);\n        }\n      }\n\n      let _profile = await db.getItem(\"destiny-profile\");\n      if (_profile !== null) {\n        self.profile = JSON.parse(_profile);\n      }\n\n      let _linkedProfiles = await db.getItem(\"destiny-linkedProfiles\");\n      if (_linkedProfiles !== null) {\n        self.linkedProfiles = JSON.parse(_linkedProfiles);\n      }\n\n      _log(\"Data loaded from storage\");\n      eventEmitter.emit(\"destiny-data-loaded\");\n    };\n\n    this.checkIfAuthenticated = async () => {\n      try {\n        await refreshTokenIfExpired();\n        const isAuthenticated = (await db.getItem(\"destinyToken\")) !== null;\n        eventEmitter.emit(\"destiny2:authenticated\", isAuthenticated);\n        return isAuthenticated;\n      } catch (e) {\n        _log(\"Error checking if authenticated\", e);\n        eventEmitter.emit(\"destiny2:authenticated\", false);\n        return false;\n      }\n    };\n\n    this.getToken = async (state: string, code: string) => {\n      const tokenRequest = await callUrl(\n        \"POST\",\n        `${authGatewayUrl}/token/${self.applicationName}`,\n        JSON.stringify({\n          code: code,\n        })\n      );\n\n      if (tokenRequest.status === 200) {\n        let tokenResponse = await tokenRequest.json();\n\n        if (handleTokenResponse(tokenResponse)) {\n          eventEmitter.emit(\"destiny2:auth-success\");\n        } else {\n          eventEmitter.emit(\"destiny2:auth-failed\");\n        }\n        return tokenResponse;\n      }\n      _log(\n        \"Error getting token\",\n        tokenRequest.status,\n        tokenRequest.statusText,\n        await tokenRequest.text()\n      );\n      eventEmitter.emit(\"destiny2:auth-failed\");\n    };\n\n    this.refreshToken = async () => {\n      const refreshToken = await db.getItem(\"destinyRefreshToken\");\n      if (refreshToken == null) {\n        eventEmitter.emit(\"destiny2:refreshToken\", null);\n        return null;\n      }\n\n      const tokenRequest = await callUrl(\n        \"POST\",\n        `${authGatewayUrl}/refresh/${self.applicationName}`,\n        JSON.stringify({\n          refresh_token: refreshToken,\n        })\n      );\n\n      if (tokenRequest.status === 200) {\n        let tokenResponse = await tokenRequest.json();\n\n        if (handleTokenResponse(tokenResponse)) {\n          eventEmitter.emit(\"destiny2:refresh-success\");\n        } else {\n          eventEmitter.emit(\"destiny2:refresh-failed\");\n        }\n\n        return;\n      } else {\n        eventEmitter.emit(\"destiny2:refresh-failed\");\n      }\n    };\n\n    this.checkManifestVersion = async () => {\n      _log(\"Checking manifest version\");\n      return new Promise(async function (resolve, reject) {\n        let manifest = await self.getManifest();\n\n        if (manifest == null) {\n          _log(\"Failed to fetch API\");\n          return null;\n        }\n\n        let lastVersion = (await db.getItem(\"manifestVersion\")) ?? \"null\";\n\n        console.log(manifest, lastVersion);\n        if (manifest.Response.version !== lastVersion) {\n          /* Currently cached data is older than 60 minutes, so we clear it. */\n          await db.removeItem(\"lastManifestUpdate\");\n          await db.removeItem(\"manifest\");\n          await db.removeItem(\"manifestVersion\");\n\n          for (let dataType of destinyDataTypes) {\n            await db.removeItem(`destinyContent-${dataType}`);\n          }\n\n          self.cachedManifest = manifest.Response;\n\n          await db.setItem(\"manifestVersion\", manifest.Response.version);\n          await db.setItem(\"manifest\", JSON.stringify(self.cachedManifest));\n          await db.setItem(\"lastManifestUpdate\", Date.now());\n\n          resolve({ updatedManifest: true, version: self.lastVersion });\n          _log(\"Manifest updated\");\n          return;\n        }\n\n        self.cachedManifest = manifest.Response;\n\n        resolve({ updatedManifest: false, version: self.lastVersion });\n        _log(\"Manifest version is up to date\");\n      });\n    };\n\n    this.checkStoredDefinitions = async function (\n      downloadMissingDefinitions = true\n    ) {\n      let missingDefinitions: string[] = [];\n\n      for (let dataType of destinyDataTypes) {\n        let data = await db.getItem(`destinyContent-${dataType}`);\n        if (data === null) {\n          missingDefinitions.push(dataType);\n        }\n      }\n\n      if (missingDefinitions.length > 0 && downloadMissingDefinitions) {\n        for (let dataType of missingDefinitions) {\n          await db.removeItem(`destinyContent-${dataType}`);\n        }\n\n        await self.loadDestinyContentData(missingDefinitions);\n      }\n\n      return missingDefinitions;\n    };\n\n    this.loadDestinyContentData = async function (definitions: string[] = []) {\n      for (let dataType of definitions) {\n        await loadDestinyContentDataType(dataType);\n      }\n    };\n\n    async function loadDestinyContentDataType(dataType: string) {\n      let manifest = self.cachedManifest;\n\n      const dataTypeWords = dataType\n        .replace(\"Destiny\", \"\")\n        .split(/(?=[A-Z])/)\n        .join(\" \");\n\n      eventEmitter.emit(\"loading-text\", `Loading ${dataTypeWords}`);\n\n      const contentTypeDownload = await callUrl(\n        \"GET\",\n        `${destinyBaseUrl}${manifest.jsonWorldComponentContentPaths.en[dataType]}`\n      );\n\n      if (contentTypeDownload.status !== 200) {\n        log(\"Manifest download error\", await contentTypeDownload.json());\n        return;\n      }\n\n      const contentTypeJson = await contentTypeDownload.json();\n\n      self.destinyDataDefinition[dataType] = contentTypeJson;\n      db.setItem(`destinyContent-${dataType}`, JSON.stringify(contentTypeJson));\n    }\n\n    this.getManifest = async function (): Promise<{\n      Response: any;\n    } | null> {\n      let lastManifestUpdate = await db.getItem(\"lastManifestUpdate\");\n      _log(\"Checking if manifest is cached\");\n\n      if (\n        lastManifestUpdate !== null &&\n        Date.now() - lastManifestUpdate < 60000 * 60\n      ) {\n        let _manifest = await db.getItem(\"manifest\");\n        if (_manifest !== null) {\n          _log(\"Manifest is cached\");\n          return { Response: JSON.parse(_manifest) };\n        }\n      }\n\n      let manifestRequest = await callUrl(\n        \"GET\",\n        `${destinyApiUrl}/Destiny2/Manifest/`\n      );\n\n      if (manifestRequest.status === 200) {\n        let manifest = await manifestRequest.json();\n        if (manifest.ErrorStatus == \"Success\") {\n          db.setItem(\"lastManifestUpdate\", Date.now());\n          db.setItem(\"manifest\", JSON.stringify(manifest.Response));\n          _log(\"Manifest updated from API\");\n\n          return { Response: manifest.Response };\n        } else {\n          _log(\"Manifesterror\");\n          _log(manifest.Response);\n\n          return null;\n        }\n      } else {\n        let responseText = manifestRequest.json();\n        _log(\"Error when fetching Manifest\");\n        _log(responseText);\n\n        return null;\n      }\n    };\n\n    let self = this;\n\n    _log(\"Initialized\");\n    return this;\n  }\n}\n","import { render } from \"preact\";\nimport { log } from \"./scripts/log\";\nimport { App } from \"./app\";\nimport { Destiny2Database } from \"./scripts/indexedDB\";\nimport { EventEmitter } from \"./scripts/eventEmitter\";\nimport { Destiny2ApiClient } from \"./scripts/apiClient\";\nimport \"./assets/fonts/style.css\";\nimport \"./index.css\";\nimport \"./styles/main.scss\";\n\ndeclare global {\n  interface Window {\n    db: Destiny2Database;\n    eventEmitter: EventEmitter;\n    apiClient: Destiny2ApiClient;\n    appUrl: string;\n  }\n}\n\nlog(\"MAIN\", \"Starting app...\");\n\nwindow.eventEmitter = new EventEmitter();\nwindow.db = new Destiny2Database();\nwindow.apiClient = new Destiny2ApiClient(\n  import.meta.env.VITE_BUNGIE_API_KEY,\n  import.meta.env.VITE_BUNGIE_API_APP\n);\n\nwindow.db.initializeDatabase().then(async () => {\n  log(\"MAIN\", \"Database initialized, checking for updates...\");\n\n  const isAuthenticated = await window.apiClient.checkIfAuthenticated();\n\n  render(\n    <App authenticated={isAuthenticated} />,\n    document.getElementById(\"app\") as HTMLElement\n  );\n});\n"],"names":["log","category","params","JSON","stringify","MainPage","props","authenticated","location","href","_jsx","_Fragment","_jsxs","children","import","Date","getTime","Authenticated","apiClient","window","url","getCurrentUrl","code","URL","origin","searchParams","get","getToken","then","catch","err","Dashboard","checkIfAuthenticated","result","Footer","className","getUTCFullYear","LoggingIn","eventEmitter","addEventListener","data","setLoadingText","text","loadingText","document","getElementById","innerText","manifestVersion","checkManifestVersion","missingDefinitions","checkStoredDefinitions","length","loadDataFromStorage","setTimeout","emit","class","id","App","Router","history","createHashHistory","Fragment","path","Destiny2Database","constructor","DBInstance","initializeDatabase","setItem","setItems","getItem","removeItem","setStorageItem","setStorageItems","getStorageItem","getStorageItems","removeStorageItem","Promise","resolve","reject","dbRequest","indexedDB","open","onupgradeneeded","event","db","oldVersion","newVersion","createObjectStore","autoIncrement","keyPath","createIndex","onsuccess","e","target","onerror","_setItem","storeName","key","value","request","self","transaction","objectStore","put","_getFilteredItems","filter","getAll","_getItem","defaultValue","_removeItem","delete","items","item","storageName","EventEmitter","eventListeners","eventName","eventHandler","push","handler","parse","ev","forEach","l","console","error","Destiny2ApiClient","apiToken","appName","refreshToken","loadDestinyContentData","getManifest","applicationName","cachedManifest","destinyDataDefinition","lastVersion","profile","linkedProfiles","_log","authGatewayUrl","destinyBaseUrl","destinyApiUrl","destinyDataTypes","callUrl","method","body","authorization","headers","fetch","refreshTokenIfExpired","now","handleTokenResponse","tokenResponse","access_token","refresh_token","tokenExpires","expires_in","refreshTokenExpires","refresh_expires_in","membership_id","_cachedManifest","_cachedManifestVersion","dataType","_cachedData","_profile","_linkedProfiles","isAuthenticated","state","tokenRequest","status","json","statusText","manifest","Response","version","updatedManifest","downloadMissingDefinitions","definitions","loadDestinyContentDataType","dataTypeWords","replace","split","join","contentTypeDownload","jsonWorldComponentContentPaths","en","contentTypeJson","lastManifestUpdate","_manifest","manifestRequest","ErrorStatus","responseText","render"],"mappings":"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"}