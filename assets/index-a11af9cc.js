var U=Object.defineProperty;var G=(u,d,I)=>d in u?U(u,d,{enumerable:!0,configurable:!0,writable:!0,value:I}):u[d]=I;var g=(u,d,I)=>(G(u,typeof d!="symbol"?d+"":d,I),I);import{u as b,k as C,R as F,y as J,x as Q,D as K,c as z,Q as W,G as Y,d as E}from"./vendor-85dd4538.js";(function(){const d=document.createElement("link").relList;if(d&&d.supports&&d.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const m of n)if(m.type==="childList")for(const p of m.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&a(p)}).observe(document,{childList:!0,subtree:!0});function I(n){const m={};return n.integrity&&(m.integrity=n.integrity),n.referrerPolicy&&(m.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?m.credentials="include":n.crossOrigin==="anonymous"?m.credentials="omit":m.credentials="same-origin",m}function a(n){if(n.ep)return;n.ep=!0;const m=I(n);fetch(n.href,m)}})();function T(u,...d){window.showDataverseLogs&&console.log(`[${u}]`,JSON.stringify([...d]))}function Z(u){return u.isAuthenticated.value?(location.href="/#/logging-in",b(C,{})):b(C,{children:["Main page -"," ",b("a",{href:"https://o2g.itssimple.se/authenticate/everversedata?state=dataverse-"+new Date().getTime(),children:"Log in"})]})}function X(){const u=window.apiClient,d=F();T("Auth","Authenticated page, getting code",d);const a=new URL(d,location.origin).searchParams.get("code");return a?(u.getToken("",a).then(()=>{T("Auth","Got token, redirecting to dashboard"),location.href="/#/logging-in"}).catch(n=>{T("Auth","Failed to get token, redirecting to main page"),location.href="/"}),b(C,{children:"Authenticated, redirecting to Dashboard"})):(T("Auth","No code found, redirecting to main page"),location.href="/",b(C,{children:"Redirecting to main page"}))}function ee(u,d,I=!1){return!I&&!d?"Unknown, no end time":ie(ne(u,d))}function te(u,d,I){let a=[];return u>0&&a.push(`${u}d`),d>0&&a.push(`${d}h`),I>0&&a.push(`${I}m`),a.join(", ")}function ie(u){let{days:d,hours:I,minutes:a}=se(u);return te(d,I,a)}function ne(u,d){return d||(d=Date.now()),(d-u)/1e3}function se(u){let d=Math.floor(u/86400),I=Math.floor(u%(24*3600)/3600),a=Math.floor(u%3600/60),n=Math.floor(u%60);return{days:d,hours:I,minutes:a,seconds:n}}const M=new Intl.NumberFormat,ae="https://www.bungie.net";var R={milestones:!0,bounties:!0,quests:!0,records:!0,seasonRank:!0};function re(u){var o,f;const d=window.eventEmitter,I=window.apiClient;var a;J(()=>{d.addEventListener("goal-list-update",p),async function(){return await I.getTrackableData(),a=setInterval(async()=>{await I.getTrackableData()},15*1e3),()=>{clearInterval(a)}}()},[]);function n(e){let i=null;switch(e.inProgressValueStyle===0&&e.nextLevelAt===1&&(e.inProgressValueStyle=2),e.inProgressValueStyle){case 2:i=b("span",{className:"goal-progress",children:e.progressToNextLevel==0?"Incomplete":"Complete"});break;case 3:let r=(e.progressToNextLevel/e.nextLevelAt*100).toFixed(0);i=b("span",{className:"goal-progress",children:[r," %"]});break;case 8:i="";break;case 12:i=b("span",{className:"goal-progress",children:[e.progressToNextLevel," %"]});break;case 6:default:i=b("span",{className:"goal-progress",children:[M.format(e.progressToNextLevel)," /"," ",M.format(e.nextLevelAt)]});break}return typeof e.nextLevelAt<"u"?b(C,{children:i}):null}function m(e){let i=typeof e.icon<"u"?b("img",{className:"goal-icon",src:`${ae}${e.icon}`}):null,r=typeof e.endDate<"u"?b(C,{children:[b("br",{}),b("i",{class:"fui body fiction goal-end",children:["Ends in ",ee(new Date,new Date(e.endDate))]})]}):null,h=n(e);return b("div",{className:"goal-item",children:[i,b("div",{className:"goal-body",children:[b("h5",{children:[e.name,h]}),e.description,r]})]})}async function p(e){let i=[];for(let r of e){let h=!0;switch(r.type){case"milestone":h=R.milestones;break;case"quest":h=R.quests;break;case"bounty":h=R.bounties;break;case"characterRecord":h=R.records;break;case"seasonrank":h=R.seasonRank;break}h&&i.push(r)}u.goals.value=i}return b("div",{className:"goal-container",children:((f=(o=u.goals)==null?void 0:o.value)==null?void 0:f.length)>0?u.goals.value.map(e=>m(e)):b(C,{children:"Loading ..."})})}function oe(u){const d=window.apiClient;return!u.isAuthenticated.value||!u.isDataLoaded.value?(location.href="/",b(C,{})):(d.profile.profile,b(C,{children:b(re,{...u})}))}function le(){return b("footer",{className:"fui body fiction",children:["Â© 2023",new Date().getUTCFullYear()!=2023?" - "+new Date().getUTCFullYear():null," ","NoLifeKing85#2914"]})}function ce(u){const d=window.apiClient,I=window.eventEmitter;I.addEventListener("loading-text",n=>{n&&a(n)});function a(n){let m=document.getElementById("loading-text");m&&(m.innerText=n)}return d.checkIfAuthenticated().then(async n=>{if(!n){location.href="/";return}T("LOGIN","Authenticated, checking manifests"),a("Checking manifest ...");let m=await d.checkManifestVersion();if(m==null){a("Something is wrong with Destiny 2 (or this app), please reload the page.");return}T("LOGIN",m),a("Checking Destiny 2 server status");const p=await d.checkDestinyStatus();if(p&&!p.systems.Destiny2.enabled){a("Destiny 2 is currently down for maintenance, trying again in one minute."),setTimeout(()=>{location.href="/"},6e4);return}a("Loading profile data"),await d.getLastPlayedCharacter(),a("Checking for missing definitions");let o=await d.checkStoredDefinitions(!1);o.length>0&&(a(`Downloading ${o.length} missing definition(s)`),await d.checkStoredDefinitions(!0)),a("Loading data..."),await d.loadDataFromStorage(),u.isDataLoaded.value=!0,setTimeout(()=>{a("Opening application..."),I.emit("manifests-loaded"),setTimeout(()=>{location.href="/#/dashboard"},1e3)},1e3)}).catch(async n=>{n.status===503?(a("Bungie API is down, retrying in a minute."),setTimeout(()=>{location.href="/"},6e4)):(a("An error occurred while trying to log in, please try again."),console.error(n),console.error(await n.json()))}),b(C,{children:b("span",{class:"fui body",id:"loading-text",children:"Logging in and loading data ..."})})}function de(){return b("header",{className:"header subscreen",children:"Dataverse"})}function fe(){const u=Q(window.appState);return b(C,{children:[b(de,{}),b("div",{class:"app",children:b(K,{history:z(),children:[b(C,{path:"/",children:b(Z,{...u})}),b(C,{path:"/authenticated",children:b(X,{})}),b(C,{path:"/logging-in",children:b(ce,{...u})}),b(C,{path:"/dashboard",children:b(oe,{...u})})]})}),b(le,{})]})}class ue{constructor(){g(this,"DBInstance");g(this,"initializeDatabase");g(this,"setItem");g(this,"setItems");g(this,"getItem");g(this,"removeItem");g(this,"setStorageItem");g(this,"setStorageItems");g(this,"getStorageItem");g(this,"getStorageItems");g(this,"removeStorageItem");this.DBInstance=null,this.initializeDatabase=async function(){return new Promise((p,o)=>{let f=window.indexedDB.open("destiny2-dataverse",2);f.onupgradeneeded=function(e){const i=f.result;T("DB","Old",e.oldVersion,"New",e.newVersion),e.oldVersion<1&&(T("DB","Creating first version of database, since it never existed on this installation."),i.createObjectStore("storage",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key")),e.oldVersion<2&&(T("DB","Creating object store for player/character activity"),i.createObjectStore("playerActivity",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"),i.createObjectStore("activityDetails",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"))},f.onsuccess=function(e){T("DB","Loaded database"),m.DBInstance=e.target.result,p()},f.onerror=function(e){T("DB","Failed to load database"),o(e)}})};async function d(p,o,f){return new Promise((e,i)=>{const P=m.DBInstance.transaction(p,"readwrite").objectStore(p).put({key:o,value:f});P.onsuccess=function(){e()},P.onerror=function(L){i(L)}})}async function I(p,o=null){return new Promise((f,e)=>{const h=m.DBInstance.transaction(p,"readonly").objectStore(p).getAll();h.onsuccess=function(){const P=h.result;f(o?P.filter(o):P)},h.onerror=function(P){e(P)}})}async function a(p,o,f=null){return new Promise((e,i)=>{const P=m.DBInstance.transaction(p,"readonly").objectStore(p).get(o);P.onsuccess=function(L){L.target.result?e(L.target.result.value):e(f)},P.onerror=function(L){i(L)}})}async function n(p,o){return new Promise((f,e)=>{const h=m.DBInstance.transaction(p,"readwrite").objectStore(p).delete(o);h.onsuccess=function(){f()},h.onerror=function(P){e(P)}})}this.setItem=async function(p,o){return await d("storage",p,o)},this.setItems=async function(p){for(let o of p)await d("storage",o.key,o.value)},this.getItem=async function(p,o=null){return await a("storage",p,o)},this.removeItem=async function(p){return await n("storage",p)},this.setStorageItem=async function(p,o,f){return await d(p,o,f)},this.setStorageItems=async function(p,o){for(let f of o)await d(p,f.key,f.value)},this.getStorageItem=async function(p,o,f=null){return await a(p,o,f)},this.getStorageItems=async function(p,o=null){return await I(p,o)},this.removeStorageItem=async function(p,o){return await n(p,o)};var m=this;return this}}class pe{constructor(){g(this,"eventListeners");g(this,"addEventListener");g(this,"emit");return this.eventListeners=[],this.addEventListener=function(d,I){T("EVENT:REGISTERED",d),this.eventListeners.push({eventName:d,handler:I})},this.emit=async function(d,...I){return JSON.parse(await window.db.getItem("d2-debugmode")??"false")?T("EVENT:EMITTING",d,...I):T("EVENT:EMITTING",d),new Promise((n,m)=>{this.eventListeners.filter(p=>p.eventName==d).forEach(async p=>{try{await p.handler(...I)}catch(o){T("EVENT:ERROR",d,o),console.error(o),m(o)}}),n(!0)})},T("EventEmitter","Initialized"),this}}var x=(u=>(u[u.None=0]="None",u[u.Locked=1]="Locked",u[u.Tracked=2]="Tracked",u[u.Masterwork=4]="Masterwork",u[u.Crafted=8]="Crafted",u[u.HighlightedObjective=16]="HighlightedObjective",u))(x||{});class ye{constructor(d){g(this,"getSeasonRankData");g(this,"replaceStringVariables");g(this,"getMilestoneData");g(this,"getBounties");g(this,"getQuests");g(this,"getCharacterRecords");g(this,"destinyApiClient");this.destinyApiClient=d,this.getSeasonRankData=function(n,m,p){let o=n.characterProgression.progressions[p.rewardProgressionHash],f=n.characterProgression.progressions[p.prestigeProgressionHash],e=this.destinyApiClient.destinyDataDefinition.DestinyInventoryItemDefinition[m.artifactItemHash],i=o.level,r=o.nextLevelAt,h=o.progressToNextLevel;return o.level==o.levelCap&&(i+=f.level,r+=f.nextLevelAt,h+=f.progressToNextLevel),{name:`Season Rank ${i}`,description:m.displayProperties.name,icon:`${e.displayProperties.icon}`,startDate:m.startDate,endDate:m.endDate,nextLevelAt:r,progressToNextLevel:h,type:"seasonrank",order:-1,inProgressValueStyle:0,completedValueStyle:0}},this.replaceStringVariables=function(n,m){if(!n||n.indexOf("{var:")===-1)return n;var p=/{var:(\d+)}/g,o=n.match(p);let f=n;if(o)for(var e=0;e<o.length;e++){var i=o[e],r=i.match(/\d+/);if(r){var h=r[0],P=m[h];P&&(f=f.replace(i,P))}}return f},this.getMilestoneData=function(n){let m=[],p=Object.keys(n.characterProgression.milestones);for(let o of p){let f=n.characterProgression.milestones[o],e={name:this.replaceStringVariables(f.milestoneName,n.profileStringVariables.integerValuesByHash),description:this.replaceStringVariables(f.milestoneDescription,n.profileStringVariables.integerValuesByHash),order:f.order,icon:f.milestoneIcon,type:"milestone",inProgressValueStyle:0,completedValueStyle:0};if(f.startDate&&(e.startDate=f.startDate),f.endDate&&(e.endDate=f.endDate),f.availableQuests&&f.availableQuests.length>0){for(let i of f.availableQuests)if(i.tracked&&(e.tracked=!0),i.status.started&&!i.status.completed&&i.status.stepObjectives&&i.status.stepObjectives.length>0){for(let r of i.status.stepObjectives)if(!r.complete){typeof r.progress<"u"&&(e.progressToNextLevel=r.progress),typeof r.completionValue<"u"&&(e.nextLevelAt=r.completionValue),typeof r.objectiveInProgressValueStyle<"u"&&(e.inProgressValueStyle=r.objectiveInProgressValueStyle),typeof r.objectiveCompletedValueStyle<"u"&&(e.completedValueStyle=r.objectiveCompletedValueStyle),(e.icon??"").length==0&&typeof r.activityIcon<"u"&&(e.icon=r.activityIcon);break}}}if(f.activities&&f.activities.length>0)for(let i of f.activities){if(i.challenges&&i.challenges.length>0){for(let r of i.challenges)if(!r.objective.complete){typeof r.objective.progress<"u"&&(e.progressToNextLevel=r.objective.progress),typeof r.objectiveInProgressValueStyle<"u"&&(e.inProgressValueStyle=r.objectiveInProgressValueStyle),typeof r.objectiveCompletedValueStyle<"u"&&(e.completedValueStyle=r.objectiveCompletedValueStyle),typeof r.objective.completionValue<"u"&&(e.nextLevelAt=r.objective.completionValue);break}}break}m.push(e)}return m};const I=26;this.getBounties=function(n){let m=[];var p=n.characterInventory.filter(o=>o.inventoryitemItemType===I);for(let o of p){let e=n.itemComponents.objectives.data[o.itemInstanceId].objectives.filter(i=>!i.complete);if(e.length!==0)for(let i of e){let r={name:this.replaceStringVariables(o.inventoryitemName,n.profileStringVariables.integerValuesByHash),description:this.replaceStringVariables(o.inventoryitemDescription,n.profileStringVariables.integerValuesByHash),order:500,icon:o.inventoryitemIcon,type:"bounty",inProgressValueStyle:0,completedValueStyle:0,tracked:(o.state&x.Tracked)==x.Tracked,state:o.state};typeof o.expirationDate<"u"&&(r.endDate=o.expirationDate,new Date(o.expirationDate).getTime()<new Date().getTime())||typeof i.completionValue<"u"&&(r.nextLevelAt=i.completionValue,typeof i.objectiveInProgressValueStyle<"u"&&(r.inProgressValueStyle=i.objectiveInProgressValueStyle),typeof i.objectiveCompletedValueStyle<"u"&&(r.completedValueStyle=i.objectiveCompletedValueStyle),typeof i.progress<"u"&&(r.progressToNextLevel=i.progress),typeof i.objectiveProgressDescription<"u"&&(r.description=this.replaceStringVariables(i.objectiveProgressDescription,n.profileStringVariables.integerValuesByHash)),m.push(r))}}return m};const a=1345459588;return this.getQuests=function(n){let m=[];var p=n.characterInventory.filter(e=>e.bucketHash===a&&[I].filter(i=>i!=e.inventoryitemItemType).length>0);let o=p.filter(e=>typeof e.itemInstanceId<"u"),f=p.filter(e=>typeof e.itemInstanceId>"u");for(let e of o){let i=n.itemComponents.objectives.data[e.itemInstanceId];if(i){const r=i.objectives.filter(h=>h.visible&&!h.complete);for(let h of r){let P={name:this.replaceStringVariables(e.inventoryitemName,n.profileStringVariables.integerValuesByHash),description:this.replaceStringVariables(e.inventoryitemDescription,n.profileStringVariables.integerValuesByHash),order:1e3,icon:e.inventoryitemIcon,type:"quest",inProgressValueStyle:0,completedValueStyle:0,tracked:(e.state&x.Tracked)==x.Tracked,state:e.state};typeof h.completionValue<"u"&&(P.nextLevelAt=h.completionValue,typeof h.objectiveInProgressValueStyle<"u"&&(P.inProgressValueStyle=h.objectiveInProgressValueStyle),typeof h.objectiveCompletedValueStyle<"u"&&(P.completedValueStyle=h.objectiveCompletedValueStyle),typeof h.progress<"u"&&(P.progressToNextLevel=h.progress),typeof h.objectiveProgressDescription<"u"&&(P.description=this.replaceStringVariables(h.objectiveProgressDescription,n.profileStringVariables.integerValuesByHash)),m.push(P))}}}for(let e of f){let i=(n.characterProgression.uninstancedItemObjectives[e.itemHash]??[]).filter(r=>r.visible&&!r.complete);for(let r of i){let h={name:this.replaceStringVariables(e.inventoryitemName,n.profileStringVariables.integerValuesByHash),description:this.replaceStringVariables(e.inventoryitemDescription,n.profileStringVariables.integerValuesByHash),order:1e4,icon:e.inventoryitemIcon,type:"quest",inProgressValueStyle:0,completedValueStyle:0,tracked:(e.state&x.Tracked)==x.Tracked,state:e.state};typeof r.completionValue<"u"&&(h.nextLevelAt=r.completionValue,typeof r.objectiveInProgressValueStyle<"u"&&(h.inProgressValueStyle=r.objectiveInProgressValueStyle),typeof r.objectiveCompletedValueStyle<"u"&&(h.completedValueStyle=r.objectiveCompletedValueStyle),typeof r.progress<"u"&&(h.progressToNextLevel=r.progress),typeof r.objectiveProgressDescription<"u"&&(h.description=this.replaceStringVariables(r.objectiveProgressDescription,n.profileStringVariables.integerValuesByHash)),m.push(h))}}return m},this.getCharacterRecords=function(n){let m=[],p=Object.keys(n.characterRecords.records);for(let o of p){let f=n.characterRecords.records[o];if(typeof f.objectives>"u"||(f.recordName??"").length===0)continue;let e=f.objectives.filter(i=>i.visible&&!i.complete);for(let i of e){let r={name:f.recordName,type:"characterRecord",order:100,icon:f.recordIcon,description:`${i.objectiveProgressDescription??""}`,progressToNextLevel:i.progress,nextLevelAt:i.completionValue,inProgressValueStyle:i.objectiveInProgressValueStyle,completedValueStyle:i.objectiveCompletedValueStyle,state:f.state};m.push(r)}}return m},this}}class me{constructor(d,I){g(this,"checkIfAuthenticated");g(this,"getToken");g(this,"refreshToken");g(this,"checkManifestVersion");g(this,"checkStoredDefinitions");g(this,"loadDestinyContentData");g(this,"loadDataFromStorage");g(this,"getManifest");g(this,"loadCommonSettings");g(this,"getUserToken");g(this,"getLinkedProfiles");g(this,"getUserProfile");g(this,"getLastPlayedCharacter");g(this,"getNamedDataObject");g(this,"getPresentationNodeFromHash");g(this,"mapHashesToDefinitionsInObject");g(this,"getTrackableData");g(this,"checkDestinyStatus");g(this,"apiToken");g(this,"applicationName");g(this,"cachedManifest");g(this,"destinyDataDefinition");g(this,"lastVersion");g(this,"profile");g(this,"linkedProfiles");g(this,"trackedGoals");g(this,"goalApi");i("Initializing");const a=window.db,n=window.eventEmitter,m="https://o2g.itssimple.se",p="https://www.bungie.net",o="https://www.bungie.net/Platform",f=["DestinyActivityTypeDefinition","DestinyActivityDefinition","DestinyArtifactDefinition","DestinyChecklistDefinition","DestinyClassDefinition","DestinyDestinationDefinition","DestinyDamageTypeDefinition","DestinyFactionDefinition","DestinyGenderDefinition","DestinyItemCategoryDefinition","DestinyItemTierTypeDefinition","DestinyInventoryBucketDefinition","DestinyInventoryItemDefinition","DestinyMedalTierDefinition","DestinyMetricDefinition","DestinyMilestoneDefinition","DestinyObjectiveDefinition","DestinyPlaceDefinition","DestinyPresentationNodeDefinition","DestinyProgressionDefinition","DestinyRaceDefinition","DestinyRecordDefinition","DestinySeasonDefinition","DestinySeasonPassDefinition","DestinyStatDefinition","DestinyTraitDefinition"],e={None:0,Profiles:100,VendorReceipts:101,ProfileInventories:102,ProfileCurrencies:103,ProfileProgression:104,PlatformSilver:105,Characters:200,CharacterInventories:201,CharacterProgressions:202,CharacterRenderData:203,CharacterActivities:204,CharacterEquipment:205,CharacterLoadouts:206,ItemInstances:300,ItemObjectives:301,ItemPerks:302,ItemRenderData:303,ItemStats:304,ItemSockets:305,ItemTalentGrids:306,ItemCommonData:307,ItemPlugStates:308,ItemPlugObjectives:309,ItemReusablePlugs:310,Vendors:400,VendorCategories:401,VendorSales:402,Kiosks:500,CurrencyLookups:600,PresentationNodes:700,Collectibles:800,Records:900,Transitory:1e3,Metrics:1100,StringVariables:1200,Craftables:1300,SocialCommendations:1400};this.lastVersion=null,this.applicationName=I,this.apiToken=d,this.destinyDataDefinition={},this.trackedGoals=[];function i(...l){T("D2API",l)}async function r(l,t,s=null,D=null){let c={};return(s!==null||D!==null)&&(c["Content-Type"]="application/json",c["x-api-key"]=y.apiToken,D!==null&&(c.authorization=`Bearer ${D}`)),s!==null?await fetch(t,{method:l,headers:c,body:s}):await fetch(t,{method:l,headers:c})}async function h(){await a.getItem("destinyTokenExpires")<Date.now()&&(i("Token expired, refreshing"),await y.refreshToken())}function P(l){if(l.error)return i("Error handling token",JSON.stringify(l)),a.removeItem("destinyToken"),a.removeItem("destinyRefreshToken"),a.removeItem("destinyTokenExpires"),a.removeItem("destinyRefreshTokenExpires"),a.removeItem("destinyBungieMembershipId"),!1;a.setItem("destinyToken",l.access_token),a.setItem("destinyRefreshToken",l.refresh_token);let t=Date.now()+l.expires_in*1e3;a.setItem("destinyTokenExpires",t);let s=Date.now()+l.refresh_expires_in*1e3;return a.setItem("destinyRefreshTokenExpires",s),a.setItem("destinyBungieMembershipId",l.membership_id),!0}this.loadDataFromStorage=async()=>{i("Loading data from storage");let l=await a.getItem("manifest");l!==null&&(y.cachedManifest=JSON.parse(l));let t=await a.getItem("manifestVersion");t!==null&&(y.lastVersion=t),y.checkStoredDefinitions();for(let c of f){let v=await a.getItem(`destinyContent-${c}`);v!==null&&(y.destinyDataDefinition[c]=JSON.parse(v))}let s=await a.getItem("destiny-profile");s!==null&&(y.profile=JSON.parse(s));let D=await a.getItem("destiny-linkedProfiles");D!==null&&(y.linkedProfiles=JSON.parse(D)),i("Data loaded from storage"),n.emit("destiny-data-loaded")},this.checkIfAuthenticated=async()=>{try{await h();const l=await a.getItem("destinyToken")!==null;return n.emit("destiny2:authenticated",l),l}catch(l){return i("Error checking if authenticated",l),n.emit("destiny2:authenticated",!1),!1}},this.getToken=async(l,t)=>{const s=await r("POST",`${m}/token/${y.applicationName}`,JSON.stringify({code:t}));if(s.status===200){let D=await s.json();return P(D)?n.emit("destiny2:auth-success"):n.emit("destiny2:auth-failed"),D}i("Error getting token",s.status,s.statusText,await s.text()),n.emit("destiny2:auth-failed")},this.refreshToken=async()=>{const l=await a.getItem("destinyRefreshToken");if(l==null)return n.emit("destiny2:refreshToken",null),null;const t=await r("POST",`${m}/refresh/${y.applicationName}`,JSON.stringify({refresh_token:l}));if(t.status===200){let s=await t.json();P(s)?n.emit("destiny2:refresh-success"):n.emit("destiny2:refresh-failed");return}else n.emit("destiny2:refresh-failed")},this.checkManifestVersion=async()=>(i("Checking manifest version"),new Promise(async function(l,t){let s=await y.getManifest();if(s==null)return i("Failed to fetch API"),null;let D=await a.getItem("manifestVersion")??"null";if(s.Response.version!==D){await a.removeItem("lastManifestUpdate"),await a.removeItem("manifest"),await a.removeItem("manifestVersion");for(let c of f)await a.removeItem(`destinyContent-${c}`);y.cachedManifest=s.Response,await a.setItem("manifestVersion",s.Response.version),await a.setItem("manifest",JSON.stringify(y.cachedManifest)),await a.setItem("lastManifestUpdate",Date.now()),l({updatedManifest:!0,version:y.lastVersion}),i("Manifest updated");return}y.cachedManifest=s.Response,l({updatedManifest:!1,version:y.lastVersion}),i("Manifest version is up to date")})),this.checkStoredDefinitions=async function(l=!0){let t=[];for(let s of f)await a.getItem(`destinyContent-${s}`)===null&&t.push(s);if(t.length>0&&l){for(let s of t)await a.removeItem(`destinyContent-${s}`);await y.loadDestinyContentData(t)}return t},this.loadDestinyContentData=async function(l=[]){for(let t of l){let s=!1,D=0,c=null;for(;!s&&D<5;)try{await L(t),s=!0}catch(v){if(c=v,await a.removeItem(`destinyContent-${t}`),D++,D<5){const w=250*Math.pow(2,D-1);await new Promise(V=>setTimeout(V,w))}}s||n.emit("loading-error",{dataType:t,error:c,message:`Failed to load ${t} after 5 attempts.`})}};async function L(l){let t=y.cachedManifest;const s=l.replace("Destiny","").split(/(?=[A-Z])/).join(" ");n.emit("loading-text",`Loading ${s}`);const D=await r("GET",`${p}${t.jsonWorldComponentContentPaths.en[l]}`);D.headers.get("content-length");let c=0;const v=new Response(new ReadableStream({async start(V){const N=D.body.getReader();let k=0;for(;;){var j=await N.read();if(j.done)break;c+=j.value.byteLength,k++,k%30===0&&n.emit("loading-text",`Loading ${s} (${new Intl.NumberFormat("sv-SE").format(Math.round(c/1024/1024*100+Number.EPSILON)/100)} MB)`),V.enqueue(j.value)}n.emit("loading-text",`Loading ${s} (${new Intl.NumberFormat("sv-SE").format(Math.round(c/1024/1024*100+Number.EPSILON)/100)} MB)`),V.close()}}));if(D.status!==200){T("Manifest download error",await v.json());return}const w=await v.json();y.destinyDataDefinition[l]=w,a.setItem(`destinyContent-${l}`,JSON.stringify(w))}this.getManifest=async function(){let l=await a.getItem("lastManifestUpdate");if(i("Checking if manifest is cached"),l!==null&&Date.now()-l<6e4*60){let s=await a.getItem("manifest");if(s!==null)return i("Manifest is cached"),{Response:JSON.parse(s)}}let t=await r("GET",`${o}/Destiny2/Manifest/`);if(t.status===200){let s=await t.json();return s.ErrorStatus=="Success"?(a.setItem("lastManifestUpdate",Date.now()),a.setItem("manifest",JSON.stringify(s.Response)),i("Manifest updated from API"),{Response:s.Response}):(i("Manifesterror"),i(s.Response),null)}else{let s=t.json();return i("Error when fetching Manifest"),i(s),null}},this.loadCommonSettings=async function(){await h();const l=await r("GET",`${o}/Settings`,null,await this.getUserToken());return l.status===200?await l.json():(i("Error fetching common settings",l.status,l.statusText),null)},this.getUserToken=async function(){return await a.getItem("destinyToken")},this.getLinkedProfiles=async function(l=!1){return l&&(y.linkedProfiles=null),y.linkedProfiles!=null?y.linkedProfiles:(await h(),new Promise(async(t,s)=>{var D=await a.getItem("destinyBungieMembershipId");let c=await r("GET",`${o}/Destiny2/-1/Profile/${D}/LinkedProfiles/`,null,await this.getUserToken());if(c.status===200){let v=await c.json();a.setItem("destiny-linkedProfiles",JSON.stringify(v.Response)),y.linkedProfiles=v.Response,t(v.Response)}else y.refreshToken(),s(c)}))},this.getUserProfile=async function(l,t){let s=[e.Profiles,e.ProfileInventories,e.ProfileCurrencies,e.ProfileProgression,e.Characters,e.CharacterInventories,e.CharacterProgressions,e.CharacterActivities,e.CharacterEquipment,e.ItemInstances,e.ItemObjectives,e.ItemSockets,e.ItemTalentGrids,e.ItemCommonData,e.ItemPlugStates,e.ItemPlugObjectives,e.ItemReusablePlugs,e.Metrics,e.Records,e.Collectibles,e.StringVariables];return await h(),new Promise(async(D,c)=>{let v=await r("GET",`${o}/Destiny2/${t}/Profile/${l}/?components=${s.join(",")}`,null,await this.getUserToken());if(v.status===200){let w=await v.json();typeof y.profile>"u"||new Date(y.profile.responseMintedTimestamp).getTime()<new Date(w.Response.responseMintedTimestamp).getTime()?(a.setItem("destiny-profile",JSON.stringify(w.Response)),y.profile=w.Response,D(w.Response)):D(y.profile)}else y.refreshToken(),c(v)})},this.getLastPlayedCharacter=async function(l=!1){await h();let t=y.profile;if(typeof t<"u"&&(new Date().getTime()-new Date(t.responseMintedTimestamp).getTime())/1e3>60&&(l=!0),l&&(t=null),y.linkedProfiles===null)return null;if(await y.getLinkedProfiles(l),y.linkedProfiles!==null&&y.linkedProfiles.profiles!==null&&y.linkedProfiles.profiles.length>0){var s=y.linkedProfiles.profiles.sort((w,V)=>w.dateLastPlayed>V.dateLastPlayed?-1:1)[0];t=await y.getUserProfile(s.membershipId,s.membershipType)}let D=[];for(let w of t.profile.data.characterIds)D.push(t.characters.data[w]);let c=D.sort((w,V)=>w.dateLastPlayed>V.dateLastPlayed?-1:1)[0];return{characterInfo:c,characterProgression:t.characterProgressions.disabled?{}:t.characterProgressions.data[c.characterId],characterActivities:t.characterActivities.disabled?{}:t.characterActivities.data[c.characterId],characterUninstancedItemComponents:t.characterUninstancedItemComponents[c.characterId].objectives.data,characterInventory:t.characterInventories.data[c.characterId].items,characterEquipment:t.characterEquipment.data[c.characterId].items,characterPlugSets:t.characterPlugSets.disabled?{}:t.characterPlugSets.data[c.characterId].plugs,characterCollectibles:t.characterCollectibles.data[c.characterId].collectibles,characterRecords:t.characterRecords.data[c.characterId],characterStringVariables:t.characterStringVariables.data[c.characterId],profileProgression:t.profileProgression.data,metrics:t.metrics.data.metrics,itemComponents:t.itemComponents,records:t.profileRecords.data,profileInventory:t.profileInventory.data.items,profileCurrency:t.profileCurrencies.data.items,profilePlugSets:t.profilePlugSets.disabled?{}:t.profilePlugSets.data.plugs,profileCollectibles:t.profileCollectibles.data,profile:t.profile.data,profileStringVariables:t.profileStringVariables.data}},this.getNamedDataObject=async function(l=!1){let t=await y.getLastPlayedCharacter(l);if(t==null)return null;let s={...t};for(let c of Object.keys(s.characterInfo.stats))s.characterInfo.stats[c]={statValue:s.characterInfo.stats[c],statHash:c};for(let c of Object.keys(s.metrics))s.metrics[c]={...s.metrics[c],metricHash:c};for(let c of Object.keys(s.records.records))s.records.records[c]={...s.records.records[c],recordHash:c,parentNodeHashes:y.destinyDataDefinition.DestinyRecordDefinition[c].parentNodeHashes};for(let c of Object.keys(s.characterRecords.records))s.characterRecords.records[c]={...s.characterRecords.records[c],recordHash:c,parentNodeHashes:y.destinyDataDefinition.DestinyRecordDefinition[c].parentNodeHashes};return s=y.mapHashesToDefinitionsInObject(s),await a.getItem("destiny2-use-cachebreaker",!1)&&t.characterInventory.filter(v=>v.lockable&&v.inventoryitemItemType==3).length>0,n.emit("destiny2-api-update",s),s},this.getPresentationNodeFromHash=function(l){const t=[],s=y.destinyDataDefinition.DestinyPresentationNodeDefinition[l];if(s&&(t.unshift({name:s.displayProperties.name,description:s.displayProperties.description,icon:s.displayProperties.icon,hash:l}),s.parentNodeHashes))for(let D of s.parentNodeHashes){const c=y.getPresentationNodeFromHash(D);for(let v of c)t.push(v)}return t},this.mapHashesToDefinitionsInObject=function(l){let t={...l},s=Object.keys(t);for(let D of s){let c=typeof t[D],v=t[D];if(Array.isArray(v)){for(let w=0;w<v.length;w++){let V=v[w];typeof V=="object"?v[w]=y.mapHashesToDefinitionsInObject(V):v[w]=V}t[D]=v}else if(c==="object"&&v!==null)t[D]=y.mapHashesToDefinitionsInObject(t[D]);else{if(D.indexOf("Hash")>-1&&!Array.isArray(v)){let w=D.split("Hash")[0].replace("current","").toLowerCase();switch(w){case"item":case"plugitem":w="inventoryitem";break}let V=f.find(k=>k.toLowerCase()==`Destiny${w}Definition`.toLowerCase()),N=y.destinyDataDefinition[V];if(N&&N[v]&&N[v].displayProperties){const k=N[v];k.displayProperties.name&&k.displayProperties.name.length>0?t[`${w}Name`]=k.displayProperties.name:k.setData&&k.setData.questLineName&&k.setData.questLineName.length>0&&(t[`${w}Name`]=k.setData.questLineName),k.displayProperties.description&&k.displayProperties.description.length>0&&(t[`${w}Description`]=k.displayProperties.description),k.displayProperties.icon&&k.displayProperties.icon.length>0&&(t[`${w}Icon`]=k.displayProperties.icon),k.progressDescription&&k.progressDescription.length>0&&(t[`${w}ProgressDescription`]=k.progressDescription),typeof k.inProgressValueStyle<"u"&&(t[`${w}InProgressValueStyle`]=k.inProgressValueStyle),typeof k.completedValueStyle<"u"&&(t[`${w}CompletedValueStyle`]=k.completedValueStyle),typeof k.itemType<"u"&&(t[`${w}ItemType`]=k.itemType),typeof k.parentNodeHashes<"u"&&(t.parentNodeHashes=k.parentNodeHashes.map(j=>y.getPresentationNodeFromHash(j)))}}t[D]=v}}return t},this.getTrackableData=async function(l=!1){let t=await y.getNamedDataObject(l);if(t==null)return null;let s=y.destinyDataDefinition.DestinySeasonDefinition[t.profile.currentSeasonHash],D=s.seasonPassList.find(S=>new Date<new Date(Date.parse(S.seasonPassEndDate))&&new Date>=new Date(Date.parse(S.seasonPassStartDate))),c=y.destinyDataDefinition.DestinySeasonPassDefinition[D.seasonPassHash],v=[],w=y.goalApi.getMilestoneData(t);for(let S of w)v.push(S);let V=y.goalApi.getBounties(t);for(let S of V)v.push(S);let N=y.goalApi.getQuests(t);for(let S of N)v.push(S);let k=y.goalApi.getCharacterRecords(t);for(let S of k)v.push(S);function j(S,A){if(typeof S.nextLevelAt<"u"&&typeof A.nextLevelAt<"u"){let q=S.progressToNextLevel/S.nextLevelAt*100,_=A.progressToNextLevel/A.nextLevelAt*100;return q<_?1:-1}return typeof S.endDate<"u"?typeof A.endDate>"u"||S.endDate<A.endDate?-1:1:S.order<A.order?1:-1}const H=v.filter(S=>S.tracked).sort(j),$=v.filter(S=>S.endDate&&!S.tracked).sort(j),B=v.filter(S=>!S.endDate&&!S.tracked).sort(j);return v=[...H,...$,...B],v.unshift(y.goalApi.getSeasonRankData(t,s,c)),y.trackedGoals=v,n.emit("goal-list-update",v),v},this.checkDestinyStatus=async function(){i("Checking Destiny status");const t=await(await r("GET",`${o}/Settings/`)).json(),s=["D2Manifest","DestinyLinkedProfiles","Destiny2"],D={};for(let c of s)t.Response.systems[c]&&(D[c]=t.Response.systems[c]);return{destiny2CoreSettings:t.Response.destiny2CoreSettings,systems:{Destiny2:D.Destiny2,D2Manifest:D.D2Manifest,DestinyLinkedProfiles:D.DestinyLinkedProfiles}}};let y=this;return this.goalApi=new ye(this),i("Initialized"),this}}T("MAIN","Starting app...");window.eventEmitter=new pe;window.db=new ue;window.apiClient=new me("5625a52ed6b54ecfb8246071cfcd6085","everversedata");function he(){const u=E(!1),d=E(!1),I=E([]);return{isDataLoaded:u,isAuthenticated:d,goals:I}}const O=he();window.appState=W(O);window.db.initializeDatabase().then(async()=>{T("MAIN","Database initialized, checking for updates..."),O.isAuthenticated.value=await window.apiClient.checkIfAuthenticated(),Y(b(fe,{}),document.getElementById("app"))});
//# sourceMappingURL=index-a11af9cc.js.map
