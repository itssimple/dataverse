var b=Object.defineProperty;var v=(l,i,g)=>i in l?b(l,i,{enumerable:!0,configurable:!0,writable:!0,value:g}):l[i]=g;var c=(l,i,g)=>(v(l,typeof i!="symbol"?i+"":i,g),g);import{o as d,_ as I,R as E,D as M,c as A,B as C}from"./vendor-d09b161a.js";(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const u of r)if(u.type==="childList")for(const e of u.addedNodes)e.tagName==="LINK"&&e.rel==="modulepreload"&&t(e)}).observe(document,{childList:!0,subtree:!0});function g(r){const u={};return r.integrity&&(u.integrity=r.integrity),r.referrerPolicy&&(u.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?u.credentials="include":r.crossOrigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function t(r){if(r.ep)return;r.ep=!0;const u=g(r);fetch(r.href,u)}})();function m(l,...i){console.log(`[${l}]`,JSON.stringify([...i]))}function P(l){return l.authenticated?(location.href="/#/logging-in",d(I,{})):d(I,{children:["Main page -"," ",d("a",{href:"https://o2g.itssimple.se/authenticate/everversedata?state=dataverse-"+new Date().getTime(),children:"Log in"})]})}function j(){const l=window.apiClient,i=E();m("Auth","Authenticated page, getting code",i);const t=new URL(i,location.origin).searchParams.get("code");return m("Auth","Code",t),t?(l.getToken("",t).then(()=>{m("Auth","Got token, redirecting to dashboard"),location.href="/#/logging-in"}).catch(r=>{m("Auth","Failed to get token, redirecting to main page"),location.href="/"}),d(I,{children:"Authenticated, redirecting to Dashboard"})):(m("Auth","No code found, redirecting to main page"),location.href="/",d(I,{children:"Redirecting to main page"}))}function R(){return window.apiClient.checkIfAuthenticated().then(i=>{i||(location.href="/")}),d(I,{children:"Blep"})}function x(){return d("footer",{className:"fui body fiction",children:["Â© 2023",new Date().getUTCFullYear()!=2023?" - "+new Date().getUTCFullYear():null," ","NoLifeKing85#2914"]})}function N(){const l=window.apiClient;return l.checkIfAuthenticated().then(async i=>{if(!i){location.href="/";return}m("LOGIN","Authenticated, checking manifests"),await l.checkManifestVersion()}),d(I,{children:"Logging in and checking manifests"})}function O(l){return d(I,{children:[d("header",{className:"header subscreen",children:"Dataverse"}),d("div",{class:"app",children:d(M,{history:A(),children:[d(I,{path:"/",children:d(P,{...l})}),d(I,{path:"/authenticated",children:d(j,{})}),d(I,{path:"/logging-in",children:d(N,{})}),d(I,{path:"/dashboard",children:d(R,{})})]})}),d(x,{})]})}class B{constructor(){c(this,"DBInstance");c(this,"initializeDatabase");c(this,"setItem");c(this,"setItems");c(this,"getItem");c(this,"removeItem");c(this,"setStorageItem");c(this,"setStorageItems");c(this,"getStorageItem");c(this,"getStorageItems");c(this,"removeStorageItem");this.DBInstance=null,this.initializeDatabase=async function(){return new Promise((e,o)=>{let f=window.indexedDB.open("destiny2-dataverse",2);f.onupgradeneeded=function(s){const p=f.result;m("DB","Old",s.oldVersion,"New",s.newVersion),s.oldVersion<1&&(m("DB","Creating first version of database, since it never existed on this installation."),p.createObjectStore("storage",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key")),s.oldVersion<2&&(m("DB","Creating object store for player/character activity"),p.createObjectStore("playerActivity",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"),p.createObjectStore("activityDetails",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"))},f.onsuccess=function(s){m("DB","Loaded database"),u.DBInstance=s.target.result,e()},f.onerror=function(s){m("DB","Failed to load database"),o(s)}})};async function i(e,o,f){return new Promise((s,p)=>{const D=u.DBInstance.transaction(e,"readwrite").objectStore(e).put({key:o,value:f});D.onsuccess=function(){s()},D.onerror=function(y){p(y)}})}async function g(e,o=null){return new Promise((f,s)=>{const w=u.DBInstance.transaction(e,"readonly").objectStore(e).getAll();w.onsuccess=function(){const D=w.result;f(o?D.filter(o):D)},w.onerror=function(D){s(D)}})}async function t(e,o,f=null){return new Promise((s,p)=>{const D=u.DBInstance.transaction(e,"readonly").objectStore(e).get(o);D.onsuccess=function(y){y.target.result?s(y.target.result.value):s(f)},D.onerror=function(y){p(y)}})}async function r(e,o){return new Promise((f,s)=>{const w=u.DBInstance.transaction(e,"readwrite").objectStore(e).delete(o);w.onsuccess=function(){f()},w.onerror=function(D){s(D)}})}this.setItem=async function(e,o){return await i("storage",e,o)},this.setItems=async function(e){for(let o of e)await i("storage",o.key,o.value)},this.getItem=async function(e,o=null){return await t("storage",e,o)},this.removeItem=async function(e){return await r("storage",e)},this.setStorageItem=async function(e,o,f){return await i(e,o,f)},this.setStorageItems=async function(e,o){for(let f of o)await i(e,f.key,f.value)},this.getStorageItem=async function(e,o,f=null){return await t(e,o,f)},this.getStorageItems=async function(e,o=null){return await g(e,o)},this.removeStorageItem=async function(e,o){return await r(e,o)};var u=this;return this}}class V{constructor(){c(this,"eventListeners");c(this,"addEventListener");c(this,"emit");return this.eventListeners=[],this.addEventListener=function(i,g){m("EVENT:REGISTERED",i),this.eventListeners.push({eventName:i,handler:g})},this.emit=async function(i,...g){return JSON.parse(await window.db.getItem("d2-debugmode")??"false")?m("EVENT:EMITTING",i,...g):m("EVENT:EMITTING",i),new Promise((r,u)=>{this.eventListeners.filter(e=>e.eventName==i).forEach(async e=>{try{await e.handler(...g)}catch(o){m("EVENT:ERROR",i,o),console.error(o),u(o)}}),r(!0)})},m("EventEmitter","Initialized"),this}}class L{constructor(i,g){c(this,"checkIfAuthenticated");c(this,"getToken");c(this,"refreshToken");c(this,"checkManifestVersion");c(this,"checkStoredDefinitions");c(this,"loadDestinyContentData");c(this,"apiToken");c(this,"applicationName");c(this,"cachedManifest");c(this,"destinyDataDefinition");c(this,"lastVersion");c(this,"getManifest");s("Initializing");const t=window.db,r=window.eventEmitter,u="https://o2g.itssimple.se",e="https://www.bungie.net",o="https://www.bungie.net/Platform",f=["DestinyActivityTypeDefinition","DestinyActivityDefinition","DestinyArtifactDefinition","DestinyChecklistDefinition","DestinyClassDefinition","DestinyDestinationDefinition","DestinyDamageTypeDefinition","DestinyFactionDefinition","DestinyGenderDefinition","DestinyItemCategoryDefinition","DestinyItemTierTypeDefinition","DestinyInventoryBucketDefinition","DestinyInventoryItemDefinition","DestinyMedalTierDefinition","DestinyMetricDefinition","DestinyMilestoneDefinition","DestinyObjectiveDefinition","DestinyPlaceDefinition","DestinyPresentationNodeDefinition","DestinyProgressionDefinition","DestinyRaceDefinition","DestinyRecordDefinition","DestinySeasonDefinition","DestinySeasonPassDefinition","DestinyStatDefinition","DestinyTraitDefinition"];this.lastVersion=null,this.applicationName=g,this.apiToken=i,this.destinyDataDefinition={};function s(...n){m("D2API",n)}async function p(n,h,a=null,k=null){let S={};return a!==null&&(S["Content-Type"]="application/json",S["x-api-key"]=y.apiToken,k!==null&&(S.authorization=`Bearer ${k}`)),a!==null?await fetch(h,{method:n,headers:S,body:a}):await fetch(h,{method:n,headers:S})}async function T(){await t.getItem("destinyTokenExpires")<Date.now()&&(s("Token expired, refreshing"),await y.refreshToken())}function w(n){if(n.error)return s("Error handling token",JSON.stringify(n)),t.removeItem("destinyToken"),t.removeItem("destinyRefreshToken"),t.removeItem("destinyTokenExpires"),t.removeItem("destinyRefreshTokenExpires"),t.removeItem("destinyBungieMembershipId"),!1;t.setItem("destinyToken",n.access_token),t.setItem("destinyRefreshToken",n.refresh_token);let h=Date.now()+n.expires_in*1e3;t.setItem("destinyTokenExpires",h);let a=Date.now()+n.refresh_expires_in*1e3;return t.setItem("destinyRefreshTokenExpires",a),t.setItem("destinyBungieMembershipId",n.membership_id),!0}this.checkIfAuthenticated=async()=>{try{await T();const n=await t.getItem("destinyToken")!==null;return r.emit("destiny2:authenticated",n),n}catch(n){return s("Error checking if authenticated",n),r.emit("destiny2:authenticated",!1),!1}},this.getToken=async(n,h)=>{const a=await p("POST",`${u}/token/${y.applicationName}`,JSON.stringify({code:h}));if(a.status===200){let k=await a.json();return w(k)?r.emit("destiny2:auth-success"):r.emit("destiny2:auth-failed"),k}s("Error getting token",a.status,a.statusText,await a.text()),r.emit("destiny2:auth-failed")},this.refreshToken=async()=>{const n=await t.getItem("destinyRefreshToken");if(n==null)return r.emit("destiny2:refreshToken",null),null;const h=await p("POST",`${u}/refresh/${y.applicationName}`,JSON.stringify({refresh_token:n}));if(h.status===200){let a=await h.json();w(a)?r.emit("destiny2:refresh-success"):r.emit("destiny2:refresh-failed");return}else r.emit("destiny2:refresh-failed")},this.checkManifestVersion=async()=>(s("Checking manifest version"),new Promise(async function(n,h){let a=await y.getManifest();if(a==null)return s("Failed to fetch API"),null;let k=await t.getItem("manifestVersion")??"null";if(a.Response.version!==k){await t.removeItem("lastManifestUpdate"),await t.removeItem("manifest"),await t.removeItem("manifestVersion");for(let S of f)await t.removeItem(`destinyContent-${S}`);y.cachedManifest=a.Response,await t.setItem("manifestVersion",a.Response.version),await t.setItem("manifest",JSON.stringify(y.cachedManifest)),await t.setItem("lastManifestUpdate",Date.now()),n({updatedManifest:!0,version:y.lastVersion}),s("Manifest updated");return}y.cachedManifest=a.Response,n({updatedManifest:!1,version:y.lastVersion}),s("Manifest version is up to date")})),this.checkStoredDefinitions=async function(n=!0){let h=[];for(let a of f)await t.getItem(`destinyContent-${a}`)===null&&h.push(a);if(h.length>0&&n){for(let a of h)await t.removeItem(`destinyContent-${a}`);await y.loadDestinyContentData()}return h},this.loadDestinyContentData=async function(){for(let n of f)await D(n)};async function D(n){let h=y.cachedManifest;r.emit("loading-text",`Loading ${n.replace("Destiny","")}`);const a=await p("GET",`${e}${h.jsonWorldComponentContentPaths.en[n]}`);if(a.status!==200){m("Manifest download error",await a.json());return}const k=await a.json();y.destinyDataDefinition[n]=k,t.setItem(`destinyContent-${n}`,JSON.stringify(k))}this.getManifest=async function(){let n=await t.getItem("lastManifestUpdate");if(s("Checking if manifest is cached"),n!==null&&Date.now()-n<6e4*60&&await t.getItem("manifest")!==null)return s("Manifest is cached"),{Response:JSON.parse(await t.getItem("manifest"))};let h=await p("GET",`${o}/Destiny2/Manifest/`);if(h.status===200){let a=await h.json();return a.ErrorStatus=="Success"?(t.setItem("lastManifestUpdate",Date.now()),t.setItem("manifest",JSON.stringify(a.Response)),s("Manifest updated from API"),{Response:a.Response}):(s("Manifesterror"),s(a.Response),null)}else{let a=h.json();return s("Error when fetching Manifest"),s(a),null}};let y=this;return s("Initialized"),this}}m("MAIN","Starting app...");window.eventEmitter=new V;window.db=new B;window.apiClient=new L("5625a52ed6b54ecfb8246071cfcd6085","everversedata");window.db.initializeDatabase().then(async()=>{m("MAIN","Database initialized, checking for updates...");const l=await window.apiClient.checkIfAuthenticated();C(d(O,{authenticated:l}),document.getElementById("app"))});
//# sourceMappingURL=index-a40afbb5.js.map
