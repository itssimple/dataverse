var R=Object.defineProperty;var M=(I,o,P)=>o in I?R(I,o,{enumerable:!0,configurable:!0,writable:!0,value:P}):I[o]=P;var d=(I,o,P)=>(M(I,typeof o!="symbol"?o+"":o,P),P);import{o as w,_ as v,R as A,q as V,D as $,c as x,F as _,B,d as j}from"./vendor-c23458f1.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const p of r)if(p.type==="childList")for(const s of p.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function P(r){const p={};return r.integrity&&(p.integrity=r.integrity),r.referrerPolicy&&(p.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?p.credentials="include":r.crossOrigin==="anonymous"?p.credentials="omit":p.credentials="same-origin",p}function i(r){if(r.ep)return;r.ep=!0;const p=P(r);fetch(r.href,p)}})();function k(I,...o){console.log(`[${I}]`,JSON.stringify([...o]))}function H(I){return I.isAuthenticated?(location.href="/#/logging-in",w(v,{})):w(v,{children:["Main page -"," ",w("a",{href:"https://o2g.itssimple.se/authenticate/everversedata?state=dataverse-"+new Date().getTime(),children:"Log in"})]})}function U(){const I=window.apiClient,o=A();k("Auth","Authenticated page, getting code",o);const i=new URL(o,location.origin).searchParams.get("code");return i?(I.getToken("",i).then(()=>{k("Auth","Got token, redirecting to dashboard"),location.href="/#/logging-in"}).catch(r=>{k("Auth","Failed to get token, redirecting to main page"),location.href="/"}),w(v,{children:"Authenticated, redirecting to Dashboard"})):(k("Auth","No code found, redirecting to main page"),location.href="/",w(v,{children:"Redirecting to main page"}))}function F(I){return I.isAuthenticated.value?I.isDataLoaded.value?w(v,{children:"Blep"}):(location.href="/#/logging-in",w(v,{})):(location.href="/",w(v,{}))}function q(){return w("footer",{className:"fui body fiction",children:["Â© 2023",new Date().getUTCFullYear()!=2023?" - "+new Date().getUTCFullYear():null," ","NoLifeKing85#2914"]})}function J(I){const o=window.apiClient,P=window.eventEmitter;P.addEventListener("loading-text",r=>{r&&i(r)});function i(r){let p=document.getElementById("loading-text");p&&(p.innerText=r)}return o.checkIfAuthenticated().then(async r=>{if(!r){location.href="/";return}k("LOGIN","Authenticated, checking manifests"),i("Checking manifest ...");let p=await o.checkManifestVersion();if(p==null){i("Something is wrong with Destiny 2 (or this app), please reload the page.");return}k("LOGIN",p),i("Loading profile data"),await o.getLinkedProfiles(),i("Checking for missing definitions");let s=await o.checkStoredDefinitions(!1);s.length>0&&(i(`Downloading ${s.length} missing definition(s)`),await o.checkStoredDefinitions(!0)),i("Loading data..."),await o.loadDataFromStorage(),i("Loading data... done"),i("Loading character data..."),await o.getLastPlayedCharacter(),I.isDataLoaded.value=!0,setTimeout(()=>{i("Opening application..."),P.emit("manifests-loaded"),setTimeout(()=>{location.href="/#/dashboard"},1e3)},1e3)}),w(v,{children:w("span",{class:"fui body",id:"loading-text",children:"Logging in and loading data ..."})})}function G(){const I=V(window.appState);return w(v,{children:[w("header",{className:"header subscreen",children:"Dataverse"}),w("div",{class:"app",children:w($,{history:x(),children:[w(v,{path:"/",children:w(H,{...I})}),w(v,{path:"/authenticated",children:w(U,{})}),w(v,{path:"/logging-in",children:w(J,{...I})}),w(v,{path:"/dashboard",children:w(F,{...I})})]})}),w(q,{})]})}class K{constructor(){d(this,"DBInstance");d(this,"initializeDatabase");d(this,"setItem");d(this,"setItems");d(this,"getItem");d(this,"removeItem");d(this,"setStorageItem");d(this,"setStorageItems");d(this,"getStorageItem");d(this,"getStorageItems");d(this,"removeStorageItem");this.DBInstance=null,this.initializeDatabase=async function(){return new Promise((s,u)=>{let D=window.indexedDB.open("destiny2-dataverse",2);D.onupgradeneeded=function(l){const h=D.result;k("DB","Old",l.oldVersion,"New",l.newVersion),l.oldVersion<1&&(k("DB","Creating first version of database, since it never existed on this installation."),h.createObjectStore("storage",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key")),l.oldVersion<2&&(k("DB","Creating object store for player/character activity"),h.createObjectStore("playerActivity",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"),h.createObjectStore("activityDetails",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"))},D.onsuccess=function(l){k("DB","Loaded database"),p.DBInstance=l.target.result,s()},D.onerror=function(l){k("DB","Failed to load database"),u(l)}})};async function o(s,u,D){return new Promise((l,h)=>{const S=p.DBInstance.transaction(s,"readwrite").objectStore(s).put({key:u,value:D});S.onsuccess=function(){l()},S.onerror=function(N){h(N)}})}async function P(s,u=null){return new Promise((D,l)=>{const b=p.DBInstance.transaction(s,"readonly").objectStore(s).getAll();b.onsuccess=function(){const S=b.result;D(u?S.filter(u):S)},b.onerror=function(S){l(S)}})}async function i(s,u,D=null){return new Promise((l,h)=>{const S=p.DBInstance.transaction(s,"readonly").objectStore(s).get(u);S.onsuccess=function(N){N.target.result?l(N.target.result.value):l(D)},S.onerror=function(N){h(N)}})}async function r(s,u){return new Promise((D,l)=>{const b=p.DBInstance.transaction(s,"readwrite").objectStore(s).delete(u);b.onsuccess=function(){D()},b.onerror=function(S){l(S)}})}this.setItem=async function(s,u){return await o("storage",s,u)},this.setItems=async function(s){for(let u of s)await o("storage",u.key,u.value)},this.getItem=async function(s,u=null){return await i("storage",s,u)},this.removeItem=async function(s){return await r("storage",s)},this.setStorageItem=async function(s,u,D){return await o(s,u,D)},this.setStorageItems=async function(s,u){for(let D of u)await o(s,D.key,D.value)},this.getStorageItem=async function(s,u,D=null){return await i(s,u,D)},this.getStorageItems=async function(s,u=null){return await P(s,u)},this.removeStorageItem=async function(s,u){return await r(s,u)};var p=this;return this}}class z{constructor(){d(this,"eventListeners");d(this,"addEventListener");d(this,"emit");return this.eventListeners=[],this.addEventListener=function(o,P){k("EVENT:REGISTERED",o),this.eventListeners.push({eventName:o,handler:P})},this.emit=async function(o,...P){return JSON.parse(await window.db.getItem("d2-debugmode")??"false")?k("EVENT:EMITTING",o,...P):k("EVENT:EMITTING",o),new Promise((r,p)=>{this.eventListeners.filter(s=>s.eventName==o).forEach(async s=>{try{await s.handler(...P)}catch(u){k("EVENT:ERROR",o,u),console.error(u),p(u)}}),r(!0)})},k("EventEmitter","Initialized"),this}}class W{constructor(o,P){d(this,"checkIfAuthenticated");d(this,"getToken");d(this,"refreshToken");d(this,"checkManifestVersion");d(this,"checkStoredDefinitions");d(this,"loadDestinyContentData");d(this,"loadDataFromStorage");d(this,"getManifest");d(this,"loadCommonSettings");d(this,"getUserToken");d(this,"getLinkedProfiles");d(this,"getUserProfile");d(this,"getLastPlayedCharacter");d(this,"apiToken");d(this,"applicationName");d(this,"cachedManifest");d(this,"destinyDataDefinition");d(this,"lastVersion");d(this,"profile");d(this,"linkedProfiles");d(this,"getNamedDataObject");d(this,"getPresentationNodeFromHash");d(this,"mapHashesToDefinitionsInObject");h("Initializing");const i=window.db,r=window.eventEmitter,p="https://o2g.itssimple.se",s="https://www.bungie.net",u="https://www.bungie.net/Platform",D=["DestinyActivityTypeDefinition","DestinyActivityDefinition","DestinyArtifactDefinition","DestinyChecklistDefinition","DestinyClassDefinition","DestinyDestinationDefinition","DestinyDamageTypeDefinition","DestinyFactionDefinition","DestinyGenderDefinition","DestinyItemCategoryDefinition","DestinyItemTierTypeDefinition","DestinyInventoryBucketDefinition","DestinyInventoryItemDefinition","DestinyMedalTierDefinition","DestinyMetricDefinition","DestinyMilestoneDefinition","DestinyObjectiveDefinition","DestinyPlaceDefinition","DestinyPresentationNodeDefinition","DestinyProgressionDefinition","DestinyRaceDefinition","DestinyRecordDefinition","DestinySeasonDefinition","DestinySeasonPassDefinition","DestinyStatDefinition","DestinyTraitDefinition"],l={None:0,Profiles:100,VendorReceipts:101,ProfileInventories:102,ProfileCurrencies:103,ProfileProgression:104,PlatformSilver:105,Characters:200,CharacterInventories:201,CharacterProgressions:202,CharacterRenderData:203,CharacterActivities:204,CharacterEquipment:205,ItemInstances:300,ItemObjectives:301,ItemPerks:302,ItemRenderData:303,ItemStats:304,ItemSockets:305,ItemTalentGrids:306,ItemCommonData:307,ItemPlugStates:308,ItemPlugObjectives:309,ItemReusablePlugs:310,Vendors:400,VendorCategories:401,VendorSales:402,Kiosks:500,CurrencyLookups:600,PresentationNodes:700,Collectibles:800,Records:900,Transitory:1e3,Metrics:1100,StringVariables:1200};this.lastVersion=null,this.applicationName=P,this.apiToken=o,this.destinyDataDefinition={};function h(...n){k("D2API",n)}async function T(n,e,t=null,f=null){let a={};return(t!==null||f!==null)&&(a["Content-Type"]="application/json",a["x-api-key"]=c.apiToken,f!==null&&(a.authorization=`Bearer ${f}`)),t!==null?await fetch(e,{method:n,headers:a,body:t}):await fetch(e,{method:n,headers:a})}async function b(){await i.getItem("destinyTokenExpires")<Date.now()&&(h("Token expired, refreshing"),await c.refreshToken())}function S(n){if(n.error)return h("Error handling token",JSON.stringify(n)),i.removeItem("destinyToken"),i.removeItem("destinyRefreshToken"),i.removeItem("destinyTokenExpires"),i.removeItem("destinyRefreshTokenExpires"),i.removeItem("destinyBungieMembershipId"),!1;i.setItem("destinyToken",n.access_token),i.setItem("destinyRefreshToken",n.refresh_token);let e=Date.now()+n.expires_in*1e3;i.setItem("destinyTokenExpires",e);let t=Date.now()+n.refresh_expires_in*1e3;return i.setItem("destinyRefreshTokenExpires",t),i.setItem("destinyBungieMembershipId",n.membership_id),!0}this.loadDataFromStorage=async()=>{h("Loading data from storage");let n=await i.getItem("manifest");n!==null&&(c.cachedManifest=JSON.parse(n));let e=await i.getItem("manifestVersion");e!==null&&(c.lastVersion=e),c.checkStoredDefinitions();for(let a of D){let g=await i.getItem(`destinyContent-${a}`);g!==null&&(c.destinyDataDefinition[a]=JSON.parse(g))}let t=await i.getItem("destiny-profile");t!==null&&(c.profile=JSON.parse(t));let f=await i.getItem("destiny-linkedProfiles");f!==null&&(c.linkedProfiles=JSON.parse(f)),h("Data loaded from storage"),r.emit("destiny-data-loaded")},this.checkIfAuthenticated=async()=>{try{await b();const n=await i.getItem("destinyToken")!==null;return r.emit("destiny2:authenticated",n),n}catch(n){return h("Error checking if authenticated",n),r.emit("destiny2:authenticated",!1),!1}},this.getToken=async(n,e)=>{const t=await T("POST",`${p}/token/${c.applicationName}`,JSON.stringify({code:e}));if(t.status===200){let f=await t.json();return S(f)?r.emit("destiny2:auth-success"):r.emit("destiny2:auth-failed"),f}h("Error getting token",t.status,t.statusText,await t.text()),r.emit("destiny2:auth-failed")},this.refreshToken=async()=>{const n=await i.getItem("destinyRefreshToken");if(n==null)return r.emit("destiny2:refreshToken",null),null;const e=await T("POST",`${p}/refresh/${c.applicationName}`,JSON.stringify({refresh_token:n}));if(e.status===200){let t=await e.json();S(t)?r.emit("destiny2:refresh-success"):r.emit("destiny2:refresh-failed");return}else r.emit("destiny2:refresh-failed")},this.checkManifestVersion=async()=>(h("Checking manifest version"),new Promise(async function(n,e){let t=await c.getManifest();if(t==null)return h("Failed to fetch API"),null;let f=await i.getItem("manifestVersion")??"null";if(t.Response.version!==f){await i.removeItem("lastManifestUpdate"),await i.removeItem("manifest"),await i.removeItem("manifestVersion");for(let a of D)await i.removeItem(`destinyContent-${a}`);c.cachedManifest=t.Response,await i.setItem("manifestVersion",t.Response.version),await i.setItem("manifest",JSON.stringify(c.cachedManifest)),await i.setItem("lastManifestUpdate",Date.now()),n({updatedManifest:!0,version:c.lastVersion}),h("Manifest updated");return}c.cachedManifest=t.Response,n({updatedManifest:!1,version:c.lastVersion}),h("Manifest version is up to date")})),this.checkStoredDefinitions=async function(n=!0){let e=[];for(let t of D)await i.getItem(`destinyContent-${t}`)===null&&e.push(t);if(e.length>0&&n){for(let t of e)await i.removeItem(`destinyContent-${t}`);await c.loadDestinyContentData(e)}return e},this.loadDestinyContentData=async function(n=[]){for(let e of n)await N(e)};async function N(n){let e=c.cachedManifest;const t=n.replace("Destiny","").split(/(?=[A-Z])/).join(" ");r.emit("loading-text",`Loading ${t}`);const f=await T("GET",`${s}${e.jsonWorldComponentContentPaths.en[n]}`);f.headers.get("content-length");let a=0;const g=new Response(new ReadableStream({async start(C){const E=f.body.getReader();let y=0;for(;;){var L=await E.read();if(L.done)break;a+=L.value.byteLength,y++,y%30===0&&r.emit("loading-text",`Loading ${t} (${new Intl.NumberFormat("sv-SE").format(Math.round(a/1024/1024*100+Number.EPSILON)/100)} MB)`),C.enqueue(L.value)}r.emit("loading-text",`Loading ${t} (${new Intl.NumberFormat("sv-SE").format(Math.round(a/1024/1024*100+Number.EPSILON)/100)} MB)`),C.close()}}));if(f.status!==200){k("Manifest download error",await g.json());return}const m=await g.json();c.destinyDataDefinition[n]=m,i.setItem(`destinyContent-${n}`,JSON.stringify(m))}this.getManifest=async function(){let n=await i.getItem("lastManifestUpdate");if(h("Checking if manifest is cached"),n!==null&&Date.now()-n<6e4*60){let t=await i.getItem("manifest");if(t!==null)return h("Manifest is cached"),{Response:JSON.parse(t)}}let e=await T("GET",`${u}/Destiny2/Manifest/`);if(e.status===200){let t=await e.json();return t.ErrorStatus=="Success"?(i.setItem("lastManifestUpdate",Date.now()),i.setItem("manifest",JSON.stringify(t.Response)),h("Manifest updated from API"),{Response:t.Response}):(h("Manifesterror"),h(t.Response),null)}else{let t=e.json();return h("Error when fetching Manifest"),h(t),null}},this.loadCommonSettings=async function(){await b();const n=await T("GET",`${u}/Settings`,null,await this.getUserToken());return n.status===200?await n.json():(h("Error fetching common settings",n.status,n.statusText),null)},this.getUserToken=async function(){return await i.getItem("destinyToken")},this.getLinkedProfiles=async function(){return await b(),new Promise(async(n,e)=>{var t=await i.getItem("destinyBungieMembershipId");let f=await T("GET",`${u}/Destiny2/-1/Profile/${t}/LinkedProfiles/`,null,await this.getUserToken());if(f.status===200){let a=await f.json();i.setItem("destiny-linkedProfiles",JSON.stringify(a.Response)),c.linkedProfiles=a.Response,n(a.Response)}else c.refreshToken(),e(f)})},this.getUserProfile=async function(n,e){let t=[l.Profiles,l.ProfileInventories,l.ProfileCurrencies,l.ProfileProgression,l.Characters,l.CharacterInventories,l.CharacterProgressions,l.CharacterActivities,l.CharacterEquipment,l.ItemInstances,l.ItemObjectives,l.ItemSockets,l.ItemTalentGrids,l.ItemCommonData,l.ItemPlugStates,l.ItemPlugObjectives,l.ItemReusablePlugs,l.Metrics,l.Records,l.Collectibles,l.StringVariables];return await b(),new Promise(async(f,a)=>{let g=await T("GET",`${u}/Destiny2/${e}/Profile/${n}/?components=${t.join(",")}`,null,await this.getUserToken());if(g.status===200){let m=await g.json();i.setItem("destiny-profile",JSON.stringify(m.Response)),c.profile=m.Response,f(m.Response)}else c.refreshToken(),a(g)})},this.getLastPlayedCharacter=async function(n=!1){await b();let e=c.profile;if(n&&(e=null),c.linkedProfiles===null)return null;if(await c.getLinkedProfiles(),c.linkedProfiles!==null&&c.linkedProfiles.profiles!==null&&c.linkedProfiles.profiles.length>0){var t=c.linkedProfiles.profiles.sort((m,C)=>m.dateLastPlayed>C.dateLastPlayed?-1:1)[0];e=await c.getUserProfile(t.membershipId,t.membershipType)}let f=[];for(let m of e.profile.data.characterIds)f.push(e.characters.data[m]);let a=f.sort((m,C)=>m.dateLastPlayed>C.dateLastPlayed?-1:1)[0];return{characterInfo:a,characterProgression:e.characterProgressions.disabled?{}:e.characterProgressions.data[a.characterId],characterActivities:e.characterActivities.disabled?{}:e.characterActivities.data[a.characterId],characterUninstancedItemComponents:e.characterUninstancedItemComponents[a.characterId].objectives.data,characterInventory:e.characterInventories.data[a.characterId].items,characterEquipment:e.characterEquipment.data[a.characterId].items,characterPlugSets:e.characterPlugSets.disabled?{}:e.characterPlugSets.data[a.characterId].plugs,characterCollectibles:e.characterCollectibles.data[a.characterId].collectibles,characterRecords:e.characterRecords.data[a.characterId],characterStringVariables:e.characterStringVariables.data[a.characterId],profileProgression:e.profileProgression.data,metrics:e.metrics.data.metrics,itemComponents:e.itemComponents,records:e.profileRecords.data,profileInventory:e.profileInventory.data.items,profileCurrency:e.profileCurrencies.data.items,profilePlugSets:e.profilePlugSets.disabled?{}:e.profilePlugSets.data.plugs,profileCollectibles:e.profileCollectibles.data,profile:e.profile.data,profileStringVariables:e.profileStringVariables.data}},this.getNamedDataObject=async function(n=!1){let e=await c.getLastPlayedCharacter(n);if(e==null)return null;let t={...e};for(let a of Object.keys(t.characterInfo.stats))t.characterInfo.stats[a]={statValue:t.characterInfo.stats[a],statHash:a};for(let a of Object.keys(t.metrics))t.metrics[a]={...t.metrics[a],metricHash:a};for(let a of Object.keys(t.records.records))t.records.records[a]={...t.records.records[a],recordHash:a,parentNodeHashes:c.destinyDataDefinition.DestinyRecordDefinition[a].parentNodeHashes};for(let a of Object.keys(t.characterRecords.records))t.characterRecords.records[a]={...t.characterRecords.records[a],recordHash:a,parentNodeHashes:c.destinyDataDefinition.DestinyRecordDefinition[a].parentNodeHashes};return t=c.mapHashesToDefinitionsInObject(t),await i.getItem("destiny2-use-cachebreaker",!1)&&e.characterInventory.filter(g=>g.lockable&&g.inventoryitemItemType==3).length>0,r.emit("destiny2-api-update",t),t},this.getPresentationNodeFromHash=function(n){const e=[],t=c.destinyDataDefinition.DestinyPresentationNodeDefinition[n];if(t&&(e.unshift({name:t.displayProperties.name,description:t.displayProperties.description,icon:t.displayProperties.icon,hash:n}),t.parentNodeHashes))for(let f of t.parentNodeHashes){const a=c.getPresentationNodeFromHash(f);for(let g of a)e.push(g)}return e},this.mapHashesToDefinitionsInObject=function(n){let e={...n},t=Object.keys(e);for(let f of t){let a=typeof e[f],g=e[f];if(Array.isArray(g)){for(let m=0;m<g.length;m++){let C=g[m];typeof C=="object"?g[m]=c.mapHashesToDefinitionsInObject(C):g[m]=C}e[f]=g}else if(a==="object"&&g!==null)e[f]=c.mapHashesToDefinitionsInObject(e[f]);else{if(f.indexOf("Hash")>-1&&!Array.isArray(g)){let m=f.split("Hash")[0].replace("current","").toLowerCase();switch(m){case"item":case"plugitem":m="inventoryitem";break}let C=D.find(y=>y.toLowerCase()==`Destiny${m}Definition`.toLowerCase()),E=c.destinyDataDefinition[C];if(E&&E[g]&&E[g].displayProperties){const y=E[g];y.displayProperties.name&&y.displayProperties.name.length>0?e[`${m}Name`]=y.displayProperties.name:y.setData&&y.setData.questLineName&&y.setData.questLineName.length>0&&(e[`${m}Name`]=y.setData.questLineName),y.displayProperties.description&&y.displayProperties.description.length>0&&(e[`${m}Description`]=y.displayProperties.description),y.displayProperties.icon&&y.displayProperties.icon.length>0&&(e[`${m}Icon`]=y.displayProperties.icon),y.progressDescription&&y.progressDescription.length>0&&(e[`${m}ProgressDescription`]=y.progressDescription),typeof y.inProgressValueStyle<"u"&&(e[`${m}InProgressValueStyle`]=y.inProgressValueStyle),typeof y.completedValueStyle<"u"&&(e[`${m}CompletedValueStyle`]=y.completedValueStyle),typeof y.itemType<"u"&&(e[`${m}ItemType`]=y.itemType),typeof y.parentNodeHashes<"u"&&(e.parentNodeHashes=y.parentNodeHashes.map(L=>c.getPresentationNodeFromHash(L)))}}e[f]=g}}return e};let c=this;return h("Initialized"),this}}k("MAIN","Starting app...");window.eventEmitter=new z;window.db=new K;window.apiClient=new W("5625a52ed6b54ecfb8246071cfcd6085","everversedata");function Y(){const I=j(!1),o=j(!1);return{isDataLoaded:I,isAuthenticated:o}}const O=Y();window.appState=_(O);window.db.initializeDatabase().then(async()=>{k("MAIN","Database initialized, checking for updates..."),O.isAuthenticated.value=await window.apiClient.checkIfAuthenticated(),B(w(G,{}),document.getElementById("app"))});
//# sourceMappingURL=index-11c8d81d.js.map
