var I=Object.defineProperty;var k=(h,t,m)=>t in h?I(h,t,{enumerable:!0,configurable:!0,writable:!0,value:m}):h[t]=m;var f=(h,t,m)=>(k(h,typeof t!="symbol"?t+"":t,m),m);import{o as y,_ as g,R as b,D as T,c as S,B as D}from"./vendor-d09b161a.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const e of l.addedNodes)e.tagName==="LINK"&&e.rel==="modulepreload"&&s(e)}).observe(document,{childList:!0,subtree:!0});function m(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(i){if(i.ep)return;i.ep=!0;const l=m(i);fetch(i.href,l)}})();function c(h,...t){console.log(`[${h}]`,JSON.stringify([...t]))}function E(){return y(g,{children:["Main page -"," ",y("a",{href:"https://o2g.itssimple.se/authenticate/everversedata?state=dataverse-"+new Date().getTime(),children:"Log in"})]})}function v(){const h=window.apiClient,t=b();c("Auth","Authenticated page, getting code",t);const s=new URL(t,location.origin).searchParams.get("code");return c("Auth","Code",s),s?(h.getToken("",s).then(()=>{c("Auth","Got token, redirecting to dashboard"),location.href="/#/dashboard"}).catch(i=>{c("Auth","Failed to get token, redirecting to main page"),location.href="/"}),y(g,{children:"Authenticated, redirecting to Dashboard"})):(c("Auth","No code found, redirecting to main page"),location.href="/",y(g,{children:"Redirecting to main page"}))}function A(){return window.apiClient.checkIfAuthenticated().then(t=>{t||(location.href="/")}),y(g,{children:"Blep"})}function x(){return y("footer",{className:"fui body fiction",children:["Â© 2023",new Date().getUTCFullYear()!=2023?" - "+new Date().getUTCFullYear():null," ","NoLifeKing85#2914"]})}function B(h){return console.log(h),y(g,{children:[y("header",{className:"header tooltip",children:"Dataverse"}),y("div",{class:"app",children:y(T,{history:S(),children:[y(g,{path:"/",children:y(E,{})}),y(g,{path:"/authenticated",children:y(v,{})}),y(g,{path:"/dashboard",children:y(A,{})})]})}),y(x,{})]})}class C{constructor(){f(this,"DBInstance");f(this,"initializeDatabase");f(this,"setItem");f(this,"setItems");f(this,"getItem");f(this,"removeItem");f(this,"setStorageItem");f(this,"setStorageItems");f(this,"getStorageItem");f(this,"getStorageItems");f(this,"removeStorageItem");this.DBInstance=null,this.initializeDatabase=async function(){return new Promise((e,n)=>{let a=window.indexedDB.open("destiny2-dataverse",2);a.onupgradeneeded=function(o){const r=a.result;c("DB","Old",o.oldVersion,"New",o.newVersion),o.oldVersion<1&&(c("DB","Creating first version of database, since it never existed on this installation."),r.createObjectStore("storage",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key")),o.oldVersion<2&&(c("DB","Creating object store for player/character activity"),r.createObjectStore("playerActivity",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"),r.createObjectStore("activityDetails",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"))},a.onsuccess=function(o){c("DB","Loaded database"),l.DBInstance=o.target.result,e()},a.onerror=function(o){c("DB","Failed to load database"),n(o)}})};async function t(e,n,a){return new Promise((o,r)=>{const d=l.DBInstance.transaction(e,"readwrite").objectStore(e).put({key:n,value:a});d.onsuccess=function(){o()},d.onerror=function(w){r(w)}})}async function m(e,n=null){return new Promise((a,o)=>{const u=l.DBInstance.transaction(e,"readonly").objectStore(e).getAll();u.onsuccess=function(){const d=u.result;a(n?d.filter(n):d)},u.onerror=function(d){o(d)}})}async function s(e,n,a=null){return new Promise((o,r)=>{const d=l.DBInstance.transaction(e,"readonly").objectStore(e).get(n);d.onsuccess=function(w){w.target.result?o(w.target.result.value):o(a)},d.onerror=function(w){r(w)}})}async function i(e,n){return new Promise((a,o)=>{const u=l.DBInstance.transaction(e,"readwrite").objectStore(e).delete(n);u.onsuccess=function(){a()},u.onerror=function(d){o(d)}})}this.setItem=async function(e,n){return await t("storage",e,n)},this.setItems=async function(e){for(let n of e)await t("storage",n.key,n.value)},this.getItem=async function(e,n=null){return await s("storage",e,n)},this.removeItem=async function(e){return await i("storage",e)},this.setStorageItem=async function(e,n,a){return await t(e,n,a)},this.setStorageItems=async function(e,n){for(let a of n)await t(e,a.key,a.value)},this.getStorageItem=async function(e,n,a=null){return await s(e,n,a)},this.getStorageItems=async function(e,n=null){return await m(e,n)},this.removeStorageItem=async function(e,n){return await i(e,n)};var l=this;return this}}class j{constructor(){f(this,"eventListeners");f(this,"addEventListener");f(this,"emit");return this.eventListeners=[],this.addEventListener=function(t,m){c("EVENT:REGISTERED",t),this.eventListeners.push({eventName:t,handler:m})},this.emit=async function(t,...m){return JSON.parse(await window.db.getItem("d2-debugmode")??"false")?c("EVENT:EMITTING",t,...m):c("EVENT:EMITTING",t),new Promise((i,l)=>{this.eventListeners.filter(e=>e.eventName==t).forEach(async e=>{try{await e.handler(...m)}catch(n){c("EVENT:ERROR",t,n),console.error(n),l(n)}}),i(!0)})},c("EventEmitter","Initialized"),this}}class N{constructor(t,m){f(this,"checkIfAuthenticated");f(this,"getToken");f(this,"refreshToken");f(this,"apiToken");f(this,"applicationName");c("Destiny2ApiClient","Initializing");const s=window.db,i=window.eventEmitter,l="https://o2g.itssimple.se";this.applicationName=m,this.apiToken=t;async function e(r,p,u=null,d=null){return u!==null?await fetch(p,{method:r,headers:{"x-api-key":o.apiToken,authorization:d!=null?`Bearer ${d}`:"","Content-Type":"application/json"},body:u}):await fetch(p,{method:r,headers:{"x-api-key":o.apiToken,authorization:d!=null?`Bearer ${d}`:""}})}async function n(){await s.getItem("destinyTokenExpires")<Date.now()&&(c("Destiny2ApiClient","Token expired, refreshing"),await o.refreshToken())}function a(r){if(r.error)return c("Destiny2ApiClient","Error handling token",JSON.stringify(r)),s.removeItem("destinyToken"),s.removeItem("destinyRefreshToken"),s.removeItem("destinyTokenExpires"),s.removeItem("destinyRefreshTokenExpires"),s.removeItem("destinyBungieMembershipId"),!1;s.setItem("destinyToken",r.access_token),s.setItem("destinyRefreshToken",r.refresh_token);let p=Date.now()+r.expires_in*1e3;s.setItem("destinyTokenExpires",p);let u=Date.now()+r.refresh_expires_in*1e3;return s.setItem("destinyRefreshTokenExpires",u),s.setItem("destinyBungieMembershipId",r.membership_id),!0}this.checkIfAuthenticated=async()=>{try{await n();const r=await s.getItem("destinyToken")!==null;return i.emit("destiny2:authenticated",r),r}catch(r){return c("Destiny2ApiClient","Error checking if authenticated",r),i.emit("destiny2:authenticated",!1),!1}},this.getToken=async(r,p)=>{const u=await e("POST",`${l}/token/${o.applicationName}`,JSON.stringify({code:p}));if(u.status===200){let d=await u.json();return a(d)?i.emit("destiny2:auth-success"):i.emit("destiny2:auth-failed"),d}c("Destiny2ApiClient","Error getting token",u.status,u.statusText,await u.text()),i.emit("destiny2:auth-failed")},this.refreshToken=async()=>{const r=await s.getItem("destinyRefreshToken");if(r==null)return i.emit("destiny2:refreshToken",null),null;const p=await e("POST",`${l}/refresh/${o.applicationName}`,JSON.stringify({refresh_token:r}));if(p.status===200){let u=await p.json();a(u)?i.emit("destiny2:refresh-success"):i.emit("destiny2:refresh-failed");return}else i.emit("destiny2:refresh-failed")};let o=this;return c("Destiny2ApiClient","Initialized"),this}}c("MAIN","Starting app...");window.eventEmitter=new j;window.db=new C;window.apiClient=new N("5625a52ed6b54ecfb8246071cfcd6085","everversedata");window.db.initializeDatabase().then(async()=>{c("MAIN","Database initialized, checking for updates...");const h=await window.apiClient.checkIfAuthenticated();D(y(B,{authenticated:h}),document.getElementById("app"))});
//# sourceMappingURL=index-ef396dde.js.map
