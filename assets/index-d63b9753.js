var b=Object.defineProperty;var E=(f,o,u)=>o in f?b(f,o,{enumerable:!0,configurable:!0,writable:!0,value:u}):f[o]=u;var c=(f,o,u)=>(E(f,typeof o!="symbol"?o+"":o,u),u);import{o as m,_ as S,R as M,D as A,c as C,B as P}from"./vendor-d09b161a.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const h of n)if(h.type==="childList")for(const t of h.addedNodes)t.tagName==="LINK"&&t.rel==="modulepreload"&&e(t)}).observe(document,{childList:!0,subtree:!0});function u(n){const h={};return n.integrity&&(h.integrity=n.integrity),n.referrerPolicy&&(h.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?h.credentials="include":n.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function e(n){if(n.ep)return;n.ep=!0;const h=u(n);fetch(n.href,h)}})();function g(f,...o){console.log(`[${f}]`,JSON.stringify([...o]))}function x(f){return f.authenticated?(location.href="/#/logging-in",m(S,{})):m(S,{children:["Main page -"," ",m("a",{href:"https://o2g.itssimple.se/authenticate/everversedata?state=dataverse-"+new Date().getTime(),children:"Log in"})]})}function O(){const f=window.apiClient,o=M();g("Auth","Authenticated page, getting code",o);const e=new URL(o,location.origin).searchParams.get("code");return g("Auth","Code",e),e?(f.getToken("",e).then(()=>{g("Auth","Got token, redirecting to dashboard"),location.href="/#/logging-in"}).catch(n=>{g("Auth","Failed to get token, redirecting to main page"),location.href="/"}),m(S,{children:"Authenticated, redirecting to Dashboard"})):(g("Auth","No code found, redirecting to main page"),location.href="/",m(S,{children:"Redirecting to main page"}))}function N(){return window.apiClient.checkIfAuthenticated().then(o=>{o||(location.href="/")}),m(S,{children:"Blep"})}function j(){return m("footer",{className:"fui body fiction",children:["Â© 2023",new Date().getUTCFullYear()!=2023?" - "+new Date().getUTCFullYear():null," ","NoLifeKing85#2914"]})}function R(){const f=window.apiClient,o=window.eventEmitter;o.addEventListener("loading-text",e=>{e&&u(e)});function u(e){let n=document.getElementById("loading-text");n&&(n.innerText=e)}return f.checkIfAuthenticated().then(async e=>{if(!e){location.href="/";return}g("LOGIN","Authenticated, checking manifests"),u("Checking manifest ...");let n=await f.checkManifestVersion();if(n==null){u("Something is wrong with Destiny 2, please reload the page.");return}g("LOGIN",n);let h=await f.checkStoredDefinitions(!1);h.length>0&&(u(`Downloading ${h.length} missing definition(s)`),await f.checkStoredDefinitions(!0)),u("Loading data..."),await f.loadDataFromStorage(),u("Loading data... done"),setTimeout(()=>{u("Opening application..."),o.emit("manifests-loaded")},1e3)}),m(S,{children:m("span",{class:"fui body",id:"loading-text",children:"..."})})}function V(f){return m(S,{children:[m("header",{className:"header subscreen",children:"Dataverse"}),m("div",{class:"app",children:m(A,{history:C(),children:[m(S,{path:"/",children:m(x,{...f})}),m(S,{path:"/authenticated",children:m(O,{})}),m(S,{path:"/logging-in",children:m(R,{})}),m(S,{path:"/dashboard",children:m(N,{})})]})}),m(j,{})]})}class L{constructor(){c(this,"DBInstance");c(this,"initializeDatabase");c(this,"setItem");c(this,"setItems");c(this,"getItem");c(this,"removeItem");c(this,"setStorageItem");c(this,"setStorageItems");c(this,"getStorageItem");c(this,"getStorageItems");c(this,"removeStorageItem");this.DBInstance=null,this.initializeDatabase=async function(){return new Promise((t,r)=>{let y=window.indexedDB.open("destiny2-dataverse",2);y.onupgradeneeded=function(s){const D=y.result;g("DB","Old",s.oldVersion,"New",s.newVersion),s.oldVersion<1&&(g("DB","Creating first version of database, since it never existed on this installation."),D.createObjectStore("storage",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key")),s.oldVersion<2&&(g("DB","Creating object store for player/character activity"),D.createObjectStore("playerActivity",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"),D.createObjectStore("activityDetails",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"))},y.onsuccess=function(s){g("DB","Loaded database"),h.DBInstance=s.target.result,t()},y.onerror=function(s){g("DB","Failed to load database"),r(s)}})};async function o(t,r,y){return new Promise((s,D)=>{const w=h.DBInstance.transaction(t,"readwrite").objectStore(t).put({key:r,value:y});w.onsuccess=function(){s()},w.onerror=function(d){D(d)}})}async function u(t,r=null){return new Promise((y,s)=>{const k=h.DBInstance.transaction(t,"readonly").objectStore(t).getAll();k.onsuccess=function(){const w=k.result;y(r?w.filter(r):w)},k.onerror=function(w){s(w)}})}async function e(t,r,y=null){return new Promise((s,D)=>{const w=h.DBInstance.transaction(t,"readonly").objectStore(t).get(r);w.onsuccess=function(d){d.target.result?s(d.target.result.value):s(y)},w.onerror=function(d){D(d)}})}async function n(t,r){return new Promise((y,s)=>{const k=h.DBInstance.transaction(t,"readwrite").objectStore(t).delete(r);k.onsuccess=function(){y()},k.onerror=function(w){s(w)}})}this.setItem=async function(t,r){return await o("storage",t,r)},this.setItems=async function(t){for(let r of t)await o("storage",r.key,r.value)},this.getItem=async function(t,r=null){return await e("storage",t,r)},this.removeItem=async function(t){return await n("storage",t)},this.setStorageItem=async function(t,r,y){return await o(t,r,y)},this.setStorageItems=async function(t,r){for(let y of r)await o(t,y.key,y.value)},this.getStorageItem=async function(t,r,y=null){return await e(t,r,y)},this.getStorageItems=async function(t,r=null){return await u(t,r)},this.removeStorageItem=async function(t,r){return await n(t,r)};var h=this;return this}}class B{constructor(){c(this,"eventListeners");c(this,"addEventListener");c(this,"emit");return this.eventListeners=[],this.addEventListener=function(o,u){g("EVENT:REGISTERED",o),this.eventListeners.push({eventName:o,handler:u})},this.emit=async function(o,...u){return JSON.parse(await window.db.getItem("d2-debugmode")??"false")?g("EVENT:EMITTING",o,...u):g("EVENT:EMITTING",o),new Promise((n,h)=>{this.eventListeners.filter(t=>t.eventName==o).forEach(async t=>{try{await t.handler(...u)}catch(r){g("EVENT:ERROR",o,r),console.error(r),h(r)}}),n(!0)})},g("EventEmitter","Initialized"),this}}class _{constructor(o,u){c(this,"checkIfAuthenticated");c(this,"getToken");c(this,"refreshToken");c(this,"checkManifestVersion");c(this,"checkStoredDefinitions");c(this,"loadDestinyContentData");c(this,"loadDataFromStorage");c(this,"getManifest");c(this,"apiToken");c(this,"applicationName");c(this,"cachedManifest");c(this,"destinyDataDefinition");c(this,"lastVersion");c(this,"profile");c(this,"linkedProfiles");s("Initializing");const e=window.db,n=window.eventEmitter,h="https://o2g.itssimple.se",t="https://www.bungie.net",r="https://www.bungie.net/Platform",y=["DestinyActivityTypeDefinition","DestinyActivityDefinition","DestinyArtifactDefinition","DestinyChecklistDefinition","DestinyClassDefinition","DestinyDestinationDefinition","DestinyDamageTypeDefinition","DestinyFactionDefinition","DestinyGenderDefinition","DestinyItemCategoryDefinition","DestinyItemTierTypeDefinition","DestinyInventoryBucketDefinition","DestinyInventoryItemDefinition","DestinyMedalTierDefinition","DestinyMetricDefinition","DestinyMilestoneDefinition","DestinyObjectiveDefinition","DestinyPlaceDefinition","DestinyPresentationNodeDefinition","DestinyProgressionDefinition","DestinyRaceDefinition","DestinyRecordDefinition","DestinySeasonDefinition","DestinySeasonPassDefinition","DestinyStatDefinition","DestinyTraitDefinition"];this.lastVersion=null,this.applicationName=u,this.apiToken=o,this.destinyDataDefinition={};function s(...i){g("D2API",i)}async function D(i,l,a=null,p=null){let I={};return a!==null&&(I["Content-Type"]="application/json",I["x-api-key"]=d.apiToken,p!==null&&(I.authorization=`Bearer ${p}`)),a!==null?await fetch(l,{method:i,headers:I,body:a}):await fetch(l,{method:i,headers:I})}async function T(){await e.getItem("destinyTokenExpires")<Date.now()&&(s("Token expired, refreshing"),await d.refreshToken())}function k(i){if(i.error)return s("Error handling token",JSON.stringify(i)),e.removeItem("destinyToken"),e.removeItem("destinyRefreshToken"),e.removeItem("destinyTokenExpires"),e.removeItem("destinyRefreshTokenExpires"),e.removeItem("destinyBungieMembershipId"),!1;e.setItem("destinyToken",i.access_token),e.setItem("destinyRefreshToken",i.refresh_token);let l=Date.now()+i.expires_in*1e3;e.setItem("destinyTokenExpires",l);let a=Date.now()+i.refresh_expires_in*1e3;return e.setItem("destinyRefreshTokenExpires",a),e.setItem("destinyBungieMembershipId",i.membership_id),!0}this.loadDataFromStorage=async()=>{s("Loading data from storage");let i=await e.getItem("manifest");i!==null&&(d.cachedManifest=JSON.parse(i));let l=await e.getItem("manifestVersion");l!==null&&(d.lastVersion=l),d.checkStoredDefinitions();for(let I of y){let v=await e.getItem(`destinyContent-${I}`);v!==null&&(d.destinyDataDefinition[I]=JSON.parse(v))}let a=await e.getItem("destiny-profile");a!==null&&(d.profile=JSON.parse(a));let p=await e.getItem("destiny-linkedProfiles");p!==null&&(d.linkedProfiles=JSON.parse(p)),s("Data loaded from storage"),n.emit("destiny-data-loaded")},this.checkIfAuthenticated=async()=>{try{await T();const i=await e.getItem("destinyToken")!==null;return n.emit("destiny2:authenticated",i),i}catch(i){return s("Error checking if authenticated",i),n.emit("destiny2:authenticated",!1),!1}},this.getToken=async(i,l)=>{const a=await D("POST",`${h}/token/${d.applicationName}`,JSON.stringify({code:l}));if(a.status===200){let p=await a.json();return k(p)?n.emit("destiny2:auth-success"):n.emit("destiny2:auth-failed"),p}s("Error getting token",a.status,a.statusText,await a.text()),n.emit("destiny2:auth-failed")},this.refreshToken=async()=>{const i=await e.getItem("destinyRefreshToken");if(i==null)return n.emit("destiny2:refreshToken",null),null;const l=await D("POST",`${h}/refresh/${d.applicationName}`,JSON.stringify({refresh_token:i}));if(l.status===200){let a=await l.json();k(a)?n.emit("destiny2:refresh-success"):n.emit("destiny2:refresh-failed");return}else n.emit("destiny2:refresh-failed")},this.checkManifestVersion=async()=>(s("Checking manifest version"),new Promise(async function(i,l){let a=await d.getManifest();if(a==null)return s("Failed to fetch API"),null;let p=await e.getItem("manifestVersion")??"null";if(console.log(a,p),a.Response.version!==p){await e.removeItem("lastManifestUpdate"),await e.removeItem("manifest"),await e.removeItem("manifestVersion");for(let I of y)await e.removeItem(`destinyContent-${I}`);d.cachedManifest=a.Response,await e.setItem("manifestVersion",a.Response.version),await e.setItem("manifest",JSON.stringify(d.cachedManifest)),await e.setItem("lastManifestUpdate",Date.now()),i({updatedManifest:!0,version:d.lastVersion}),s("Manifest updated");return}d.cachedManifest=a.Response,i({updatedManifest:!1,version:d.lastVersion}),s("Manifest version is up to date")})),this.checkStoredDefinitions=async function(i=!0){let l=[];for(let a of y)await e.getItem(`destinyContent-${a}`)===null&&l.push(a);if(l.length>0&&i){for(let a of l)await e.removeItem(`destinyContent-${a}`);await d.loadDestinyContentData(l)}return l},this.loadDestinyContentData=async function(i=[]){for(let l of i)await w(l)};async function w(i){let l=d.cachedManifest;const a=i.replace("Destiny","").split(/(?=[A-Z])/).join(" ");n.emit("loading-text",`Loading ${a}`);const p=await D("GET",`${t}${l.jsonWorldComponentContentPaths.en[i]}`);if(p.status!==200){g("Manifest download error",await p.json());return}const I=await p.json();d.destinyDataDefinition[i]=I,e.setItem(`destinyContent-${i}`,JSON.stringify(I))}this.getManifest=async function(){let i=await e.getItem("lastManifestUpdate");if(s("Checking if manifest is cached"),i!==null&&Date.now()-i<6e4*60){let a=await e.getItem("manifest");if(a!==null)return s("Manifest is cached"),{Response:JSON.parse(a)}}let l=await D("GET",`${r}/Destiny2/Manifest/`);if(l.status===200){let a=await l.json();return a.ErrorStatus=="Success"?(e.setItem("lastManifestUpdate",Date.now()),e.setItem("manifest",JSON.stringify(a.Response)),s("Manifest updated from API"),{Response:a.Response}):(s("Manifesterror"),s(a.Response),null)}else{let a=l.json();return s("Error when fetching Manifest"),s(a),null}};let d=this;return s("Initialized"),this}}g("MAIN","Starting app...");window.eventEmitter=new B;window.db=new L;window.apiClient=new _("5625a52ed6b54ecfb8246071cfcd6085","everversedata");window.db.initializeDatabase().then(async()=>{g("MAIN","Database initialized, checking for updates...");const f=await window.apiClient.checkIfAuthenticated();P(m(V,{authenticated:f}),document.getElementById("app"))});
//# sourceMappingURL=index-d63b9753.js.map
