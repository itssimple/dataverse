var U=Object.defineProperty;var F=(d,f,I)=>f in d?U(d,f,{enumerable:!0,configurable:!0,writable:!0,value:I}):d[f]=I;var g=(d,f,I)=>(F(d,typeof f!="symbol"?f+"":f,I),I);import{o as v,_ as V,R as G,p as J,q as K,D as Q,c as z,F as W,B as Y,d as E}from"./vendor-2a203f4d.js";(function(){const f=document.createElement("link").relList;if(f&&f.supports&&f.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const y of n)if(y.type==="childList")for(const u of y.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&r(u)}).observe(document,{childList:!0,subtree:!0});function I(n){const y={};return n.integrity&&(y.integrity=n.integrity),n.referrerPolicy&&(y.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?y.credentials="include":n.crossOrigin==="anonymous"?y.credentials="omit":y.credentials="same-origin",y}function r(n){if(n.ep)return;n.ep=!0;const y=I(n);fetch(n.href,y)}})();function T(d,...f){window.showDataverseLogs&&console.log(`[${d}]`,JSON.stringify([...f]))}function Z(d){return d.isAuthenticated.value?(location.href="/#/logging-in",v(V,{})):v(V,{children:["Main page -"," ",v("a",{href:"https://o2g.itssimple.se/authenticate/everversedata?state=dataverse-"+new Date().getTime(),children:"Log in"})]})}function X(){const d=window.apiClient,f=G();T("Auth","Authenticated page, getting code",f);const r=new URL(f,location.origin).searchParams.get("code");return r?(d.getToken("",r).then(()=>{T("Auth","Got token, redirecting to dashboard"),location.href="/#/logging-in"}).catch(n=>{T("Auth","Failed to get token, redirecting to main page"),location.href="/"}),v(V,{children:"Authenticated, redirecting to Dashboard"})):(T("Auth","No code found, redirecting to main page"),location.href="/",v(V,{children:"Redirecting to main page"}))}function ee(d,f,I=!1){return!I&&!f?"Unknown, no end time":ie(ne(d,f))}function te(d,f,I){let r=[];return d>0&&r.push(`${d}d`),f>0&&r.push(`${f}h`),I>0&&r.push(`${I}m`),r.join(", ")}function ie(d){let{days:f,hours:I,minutes:r}=se(d);return te(f,I,r)}function ne(d,f){return f||(f=Date.now()),(f-d)/1e3}function se(d){let f=Math.floor(d/86400),I=Math.floor(d%(24*3600)/3600),r=Math.floor(d%3600/60),n=Math.floor(d%60);return{days:f,hours:I,minutes:r,seconds:n}}const M=new Intl.NumberFormat,ae="https://www.bungie.net";var R={milestones:!0,bounties:!0,quests:!0,records:!0,seasonRank:!0};function re(d){var o,c;const f=window.eventEmitter,I=window.apiClient;var r;J(()=>{f.addEventListener("goal-list-update",u),async function(){return await I.getTrackableData(),r=setInterval(async()=>{await I.getTrackableData()},15*1e3),()=>{clearInterval(r)}}()},[]);function n(e){let i=null;switch(e.inProgressValueStyle===0&&e.nextLevelAt===1&&(e.inProgressValueStyle=2),e.inProgressValueStyle){case 2:i=v("span",{className:"goal-progress",children:e.progressToNextLevel==0?"Incomplete":"Complete"});break;case 3:let a=(e.progressToNextLevel/e.nextLevelAt*100).toFixed(0);i=v("span",{className:"goal-progress",children:[a," %"]});break;case 8:i="";break;case 12:i=v("span",{className:"goal-progress",children:[e.progressToNextLevel," %"]});break;case 6:default:i=v("span",{className:"goal-progress",children:[M.format(e.progressToNextLevel)," /"," ",M.format(e.nextLevelAt)]});break}return typeof e.nextLevelAt<"u"?v(V,{children:i}):null}function y(e){let i=typeof e.icon<"u"?v("img",{className:"goal-icon",src:`${ae}${e.icon}`}):null,a=typeof e.endDate<"u"?v(V,{children:[v("br",{}),v("i",{class:"fui body fiction goal-end",children:["Ends in ",ee(new Date,new Date(e.endDate))]})]}):null,m=n(e);return v("div",{className:"goal-item",children:[i,v("div",{className:"goal-body",children:[v("h5",{children:[e.name,m]}),e.description,a]})]})}async function u(e){let i=[];for(let a of e){let m=!0;switch(a.type){case"milestone":m=R.milestones;break;case"quest":m=R.quests;break;case"bounty":m=R.bounties;break;case"characterRecord":m=R.records;break;case"seasonrank":m=R.seasonRank;break}m&&i.push(a)}d.goals.value=i}return v("div",{className:"goal-container",children:((c=(o=d.goals)==null?void 0:o.value)==null?void 0:c.length)>0?d.goals.value.map(e=>y(e)):v(V,{children:"Loading ..."})})}function oe(d){const f=window.apiClient;return!d.isAuthenticated.value||!d.isDataLoaded.value?(location.href="/",v(V,{})):(f.profile.profile,v(V,{children:v(re,{...d})}))}function le(){return v("footer",{className:"fui body fiction",children:["Â© 2023",new Date().getUTCFullYear()!=2023?" - "+new Date().getUTCFullYear():null," ","NoLifeKing85#2914"]})}function ce(d){const f=window.apiClient,I=window.eventEmitter;I.addEventListener("loading-text",n=>{n&&r(n)});function r(n){let y=document.getElementById("loading-text");y&&(y.innerText=n)}return f.checkIfAuthenticated().then(async n=>{if(!n){location.href="/";return}T("LOGIN","Authenticated, checking manifests"),r("Checking manifest ...");let y=await f.checkManifestVersion();if(y==null){r("Something is wrong with Destiny 2 (or this app), please reload the page.");return}T("LOGIN",y),r("Loading profile data"),await f.getLastPlayedCharacter(),r("Checking for missing definitions");let u=await f.checkStoredDefinitions(!1);u.length>0&&(r(`Downloading ${u.length} missing definition(s)`),await f.checkStoredDefinitions(!0)),r("Loading data..."),await f.loadDataFromStorage(),d.isDataLoaded.value=!0,setTimeout(()=>{r("Opening application..."),I.emit("manifests-loaded"),setTimeout(()=>{location.href="/#/dashboard"},1e3)},1e3)}).catch(async n=>{n.status===503?(r("Bungie API is down, retrying in a minute."),setTimeout(()=>{location.href="/"},6e4)):(r("An error occurred while trying to log in, please try again."),console.error(n),console.error(await n.json()))}),v(V,{children:v("span",{class:"fui body",id:"loading-text",children:"Logging in and loading data ..."})})}function de(){return v("header",{className:"header subscreen",children:"Dataverse"})}function fe(){const d=K(window.appState);return v(V,{children:[v(de,{}),v("div",{class:"app",children:v(Q,{history:z(),children:[v(V,{path:"/",children:v(Z,{...d})}),v(V,{path:"/authenticated",children:v(X,{})}),v(V,{path:"/logging-in",children:v(ce,{...d})}),v(V,{path:"/dashboard",children:v(oe,{...d})})]})}),v(le,{})]})}class ue{constructor(){g(this,"DBInstance");g(this,"initializeDatabase");g(this,"setItem");g(this,"setItems");g(this,"getItem");g(this,"removeItem");g(this,"setStorageItem");g(this,"setStorageItems");g(this,"getStorageItem");g(this,"getStorageItems");g(this,"removeStorageItem");this.DBInstance=null,this.initializeDatabase=async function(){return new Promise((u,o)=>{let c=window.indexedDB.open("destiny2-dataverse",2);c.onupgradeneeded=function(e){const i=c.result;T("DB","Old",e.oldVersion,"New",e.newVersion),e.oldVersion<1&&(T("DB","Creating first version of database, since it never existed on this installation."),i.createObjectStore("storage",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key")),e.oldVersion<2&&(T("DB","Creating object store for player/character activity"),i.createObjectStore("playerActivity",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"),i.createObjectStore("activityDetails",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"))},c.onsuccess=function(e){T("DB","Loaded database"),y.DBInstance=e.target.result,u()},c.onerror=function(e){T("DB","Failed to load database"),o(e)}})};async function f(u,o,c){return new Promise((e,i)=>{const P=y.DBInstance.transaction(u,"readwrite").objectStore(u).put({key:o,value:c});P.onsuccess=function(){e()},P.onerror=function(N){i(N)}})}async function I(u,o=null){return new Promise((c,e)=>{const m=y.DBInstance.transaction(u,"readonly").objectStore(u).getAll();m.onsuccess=function(){const P=m.result;c(o?P.filter(o):P)},m.onerror=function(P){e(P)}})}async function r(u,o,c=null){return new Promise((e,i)=>{const P=y.DBInstance.transaction(u,"readonly").objectStore(u).get(o);P.onsuccess=function(N){N.target.result?e(N.target.result.value):e(c)},P.onerror=function(N){i(N)}})}async function n(u,o){return new Promise((c,e)=>{const m=y.DBInstance.transaction(u,"readwrite").objectStore(u).delete(o);m.onsuccess=function(){c()},m.onerror=function(P){e(P)}})}this.setItem=async function(u,o){return await f("storage",u,o)},this.setItems=async function(u){for(let o of u)await f("storage",o.key,o.value)},this.getItem=async function(u,o=null){return await r("storage",u,o)},this.removeItem=async function(u){return await n("storage",u)},this.setStorageItem=async function(u,o,c){return await f(u,o,c)},this.setStorageItems=async function(u,o){for(let c of o)await f(u,c.key,c.value)},this.getStorageItem=async function(u,o,c=null){return await r(u,o,c)},this.getStorageItems=async function(u,o=null){return await I(u,o)},this.removeStorageItem=async function(u,o){return await n(u,o)};var y=this;return this}}class pe{constructor(){g(this,"eventListeners");g(this,"addEventListener");g(this,"emit");return this.eventListeners=[],this.addEventListener=function(f,I){T("EVENT:REGISTERED",f),this.eventListeners.push({eventName:f,handler:I})},this.emit=async function(f,...I){return JSON.parse(await window.db.getItem("d2-debugmode")??"false")?T("EVENT:EMITTING",f,...I):T("EVENT:EMITTING",f),new Promise((n,y)=>{this.eventListeners.filter(u=>u.eventName==f).forEach(async u=>{try{await u.handler(...I)}catch(o){T("EVENT:ERROR",f,o),console.error(o),y(o)}}),n(!0)})},T("EventEmitter","Initialized"),this}}var A=(d=>(d[d.None=0]="None",d[d.Locked=1]="Locked",d[d.Tracked=2]="Tracked",d[d.Masterwork=4]="Masterwork",d[d.Crafted=8]="Crafted",d[d.HighlightedObjective=16]="HighlightedObjective",d))(A||{});class he{constructor(f){g(this,"getSeasonRankData");g(this,"replaceStringVariables");g(this,"getMilestoneData");g(this,"getBounties");g(this,"getQuests");g(this,"getCharacterRecords");g(this,"destinyApiClient");this.destinyApiClient=f,this.getSeasonRankData=function(n,y,u){let o=n.characterProgression.progressions[u.rewardProgressionHash],c=n.characterProgression.progressions[u.prestigeProgressionHash],e=this.destinyApiClient.destinyDataDefinition.DestinyInventoryItemDefinition[y.artifactItemHash],i=o.level,a=o.nextLevelAt,m=o.progressToNextLevel;return o.level==o.levelCap&&(i+=c.level,a+=c.nextLevelAt,m+=c.progressToNextLevel),{name:`Season Rank ${i}`,description:y.displayProperties.name,icon:`${e.displayProperties.icon}`,startDate:y.startDate,endDate:y.endDate,nextLevelAt:a,progressToNextLevel:m,type:"seasonrank",order:-1,inProgressValueStyle:0,completedValueStyle:0}},this.replaceStringVariables=function(n,y){if(!n||n.indexOf("{var:")===-1)return n;var u=/{var:(\d+)}/g,o=n.match(u);let c=n;if(o)for(var e=0;e<o.length;e++){var i=o[e],a=i.match(/\d+/);if(a){var m=a[0],P=y[m];P&&(c=c.replace(i,P))}}return c},this.getMilestoneData=function(n){let y=[],u=Object.keys(n.characterProgression.milestones);for(let o of u){let c=n.characterProgression.milestones[o],e={name:this.replaceStringVariables(c.milestoneName,n.profileStringVariables.integerValuesByHash),description:this.replaceStringVariables(c.milestoneDescription,n.profileStringVariables.integerValuesByHash),order:c.order,icon:c.milestoneIcon,type:"milestone",inProgressValueStyle:0,completedValueStyle:0};if(c.startDate&&(e.startDate=c.startDate),c.endDate&&(e.endDate=c.endDate),c.availableQuests&&c.availableQuests.length>0){for(let i of c.availableQuests)if(i.tracked&&(e.tracked=!0),i.status.started&&!i.status.completed&&i.status.stepObjectives&&i.status.stepObjectives.length>0){for(let a of i.status.stepObjectives)if(!a.complete){typeof a.progress<"u"&&(e.progressToNextLevel=a.progress),typeof a.completionValue<"u"&&(e.nextLevelAt=a.completionValue),typeof a.objectiveInProgressValueStyle<"u"&&(e.inProgressValueStyle=a.objectiveInProgressValueStyle),typeof a.objectiveCompletedValueStyle<"u"&&(e.completedValueStyle=a.objectiveCompletedValueStyle),(e.icon??"").length==0&&typeof a.activityIcon<"u"&&(e.icon=a.activityIcon);break}}}if(c.activities&&c.activities.length>0)for(let i of c.activities){if(i.challenges&&i.challenges.length>0){for(let a of i.challenges)if(!a.objective.complete){typeof a.objective.progress<"u"&&(e.progressToNextLevel=a.objective.progress),typeof a.objectiveInProgressValueStyle<"u"&&(e.inProgressValueStyle=a.objectiveInProgressValueStyle),typeof a.objectiveCompletedValueStyle<"u"&&(e.completedValueStyle=a.objectiveCompletedValueStyle),typeof a.objective.completionValue<"u"&&(e.nextLevelAt=a.objective.completionValue);break}}break}y.push(e)}return y};const I=26;this.getBounties=function(n){let y=[];var u=n.characterInventory.filter(o=>o.inventoryitemItemType===I);for(let o of u){let e=n.itemComponents.objectives.data[o.itemInstanceId].objectives.filter(i=>!i.complete);if(e.length!==0)for(let i of e){let a={name:this.replaceStringVariables(o.inventoryitemName,n.profileStringVariables.integerValuesByHash),description:this.replaceStringVariables(o.inventoryitemDescription,n.profileStringVariables.integerValuesByHash),order:500,icon:o.inventoryitemIcon,type:"bounty",inProgressValueStyle:0,completedValueStyle:0,tracked:(o.state&A.Tracked)==A.Tracked,state:o.state};typeof o.expirationDate<"u"&&(a.endDate=o.expirationDate,new Date(o.expirationDate).getTime()<new Date().getTime())||typeof i.completionValue<"u"&&(a.nextLevelAt=i.completionValue,typeof i.objectiveInProgressValueStyle<"u"&&(a.inProgressValueStyle=i.objectiveInProgressValueStyle),typeof i.objectiveCompletedValueStyle<"u"&&(a.completedValueStyle=i.objectiveCompletedValueStyle),typeof i.progress<"u"&&(a.progressToNextLevel=i.progress),typeof i.objectiveProgressDescription<"u"&&(a.description=this.replaceStringVariables(i.objectiveProgressDescription,n.profileStringVariables.integerValuesByHash)),y.push(a))}}return y};const r=1345459588;return this.getQuests=function(n){let y=[];var u=n.characterInventory.filter(e=>e.bucketHash===r&&[I].filter(i=>i!=e.inventoryitemItemType).length>0);let o=u.filter(e=>typeof e.itemInstanceId<"u"),c=u.filter(e=>typeof e.itemInstanceId>"u");for(let e of o){let i=n.itemComponents.objectives.data[e.itemInstanceId];if(i){const a=i.objectives.filter(m=>m.visible&&!m.complete);for(let m of a){let P={name:this.replaceStringVariables(e.inventoryitemName,n.profileStringVariables.integerValuesByHash),description:this.replaceStringVariables(e.inventoryitemDescription,n.profileStringVariables.integerValuesByHash),order:1e3,icon:e.inventoryitemIcon,type:"quest",inProgressValueStyle:0,completedValueStyle:0,tracked:(e.state&A.Tracked)==A.Tracked,state:e.state};typeof m.completionValue<"u"&&(P.nextLevelAt=m.completionValue,typeof m.objectiveInProgressValueStyle<"u"&&(P.inProgressValueStyle=m.objectiveInProgressValueStyle),typeof m.objectiveCompletedValueStyle<"u"&&(P.completedValueStyle=m.objectiveCompletedValueStyle),typeof m.progress<"u"&&(P.progressToNextLevel=m.progress),typeof m.objectiveProgressDescription<"u"&&(P.description=this.replaceStringVariables(m.objectiveProgressDescription,n.profileStringVariables.integerValuesByHash)),y.push(P))}}}for(let e of c){let i=(n.characterProgression.uninstancedItemObjectives[e.itemHash]??[]).filter(a=>a.visible&&!a.complete);for(let a of i){let m={name:this.replaceStringVariables(e.inventoryitemName,n.profileStringVariables.integerValuesByHash),description:this.replaceStringVariables(e.inventoryitemDescription,n.profileStringVariables.integerValuesByHash),order:1e4,icon:e.inventoryitemIcon,type:"quest",inProgressValueStyle:0,completedValueStyle:0,tracked:(e.state&A.Tracked)==A.Tracked,state:e.state};typeof a.completionValue<"u"&&(m.nextLevelAt=a.completionValue,typeof a.objectiveInProgressValueStyle<"u"&&(m.inProgressValueStyle=a.objectiveInProgressValueStyle),typeof a.objectiveCompletedValueStyle<"u"&&(m.completedValueStyle=a.objectiveCompletedValueStyle),typeof a.progress<"u"&&(m.progressToNextLevel=a.progress),typeof a.objectiveProgressDescription<"u"&&(m.description=this.replaceStringVariables(a.objectiveProgressDescription,n.profileStringVariables.integerValuesByHash)),y.push(m))}}return y},this.getCharacterRecords=function(n){let y=[],u=Object.keys(n.characterRecords.records);for(let o of u){let c=n.characterRecords.records[o];if(typeof c.objectives>"u"||(c.recordName??"").length===0)continue;let e=c.objectives.filter(i=>i.visible&&!i.complete);for(let i of e){let a={name:c.recordName,type:"characterRecord",order:100,icon:c.recordIcon,description:`${i.objectiveProgressDescription??""}`,progressToNextLevel:i.progress,nextLevelAt:i.completionValue,inProgressValueStyle:i.objectiveInProgressValueStyle,completedValueStyle:i.objectiveCompletedValueStyle,state:c.state};y.push(a)}}return y},this}}class ye{constructor(f,I){g(this,"checkIfAuthenticated");g(this,"getToken");g(this,"refreshToken");g(this,"checkManifestVersion");g(this,"checkStoredDefinitions");g(this,"loadDestinyContentData");g(this,"loadDataFromStorage");g(this,"getManifest");g(this,"loadCommonSettings");g(this,"getUserToken");g(this,"getLinkedProfiles");g(this,"getUserProfile");g(this,"getLastPlayedCharacter");g(this,"getNamedDataObject");g(this,"getPresentationNodeFromHash");g(this,"mapHashesToDefinitionsInObject");g(this,"getTrackableData");g(this,"apiToken");g(this,"applicationName");g(this,"cachedManifest");g(this,"destinyDataDefinition");g(this,"lastVersion");g(this,"profile");g(this,"linkedProfiles");g(this,"trackedGoals");g(this,"goalApi");i("Initializing");const r=window.db,n=window.eventEmitter,y="https://o2g.itssimple.se",u="https://www.bungie.net",o="https://www.bungie.net/Platform",c=["DestinyActivityTypeDefinition","DestinyActivityDefinition","DestinyArtifactDefinition","DestinyChecklistDefinition","DestinyClassDefinition","DestinyDestinationDefinition","DestinyDamageTypeDefinition","DestinyFactionDefinition","DestinyGenderDefinition","DestinyItemCategoryDefinition","DestinyItemTierTypeDefinition","DestinyInventoryBucketDefinition","DestinyInventoryItemDefinition","DestinyMedalTierDefinition","DestinyMetricDefinition","DestinyMilestoneDefinition","DestinyObjectiveDefinition","DestinyPlaceDefinition","DestinyPresentationNodeDefinition","DestinyProgressionDefinition","DestinyRaceDefinition","DestinyRecordDefinition","DestinySeasonDefinition","DestinySeasonPassDefinition","DestinyStatDefinition","DestinyTraitDefinition"],e={None:0,Profiles:100,VendorReceipts:101,ProfileInventories:102,ProfileCurrencies:103,ProfileProgression:104,PlatformSilver:105,Characters:200,CharacterInventories:201,CharacterProgressions:202,CharacterRenderData:203,CharacterActivities:204,CharacterEquipment:205,ItemInstances:300,ItemObjectives:301,ItemPerks:302,ItemRenderData:303,ItemStats:304,ItemSockets:305,ItemTalentGrids:306,ItemCommonData:307,ItemPlugStates:308,ItemPlugObjectives:309,ItemReusablePlugs:310,Vendors:400,VendorCategories:401,VendorSales:402,Kiosks:500,CurrencyLookups:600,PresentationNodes:700,Collectibles:800,Records:900,Transitory:1e3,Metrics:1100,StringVariables:1200};this.lastVersion=null,this.applicationName=I,this.apiToken=f,this.destinyDataDefinition={},this.trackedGoals=[];function i(...l){T("D2API",l)}async function a(l,t,s=null,b=null){let h={};return(s!==null||b!==null)&&(h["Content-Type"]="application/json",h["x-api-key"]=p.apiToken,b!==null&&(h.authorization=`Bearer ${b}`)),s!==null?await fetch(t,{method:l,headers:h,body:s}):await fetch(t,{method:l,headers:h})}async function m(){await r.getItem("destinyTokenExpires")<Date.now()&&(i("Token expired, refreshing"),await p.refreshToken())}function P(l){if(l.error)return i("Error handling token",JSON.stringify(l)),r.removeItem("destinyToken"),r.removeItem("destinyRefreshToken"),r.removeItem("destinyTokenExpires"),r.removeItem("destinyRefreshTokenExpires"),r.removeItem("destinyBungieMembershipId"),!1;r.setItem("destinyToken",l.access_token),r.setItem("destinyRefreshToken",l.refresh_token);let t=Date.now()+l.expires_in*1e3;r.setItem("destinyTokenExpires",t);let s=Date.now()+l.refresh_expires_in*1e3;return r.setItem("destinyRefreshTokenExpires",s),r.setItem("destinyBungieMembershipId",l.membership_id),!0}this.loadDataFromStorage=async()=>{i("Loading data from storage");let l=await r.getItem("manifest");l!==null&&(p.cachedManifest=JSON.parse(l));let t=await r.getItem("manifestVersion");t!==null&&(p.lastVersion=t),p.checkStoredDefinitions();for(let h of c){let D=await r.getItem(`destinyContent-${h}`);D!==null&&(p.destinyDataDefinition[h]=JSON.parse(D))}let s=await r.getItem("destiny-profile");s!==null&&(p.profile=JSON.parse(s));let b=await r.getItem("destiny-linkedProfiles");b!==null&&(p.linkedProfiles=JSON.parse(b)),i("Data loaded from storage"),n.emit("destiny-data-loaded")},this.checkIfAuthenticated=async()=>{try{await m();const l=await r.getItem("destinyToken")!==null;return n.emit("destiny2:authenticated",l),l}catch(l){return i("Error checking if authenticated",l),n.emit("destiny2:authenticated",!1),!1}},this.getToken=async(l,t)=>{const s=await a("POST",`${y}/token/${p.applicationName}`,JSON.stringify({code:t}));if(s.status===200){let b=await s.json();return P(b)?n.emit("destiny2:auth-success"):n.emit("destiny2:auth-failed"),b}i("Error getting token",s.status,s.statusText,await s.text()),n.emit("destiny2:auth-failed")},this.refreshToken=async()=>{const l=await r.getItem("destinyRefreshToken");if(l==null)return n.emit("destiny2:refreshToken",null),null;const t=await a("POST",`${y}/refresh/${p.applicationName}`,JSON.stringify({refresh_token:l}));if(t.status===200){let s=await t.json();P(s)?n.emit("destiny2:refresh-success"):n.emit("destiny2:refresh-failed");return}else n.emit("destiny2:refresh-failed")},this.checkManifestVersion=async()=>(i("Checking manifest version"),new Promise(async function(l,t){let s=await p.getManifest();if(s==null)return i("Failed to fetch API"),null;let b=await r.getItem("manifestVersion")??"null";if(s.Response.version!==b){await r.removeItem("lastManifestUpdate"),await r.removeItem("manifest"),await r.removeItem("manifestVersion");for(let h of c)await r.removeItem(`destinyContent-${h}`);p.cachedManifest=s.Response,await r.setItem("manifestVersion",s.Response.version),await r.setItem("manifest",JSON.stringify(p.cachedManifest)),await r.setItem("lastManifestUpdate",Date.now()),l({updatedManifest:!0,version:p.lastVersion}),i("Manifest updated");return}p.cachedManifest=s.Response,l({updatedManifest:!1,version:p.lastVersion}),i("Manifest version is up to date")})),this.checkStoredDefinitions=async function(l=!0){let t=[];for(let s of c)await r.getItem(`destinyContent-${s}`)===null&&t.push(s);if(t.length>0&&l){for(let s of t)await r.removeItem(`destinyContent-${s}`);await p.loadDestinyContentData(t)}return t},this.loadDestinyContentData=async function(l=[]){for(let t of l)await N(t)};async function N(l){let t=p.cachedManifest;const s=l.replace("Destiny","").split(/(?=[A-Z])/).join(" ");n.emit("loading-text",`Loading ${s}`);const b=await a("GET",`${u}${t.jsonWorldComponentContentPaths.en[l]}`);b.headers.get("content-length");let h=0;const D=new Response(new ReadableStream({async start(C){const L=b.body.getReader();let k=0;for(;;){var j=await L.read();if(j.done)break;h+=j.value.byteLength,k++,k%30===0&&n.emit("loading-text",`Loading ${s} (${new Intl.NumberFormat("sv-SE").format(Math.round(h/1024/1024*100+Number.EPSILON)/100)} MB)`),C.enqueue(j.value)}n.emit("loading-text",`Loading ${s} (${new Intl.NumberFormat("sv-SE").format(Math.round(h/1024/1024*100+Number.EPSILON)/100)} MB)`),C.close()}}));if(b.status!==200){T("Manifest download error",await D.json());return}const w=await D.json();p.destinyDataDefinition[l]=w,r.setItem(`destinyContent-${l}`,JSON.stringify(w))}this.getManifest=async function(){let l=await r.getItem("lastManifestUpdate");if(i("Checking if manifest is cached"),l!==null&&Date.now()-l<6e4*60){let s=await r.getItem("manifest");if(s!==null)return i("Manifest is cached"),{Response:JSON.parse(s)}}let t=await a("GET",`${o}/Destiny2/Manifest/`);if(t.status===200){let s=await t.json();return s.ErrorStatus=="Success"?(r.setItem("lastManifestUpdate",Date.now()),r.setItem("manifest",JSON.stringify(s.Response)),i("Manifest updated from API"),{Response:s.Response}):(i("Manifesterror"),i(s.Response),null)}else{let s=t.json();return i("Error when fetching Manifest"),i(s),null}},this.loadCommonSettings=async function(){await m();const l=await a("GET",`${o}/Settings`,null,await this.getUserToken());return l.status===200?await l.json():(i("Error fetching common settings",l.status,l.statusText),null)},this.getUserToken=async function(){return await r.getItem("destinyToken")},this.getLinkedProfiles=async function(l=!1){return l&&(p.linkedProfiles=null),p.linkedProfiles!=null?p.linkedProfiles:(await m(),new Promise(async(t,s)=>{var b=await r.getItem("destinyBungieMembershipId");let h=await a("GET",`${o}/Destiny2/-1/Profile/${b}/LinkedProfiles/`,null,await this.getUserToken());if(h.status===200){let D=await h.json();r.setItem("destiny-linkedProfiles",JSON.stringify(D.Response)),p.linkedProfiles=D.Response,t(D.Response)}else p.refreshToken(),s(h)}))},this.getUserProfile=async function(l,t){let s=[e.Profiles,e.ProfileInventories,e.ProfileCurrencies,e.ProfileProgression,e.Characters,e.CharacterInventories,e.CharacterProgressions,e.CharacterActivities,e.CharacterEquipment,e.ItemInstances,e.ItemObjectives,e.ItemSockets,e.ItemTalentGrids,e.ItemCommonData,e.ItemPlugStates,e.ItemPlugObjectives,e.ItemReusablePlugs,e.Metrics,e.Records,e.Collectibles,e.StringVariables];return await m(),new Promise(async(b,h)=>{let D=await a("GET",`${o}/Destiny2/${t}/Profile/${l}/?components=${s.join(",")}`,null,await this.getUserToken());if(D.status===200){let w=await D.json();typeof p.profile>"u"||new Date(p.profile.responseMintedTimestamp).getTime()<new Date(w.Response.responseMintedTimestamp).getTime()?(r.setItem("destiny-profile",JSON.stringify(w.Response)),p.profile=w.Response,b(w.Response)):b(p.profile)}else p.refreshToken(),h(D)})},this.getLastPlayedCharacter=async function(l=!1){await m();let t=p.profile;if(typeof t<"u"&&(new Date().getTime()-new Date(t.responseMintedTimestamp).getTime())/1e3>60&&(l=!0),l&&(t=null),p.linkedProfiles===null)return null;if(await p.getLinkedProfiles(l),p.linkedProfiles!==null&&p.linkedProfiles.profiles!==null&&p.linkedProfiles.profiles.length>0){var s=p.linkedProfiles.profiles.sort((w,C)=>w.dateLastPlayed>C.dateLastPlayed?-1:1)[0];t=await p.getUserProfile(s.membershipId,s.membershipType)}let b=[];for(let w of t.profile.data.characterIds)b.push(t.characters.data[w]);let h=b.sort((w,C)=>w.dateLastPlayed>C.dateLastPlayed?-1:1)[0];return{characterInfo:h,characterProgression:t.characterProgressions.disabled?{}:t.characterProgressions.data[h.characterId],characterActivities:t.characterActivities.disabled?{}:t.characterActivities.data[h.characterId],characterUninstancedItemComponents:t.characterUninstancedItemComponents[h.characterId].objectives.data,characterInventory:t.characterInventories.data[h.characterId].items,characterEquipment:t.characterEquipment.data[h.characterId].items,characterPlugSets:t.characterPlugSets.disabled?{}:t.characterPlugSets.data[h.characterId].plugs,characterCollectibles:t.characterCollectibles.data[h.characterId].collectibles,characterRecords:t.characterRecords.data[h.characterId],characterStringVariables:t.characterStringVariables.data[h.characterId],profileProgression:t.profileProgression.data,metrics:t.metrics.data.metrics,itemComponents:t.itemComponents,records:t.profileRecords.data,profileInventory:t.profileInventory.data.items,profileCurrency:t.profileCurrencies.data.items,profilePlugSets:t.profilePlugSets.disabled?{}:t.profilePlugSets.data.plugs,profileCollectibles:t.profileCollectibles.data,profile:t.profile.data,profileStringVariables:t.profileStringVariables.data}},this.getNamedDataObject=async function(l=!1){let t=await p.getLastPlayedCharacter(l);if(t==null)return null;let s={...t};for(let h of Object.keys(s.characterInfo.stats))s.characterInfo.stats[h]={statValue:s.characterInfo.stats[h],statHash:h};for(let h of Object.keys(s.metrics))s.metrics[h]={...s.metrics[h],metricHash:h};for(let h of Object.keys(s.records.records))s.records.records[h]={...s.records.records[h],recordHash:h,parentNodeHashes:p.destinyDataDefinition.DestinyRecordDefinition[h].parentNodeHashes};for(let h of Object.keys(s.characterRecords.records))s.characterRecords.records[h]={...s.characterRecords.records[h],recordHash:h,parentNodeHashes:p.destinyDataDefinition.DestinyRecordDefinition[h].parentNodeHashes};return s=p.mapHashesToDefinitionsInObject(s),await r.getItem("destiny2-use-cachebreaker",!1)&&t.characterInventory.filter(D=>D.lockable&&D.inventoryitemItemType==3).length>0,n.emit("destiny2-api-update",s),s},this.getPresentationNodeFromHash=function(l){const t=[],s=p.destinyDataDefinition.DestinyPresentationNodeDefinition[l];if(s&&(t.unshift({name:s.displayProperties.name,description:s.displayProperties.description,icon:s.displayProperties.icon,hash:l}),s.parentNodeHashes))for(let b of s.parentNodeHashes){const h=p.getPresentationNodeFromHash(b);for(let D of h)t.push(D)}return t},this.mapHashesToDefinitionsInObject=function(l){let t={...l},s=Object.keys(t);for(let b of s){let h=typeof t[b],D=t[b];if(Array.isArray(D)){for(let w=0;w<D.length;w++){let C=D[w];typeof C=="object"?D[w]=p.mapHashesToDefinitionsInObject(C):D[w]=C}t[b]=D}else if(h==="object"&&D!==null)t[b]=p.mapHashesToDefinitionsInObject(t[b]);else{if(b.indexOf("Hash")>-1&&!Array.isArray(D)){let w=b.split("Hash")[0].replace("current","").toLowerCase();switch(w){case"item":case"plugitem":w="inventoryitem";break}let C=c.find(k=>k.toLowerCase()==`Destiny${w}Definition`.toLowerCase()),L=p.destinyDataDefinition[C];if(L&&L[D]&&L[D].displayProperties){const k=L[D];k.displayProperties.name&&k.displayProperties.name.length>0?t[`${w}Name`]=k.displayProperties.name:k.setData&&k.setData.questLineName&&k.setData.questLineName.length>0&&(t[`${w}Name`]=k.setData.questLineName),k.displayProperties.description&&k.displayProperties.description.length>0&&(t[`${w}Description`]=k.displayProperties.description),k.displayProperties.icon&&k.displayProperties.icon.length>0&&(t[`${w}Icon`]=k.displayProperties.icon),k.progressDescription&&k.progressDescription.length>0&&(t[`${w}ProgressDescription`]=k.progressDescription),typeof k.inProgressValueStyle<"u"&&(t[`${w}InProgressValueStyle`]=k.inProgressValueStyle),typeof k.completedValueStyle<"u"&&(t[`${w}CompletedValueStyle`]=k.completedValueStyle),typeof k.itemType<"u"&&(t[`${w}ItemType`]=k.itemType),typeof k.parentNodeHashes<"u"&&(t.parentNodeHashes=k.parentNodeHashes.map(j=>p.getPresentationNodeFromHash(j)))}}t[b]=D}}return t},this.getTrackableData=async function(l=!1){let t=await p.getNamedDataObject(l);if(t==null)return null;let s=p.destinyDataDefinition.DestinySeasonDefinition[t.profile.currentSeasonHash],b=s.seasonPassList.find(S=>new Date<new Date(Date.parse(S.seasonPassEndDate))&&new Date>=new Date(Date.parse(S.seasonPassStartDate))),h=p.destinyDataDefinition.DestinySeasonPassDefinition[b.seasonPassHash],D=[],w=p.goalApi.getMilestoneData(t);for(let S of w)D.push(S);let C=p.goalApi.getBounties(t);for(let S of C)D.push(S);let L=p.goalApi.getQuests(t);for(let S of L)D.push(S);let k=p.goalApi.getCharacterRecords(t);for(let S of k)D.push(S);function j(S,x){if(typeof S.nextLevelAt<"u"&&typeof x.nextLevelAt<"u"){let q=S.progressToNextLevel/S.nextLevelAt*100,_=x.progressToNextLevel/x.nextLevelAt*100;return q<_?1:-1}return typeof S.endDate<"u"?typeof x.endDate>"u"||S.endDate<x.endDate?-1:1:S.order<x.order?1:-1}const H=D.filter(S=>S.tracked).sort(j),$=D.filter(S=>S.endDate&&!S.tracked).sort(j),B=D.filter(S=>!S.endDate&&!S.tracked).sort(j);return D=[...H,...$,...B],D.unshift(p.goalApi.getSeasonRankData(t,s,h)),p.trackedGoals=D,n.emit("goal-list-update",D),D};let p=this;return this.goalApi=new he(this),i("Initialized"),this}}T("MAIN","Starting app...");window.eventEmitter=new pe;window.db=new ue;window.apiClient=new ye("5625a52ed6b54ecfb8246071cfcd6085","everversedata");function me(){const d=E(!1),f=E(!1),I=E([]);return{isDataLoaded:d,isAuthenticated:f,goals:I}}const O=me();window.appState=W(O);window.db.initializeDatabase().then(async()=>{T("MAIN","Database initialized, checking for updates..."),O.isAuthenticated.value=await window.apiClient.checkIfAuthenticated(),Y(v(fe,{}),document.getElementById("app"))});
//# sourceMappingURL=index-5663f3c7.js.map
