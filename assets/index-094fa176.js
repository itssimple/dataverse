var I=Object.defineProperty;var k=(o,t,y)=>t in o?I(o,t,{enumerable:!0,configurable:!0,writable:!0,value:y}):o[t]=y;var d=(o,t,y)=>(k(o,typeof t!="symbol"?t+"":t,y),y);import{o as u,_ as w,R as b,D as T,c as S,B as E}from"./vendor-d09b161a.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const c of i)if(c.type==="childList")for(const e of c.addedNodes)e.tagName==="LINK"&&e.rel==="modulepreload"&&a(e)}).observe(document,{childList:!0,subtree:!0});function y(i){const c={};return i.integrity&&(c.integrity=i.integrity),i.referrerPolicy&&(c.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?c.credentials="include":i.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function a(i){if(i.ep)return;i.ep=!0;const c=y(i);fetch(i.href,c)}})();function h(o,...t){console.log(`[${o}]`,JSON.stringify([...t]))}function D(o){return o.authenticated?(location.href="/#/logging-in",u(w,{})):u(w,{children:["Main page -"," ",u("a",{href:"https://o2g.itssimple.se/authenticate/everversedata?state=dataverse-"+new Date().getTime(),children:"Log in"})]})}function v(){const o=window.apiClient,t=b();h("Auth","Authenticated page, getting code",t);const a=new URL(t,location.origin).searchParams.get("code");return h("Auth","Code",a),a?(o.getToken("",a).then(()=>{h("Auth","Got token, redirecting to dashboard"),location.href="/#/logging-in"}).catch(i=>{h("Auth","Failed to get token, redirecting to main page"),location.href="/"}),u(w,{children:"Authenticated, redirecting to Dashboard"})):(h("Auth","No code found, redirecting to main page"),location.href="/",u(w,{children:"Redirecting to main page"}))}function A(){return window.apiClient.checkIfAuthenticated().then(t=>{t||(location.href="/")}),u(w,{children:"Blep"})}function x(){return u("footer",{className:"fui body fiction",children:["Â© 2023",new Date().getUTCFullYear()!=2023?" - "+new Date().getUTCFullYear():null," ","NoLifeKing85#2914"]})}function B(){const o=window.apiClient;return o.checkIfAuthenticated().then(async t=>{if(!t){location.href="/";return}h("LOGIN","Authenticated, checking manifests"),await o.checkManifestVersion()}),u(w,{children:"Logging in and checking manifests"})}function j(o){return u(w,{children:[u("header",{className:"header subscreen",children:"Dataverse"}),u("div",{class:"app",children:u(T,{history:S(),children:[u(w,{path:"/",children:u(D,{...o})}),u(w,{path:"/authenticated",children:u(v,{})}),u(w,{path:"/logging-in",children:u(B,{})}),u(w,{path:"/dashboard",children:u(A,{})})]})}),u(x,{})]})}class N{constructor(){d(this,"DBInstance");d(this,"initializeDatabase");d(this,"setItem");d(this,"setItems");d(this,"getItem");d(this,"removeItem");d(this,"setStorageItem");d(this,"setStorageItems");d(this,"getStorageItem");d(this,"getStorageItems");d(this,"removeStorageItem");this.DBInstance=null,this.initializeDatabase=async function(){return new Promise((e,n)=>{let l=window.indexedDB.open("destiny2-dataverse",2);l.onupgradeneeded=function(f){const m=l.result;h("DB","Old",f.oldVersion,"New",f.newVersion),f.oldVersion<1&&(h("DB","Creating first version of database, since it never existed on this installation."),m.createObjectStore("storage",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key")),f.oldVersion<2&&(h("DB","Creating object store for player/character activity"),m.createObjectStore("playerActivity",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"),m.createObjectStore("activityDetails",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"))},l.onsuccess=function(f){h("DB","Loaded database"),c.DBInstance=f.target.result,e()},l.onerror=function(f){h("DB","Failed to load database"),n(f)}})};async function t(e,n,l){return new Promise((f,m)=>{const s=c.DBInstance.transaction(e,"readwrite").objectStore(e).put({key:n,value:l});s.onsuccess=function(){f()},s.onerror=function(p){m(p)}})}async function y(e,n=null){return new Promise((l,f)=>{const g=c.DBInstance.transaction(e,"readonly").objectStore(e).getAll();g.onsuccess=function(){const s=g.result;l(n?s.filter(n):s)},g.onerror=function(s){f(s)}})}async function a(e,n,l=null){return new Promise((f,m)=>{const s=c.DBInstance.transaction(e,"readonly").objectStore(e).get(n);s.onsuccess=function(p){p.target.result?f(p.target.result.value):f(l)},s.onerror=function(p){m(p)}})}async function i(e,n){return new Promise((l,f)=>{const g=c.DBInstance.transaction(e,"readwrite").objectStore(e).delete(n);g.onsuccess=function(){l()},g.onerror=function(s){f(s)}})}this.setItem=async function(e,n){return await t("storage",e,n)},this.setItems=async function(e){for(let n of e)await t("storage",n.key,n.value)},this.getItem=async function(e,n=null){return await a("storage",e,n)},this.removeItem=async function(e){return await i("storage",e)},this.setStorageItem=async function(e,n,l){return await t(e,n,l)},this.setStorageItems=async function(e,n){for(let l of n)await t(e,l.key,l.value)},this.getStorageItem=async function(e,n,l=null){return await a(e,n,l)},this.getStorageItems=async function(e,n=null){return await y(e,n)},this.removeStorageItem=async function(e,n){return await i(e,n)};var c=this;return this}}class O{constructor(){d(this,"eventListeners");d(this,"addEventListener");d(this,"emit");return this.eventListeners=[],this.addEventListener=function(t,y){h("EVENT:REGISTERED",t),this.eventListeners.push({eventName:t,handler:y})},this.emit=async function(t,...y){return JSON.parse(await window.db.getItem("d2-debugmode")??"false")?h("EVENT:EMITTING",t,...y):h("EVENT:EMITTING",t),new Promise((i,c)=>{this.eventListeners.filter(e=>e.eventName==t).forEach(async e=>{try{await e.handler(...y)}catch(n){h("EVENT:ERROR",t,n),console.error(n),c(n)}}),i(!0)})},h("EventEmitter","Initialized"),this}}class C{constructor(t,y){d(this,"checkIfAuthenticated");d(this,"getToken");d(this,"refreshToken");d(this,"checkManifestVersion");d(this,"apiToken");d(this,"applicationName");h("Destiny2ApiClient","Initializing");const a=window.db,i=window.eventEmitter,c="https://o2g.itssimple.se";this.applicationName=y,this.apiToken=t;function e(...r){h("Destiny2ApiClient",r)}async function n(r,g,s=null,p=null){return s!==null?await fetch(g,{method:r,headers:{"x-api-key":m.apiToken,authorization:p!=null?`Bearer ${p}`:"","Content-Type":"application/json"},body:s}):await fetch(g,{method:r,headers:{"x-api-key":m.apiToken,authorization:p!=null?`Bearer ${p}`:""}})}async function l(){await a.getItem("destinyTokenExpires")<Date.now()&&(e("Token expired, refreshing"),await m.refreshToken())}function f(r){if(r.error)return e("Error handling token",JSON.stringify(r)),a.removeItem("destinyToken"),a.removeItem("destinyRefreshToken"),a.removeItem("destinyTokenExpires"),a.removeItem("destinyRefreshTokenExpires"),a.removeItem("destinyBungieMembershipId"),!1;a.setItem("destinyToken",r.access_token),a.setItem("destinyRefreshToken",r.refresh_token);let g=Date.now()+r.expires_in*1e3;a.setItem("destinyTokenExpires",g);let s=Date.now()+r.refresh_expires_in*1e3;return a.setItem("destinyRefreshTokenExpires",s),a.setItem("destinyBungieMembershipId",r.membership_id),!0}this.checkIfAuthenticated=async()=>{try{await l();const r=await a.getItem("destinyToken")!==null;return i.emit("destiny2:authenticated",r),r}catch(r){return e("Error checking if authenticated",r),i.emit("destiny2:authenticated",!1),!1}},this.getToken=async(r,g)=>{const s=await n("POST",`${c}/token/${m.applicationName}`,JSON.stringify({code:g}));if(s.status===200){let p=await s.json();return f(p)?i.emit("destiny2:auth-success"):i.emit("destiny2:auth-failed"),p}e("Error getting token",s.status,s.statusText,await s.text()),i.emit("destiny2:auth-failed")},this.refreshToken=async()=>{const r=await a.getItem("destinyRefreshToken");if(r==null)return i.emit("destiny2:refreshToken",null),null;const g=await n("POST",`${c}/refresh/${m.applicationName}`,JSON.stringify({refresh_token:r}));if(g.status===200){let s=await g.json();f(s)?i.emit("destiny2:refresh-success"):i.emit("destiny2:refresh-failed");return}else i.emit("destiny2:refresh-failed")},this.checkManifestVersion=async()=>{};let m=this;return e("Initialized"),this}}h("MAIN","Starting app...");window.eventEmitter=new O;window.db=new N;window.apiClient=new C("5625a52ed6b54ecfb8246071cfcd6085","everversedata");window.db.initializeDatabase().then(async()=>{h("MAIN","Database initialized, checking for updates...");const o=await window.apiClient.checkIfAuthenticated();E(u(j,{authenticated:o}),document.getElementById("app"))});
//# sourceMappingURL=index-094fa176.js.map
