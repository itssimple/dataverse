var _=Object.defineProperty;var U=(f,u,v)=>u in f?_(f,u,{enumerable:!0,configurable:!0,writable:!0,value:v}):f[u]=v;var m=(f,u,v)=>(U(f,typeof u!="symbol"?u+"":u,v),v);import{o as D,_ as T,R as F,p as G,q as J,D as K,c as Q,F as z,B as W,d as E}from"./vendor-2a203f4d.js";(function(){const u=document.createElement("link").relList;if(u&&u.supports&&u.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const y of n)if(y.type==="childList")for(const p of y.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&r(p)}).observe(document,{childList:!0,subtree:!0});function v(n){const y={};return n.integrity&&(y.integrity=n.integrity),n.referrerPolicy&&(y.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?y.credentials="include":n.crossOrigin==="anonymous"?y.credentials="omit":y.credentials="same-origin",y}function r(n){if(n.ep)return;n.ep=!0;const y=v(n);fetch(n.href,y)}})();function V(f,...u){console.log(`[${f}]`,JSON.stringify([...u]))}function Y(f){return f.isAuthenticated.value?(location.href="/#/logging-in",D(T,{})):D(T,{children:["Main page -"," ",D("a",{href:"https://o2g.itssimple.se/authenticate/everversedata?state=dataverse-"+new Date().getTime(),children:"Log in"})]})}function Z(){const f=window.apiClient,u=F();V("Auth","Authenticated page, getting code",u);const r=new URL(u,location.origin).searchParams.get("code");return r?(f.getToken("",r).then(()=>{V("Auth","Got token, redirecting to dashboard"),location.href="/#/logging-in"}).catch(n=>{V("Auth","Failed to get token, redirecting to main page"),location.href="/"}),D(T,{children:"Authenticated, redirecting to Dashboard"})):(V("Auth","No code found, redirecting to main page"),location.href="/",D(T,{children:"Redirecting to main page"}))}function X(f,u,v=!1){return!v&&!u?"Unknown, no end time":te(ie(f,u))}function ee(f,u,v){let r=[];return f>0&&r.push(`${f}d`),u>0&&r.push(`${u}h`),v>0&&r.push(`${v}m`),r.join(", ")}function te(f){let{days:u,hours:v,minutes:r}=ne(f);return ee(u,v,r)}function ie(f,u){return u||(u=Date.now()),(u-f)/1e3}function ne(f){let u=Math.floor(f/86400),v=Math.floor(f%(24*3600)/3600),r=Math.floor(f%3600/60),n=Math.floor(f%60);return{days:u,hours:v,minutes:r,seconds:n}}const M=new Intl.NumberFormat,se="https://www.bungie.net";var R={milestones:!0,bounties:!0,quests:!0,records:!0,seasonRank:!0};function ae(f){var o,c;const u=window.eventEmitter,v=window.apiClient;var r;G(()=>{u.addEventListener("goal-list-update",p),async function(){return await v.getTrackableData(),r=setInterval(async()=>{await v.getTrackableData()},15*1e3),()=>{clearInterval(r)}}()},[]);function n(e){let i=null;switch(e.inProgressValueStyle===0&&e.nextLevelAt===1&&(e.inProgressValueStyle=2),e.inProgressValueStyle){case 2:i=D("span",{className:"goal-progress",children:e.progressToNextLevel==0?"Incomplete":"Complete"});break;case 3:let a=(e.progressToNextLevel/e.nextLevelAt*100).toFixed(0);i=D("span",{className:"goal-progress",children:[a," %"]});break;case 8:i="";break;case 12:i=D("span",{className:"goal-progress",children:[e.progressToNextLevel," %"]});break;case 6:default:i=D("span",{className:"goal-progress",children:[M.format(e.progressToNextLevel)," /"," ",M.format(e.nextLevelAt)]});break}return typeof e.nextLevelAt<"u"?D(T,{children:i}):null}function y(e){let i=typeof e.icon<"u"?D("img",{className:"goal-icon",src:`${se}${e.icon}`}):null,a=typeof e.endDate<"u"?D(T,{children:[D("br",{}),D("i",{class:"fui body fiction goal-end",children:["Ends in ",X(new Date,new Date(e.endDate))]})]}):null,g=n(e);return D("div",{className:"goal-item",children:[i,D("div",{className:"goal-body",children:[D("h5",{children:[e.name,g]}),e.description,a]})]})}async function p(e){let i=[];for(let a of e){let g=!0;switch(a.type){case"milestone":g=R.milestones;break;case"quest":g=R.quests;break;case"bounty":g=R.bounties;break;case"characterRecord":g=R.records;break;case"seasonrank":g=R.seasonRank;break}g&&i.push(a)}f.goals.value=i}return D("div",{className:"goal-container",children:((c=(o=f.goals)==null?void 0:o.value)==null?void 0:c.length)>0?f.goals.value.map(e=>y(e)):D(T,{children:"Loading ..."})})}function re(f){const u=window.apiClient;return!f.isAuthenticated.value||!f.isDataLoaded.value?(location.href="/",D(T,{})):(u.profile.profile,D(T,{children:D(ae,{...f})}))}function oe(){return D("footer",{className:"fui body fiction",children:["Â© 2023",new Date().getUTCFullYear()!=2023?" - "+new Date().getUTCFullYear():null," ","NoLifeKing85#2914"]})}function le(f){const u=window.apiClient,v=window.eventEmitter;v.addEventListener("loading-text",n=>{n&&r(n)});function r(n){let y=document.getElementById("loading-text");y&&(y.innerText=n)}return u.checkIfAuthenticated().then(async n=>{if(!n){location.href="/";return}V("LOGIN","Authenticated, checking manifests"),r("Checking manifest ...");let y=await u.checkManifestVersion();if(y==null){r("Something is wrong with Destiny 2 (or this app), please reload the page.");return}V("LOGIN",y),r("Loading profile data"),await u.getLastPlayedCharacter(),r("Checking for missing definitions");let p=await u.checkStoredDefinitions(!1);p.length>0&&(r(`Downloading ${p.length} missing definition(s)`),await u.checkStoredDefinitions(!0)),r("Loading data..."),await u.loadDataFromStorage(),f.isDataLoaded.value=!0,setTimeout(()=>{r("Opening application..."),v.emit("manifests-loaded"),setTimeout(()=>{location.href="/#/dashboard"},1e3)},1e3)}),D(T,{children:D("span",{class:"fui body",id:"loading-text",children:"Logging in and loading data ..."})})}function ce(){return D("header",{className:"header subscreen",children:"Dataverse"})}function de(){const f=J(window.appState);return D(T,{children:[D(ce,{}),D("div",{class:"app",children:D(K,{history:Q(),children:[D(T,{path:"/",children:D(Y,{...f})}),D(T,{path:"/authenticated",children:D(Z,{})}),D(T,{path:"/logging-in",children:D(le,{...f})}),D(T,{path:"/dashboard",children:D(re,{...f})})]})}),D(oe,{})]})}class fe{constructor(){m(this,"DBInstance");m(this,"initializeDatabase");m(this,"setItem");m(this,"setItems");m(this,"getItem");m(this,"removeItem");m(this,"setStorageItem");m(this,"setStorageItems");m(this,"getStorageItem");m(this,"getStorageItems");m(this,"removeStorageItem");this.DBInstance=null,this.initializeDatabase=async function(){return new Promise((p,o)=>{let c=window.indexedDB.open("destiny2-dataverse",2);c.onupgradeneeded=function(e){const i=c.result;V("DB","Old",e.oldVersion,"New",e.newVersion),e.oldVersion<1&&(V("DB","Creating first version of database, since it never existed on this installation."),i.createObjectStore("storage",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key")),e.oldVersion<2&&(V("DB","Creating object store for player/character activity"),i.createObjectStore("playerActivity",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"),i.createObjectStore("activityDetails",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"))},c.onsuccess=function(e){V("DB","Loaded database"),y.DBInstance=e.target.result,p()},c.onerror=function(e){V("DB","Failed to load database"),o(e)}})};async function u(p,o,c){return new Promise((e,i)=>{const P=y.DBInstance.transaction(p,"readwrite").objectStore(p).put({key:o,value:c});P.onsuccess=function(){e()},P.onerror=function(j){i(j)}})}async function v(p,o=null){return new Promise((c,e)=>{const g=y.DBInstance.transaction(p,"readonly").objectStore(p).getAll();g.onsuccess=function(){const P=g.result;c(o?P.filter(o):P)},g.onerror=function(P){e(P)}})}async function r(p,o,c=null){return new Promise((e,i)=>{const P=y.DBInstance.transaction(p,"readonly").objectStore(p).get(o);P.onsuccess=function(j){j.target.result?e(j.target.result.value):e(c)},P.onerror=function(j){i(j)}})}async function n(p,o){return new Promise((c,e)=>{const g=y.DBInstance.transaction(p,"readwrite").objectStore(p).delete(o);g.onsuccess=function(){c()},g.onerror=function(P){e(P)}})}this.setItem=async function(p,o){return await u("storage",p,o)},this.setItems=async function(p){for(let o of p)await u("storage",o.key,o.value)},this.getItem=async function(p,o=null){return await r("storage",p,o)},this.removeItem=async function(p){return await n("storage",p)},this.setStorageItem=async function(p,o,c){return await u(p,o,c)},this.setStorageItems=async function(p,o){for(let c of o)await u(p,c.key,c.value)},this.getStorageItem=async function(p,o,c=null){return await r(p,o,c)},this.getStorageItems=async function(p,o=null){return await v(p,o)},this.removeStorageItem=async function(p,o){return await n(p,o)};var y=this;return this}}class ue{constructor(){m(this,"eventListeners");m(this,"addEventListener");m(this,"emit");return this.eventListeners=[],this.addEventListener=function(u,v){V("EVENT:REGISTERED",u),this.eventListeners.push({eventName:u,handler:v})},this.emit=async function(u,...v){return JSON.parse(await window.db.getItem("d2-debugmode")??"false")?V("EVENT:EMITTING",u,...v):V("EVENT:EMITTING",u),new Promise((n,y)=>{this.eventListeners.filter(p=>p.eventName==u).forEach(async p=>{try{await p.handler(...v)}catch(o){V("EVENT:ERROR",u,o),console.error(o),y(o)}}),n(!0)})},V("EventEmitter","Initialized"),this}}var x=(f=>(f[f.None=0]="None",f[f.Locked=1]="Locked",f[f.Tracked=2]="Tracked",f[f.Masterwork=4]="Masterwork",f[f.Crafted=8]="Crafted",f[f.HighlightedObjective=16]="HighlightedObjective",f))(x||{});class pe{constructor(u){m(this,"getSeasonRankData");m(this,"replaceStringVariables");m(this,"getMilestoneData");m(this,"getBounties");m(this,"getQuests");m(this,"getCharacterRecords");m(this,"destinyApiClient");this.destinyApiClient=u,this.getSeasonRankData=function(n,y,p){let o=n.characterProgression.progressions[y.seasonPassProgressionHash],c=n.characterProgression.progressions[p.prestigeProgressionHash],e=this.destinyApiClient.destinyDataDefinition.DestinyInventoryItemDefinition[y.artifactItemHash],i=o.level,a=o.nextLevelAt,g=o.progressToNextLevel;return o.level==o.levelCap&&(i+=c.level,a+=c.nextLevelAt,g+=c.progressToNextLevel),{name:`Season Rank ${i}`,description:y.displayProperties.name,icon:`${e.displayProperties.icon}`,startDate:y.startDate,endDate:y.endDate,nextLevelAt:a,progressToNextLevel:g,type:"seasonrank",order:-1,inProgressValueStyle:0,completedValueStyle:0}},this.replaceStringVariables=function(n,y){if(!n||n.indexOf("{var:")===-1)return n;var p=/{var:(\d+)}/g,o=n.match(p);let c=n;if(o)for(var e=0;e<o.length;e++){var i=o[e],a=i.match(/\d+/);if(a){var g=a[0],P=y[g];P&&(c=c.replace(i,P))}}return c},this.getMilestoneData=function(n){let y=[],p=Object.keys(n.characterProgression.milestones);for(let o of p){let c=n.characterProgression.milestones[o],e={name:this.replaceStringVariables(c.milestoneName,n.profileStringVariables.integerValuesByHash),description:this.replaceStringVariables(c.milestoneDescription,n.profileStringVariables.integerValuesByHash),order:c.order,icon:c.milestoneIcon,type:"milestone",inProgressValueStyle:0,completedValueStyle:0};if(c.startDate&&(e.startDate=c.startDate),c.endDate&&(e.endDate=c.endDate),c.availableQuests&&c.availableQuests.length>0){for(let i of c.availableQuests)if(i.tracked&&(e.tracked=!0),i.status.started&&!i.status.completed&&i.status.stepObjectives&&i.status.stepObjectives.length>0){for(let a of i.status.stepObjectives)if(!a.complete){typeof a.progress<"u"&&(e.progressToNextLevel=a.progress),typeof a.completionValue<"u"&&(e.nextLevelAt=a.completionValue),typeof a.objectiveInProgressValueStyle<"u"&&(e.inProgressValueStyle=a.objectiveInProgressValueStyle),typeof a.objectiveCompletedValueStyle<"u"&&(e.completedValueStyle=a.objectiveCompletedValueStyle),(e.icon??"").length==0&&typeof a.activityIcon<"u"&&(e.icon=a.activityIcon);break}}}if(c.activities&&c.activities.length>0)for(let i of c.activities){if(i.challenges&&i.challenges.length>0){for(let a of i.challenges)if(!a.objective.complete){typeof a.objective.progress<"u"&&(e.progressToNextLevel=a.objective.progress),typeof a.objectiveInProgressValueStyle<"u"&&(e.inProgressValueStyle=a.objectiveInProgressValueStyle),typeof a.objectiveCompletedValueStyle<"u"&&(e.completedValueStyle=a.objectiveCompletedValueStyle),typeof a.objective.completionValue<"u"&&(e.nextLevelAt=a.objective.completionValue);break}}break}y.push(e)}return y};const v=26;this.getBounties=function(n){let y=[];var p=n.characterInventory.filter(o=>o.inventoryitemItemType===v);for(let o of p){let e=n.itemComponents.objectives.data[o.itemInstanceId].objectives.filter(i=>!i.complete);if(e.length!==0)for(let i of e){let a={name:this.replaceStringVariables(o.inventoryitemName,n.profileStringVariables.integerValuesByHash),description:this.replaceStringVariables(o.inventoryitemDescription,n.profileStringVariables.integerValuesByHash),order:500,icon:o.inventoryitemIcon,type:"bounty",inProgressValueStyle:0,completedValueStyle:0,tracked:(o.state&x.Tracked)==x.Tracked,state:o.state};typeof o.expirationDate<"u"&&(a.endDate=o.expirationDate,new Date(o.expirationDate).getTime()<new Date().getTime())||typeof i.completionValue<"u"&&(a.nextLevelAt=i.completionValue,typeof i.objectiveInProgressValueStyle<"u"&&(a.inProgressValueStyle=i.objectiveInProgressValueStyle),typeof i.objectiveCompletedValueStyle<"u"&&(a.completedValueStyle=i.objectiveCompletedValueStyle),typeof i.progress<"u"&&(a.progressToNextLevel=i.progress),typeof i.objectiveProgressDescription<"u"&&(a.description=this.replaceStringVariables(i.objectiveProgressDescription,n.profileStringVariables.integerValuesByHash)),y.push(a))}}return y};const r=1345459588;return this.getQuests=function(n){let y=[];var p=n.characterInventory.filter(e=>e.bucketHash===r&&[v].filter(i=>i!=e.inventoryitemItemType).length>0);let o=p.filter(e=>typeof e.itemInstanceId<"u"),c=p.filter(e=>typeof e.itemInstanceId>"u");for(let e of o){let i=n.itemComponents.objectives.data[e.itemInstanceId];if(i){const a=i.objectives.filter(g=>g.visible&&!g.complete);for(let g of a){let P={name:this.replaceStringVariables(e.inventoryitemName,n.profileStringVariables.integerValuesByHash),description:this.replaceStringVariables(e.inventoryitemDescription,n.profileStringVariables.integerValuesByHash),order:1e3,icon:e.inventoryitemIcon,type:"quest",inProgressValueStyle:0,completedValueStyle:0,tracked:(e.state&x.Tracked)==x.Tracked,state:e.state};typeof g.completionValue<"u"&&(P.nextLevelAt=g.completionValue,typeof g.objectiveInProgressValueStyle<"u"&&(P.inProgressValueStyle=g.objectiveInProgressValueStyle),typeof g.objectiveCompletedValueStyle<"u"&&(P.completedValueStyle=g.objectiveCompletedValueStyle),typeof g.progress<"u"&&(P.progressToNextLevel=g.progress),typeof g.objectiveProgressDescription<"u"&&(P.description=this.replaceStringVariables(g.objectiveProgressDescription,n.profileStringVariables.integerValuesByHash)),y.push(P))}}}for(let e of c){let i=(n.characterProgression.uninstancedItemObjectives[e.itemHash]??[]).filter(a=>a.visible&&!a.complete);for(let a of i){let g={name:this.replaceStringVariables(e.inventoryitemName,n.profileStringVariables.integerValuesByHash),description:this.replaceStringVariables(e.inventoryitemDescription,n.profileStringVariables.integerValuesByHash),order:1e4,icon:e.inventoryitemIcon,type:"quest",inProgressValueStyle:0,completedValueStyle:0,tracked:(e.state&x.Tracked)==x.Tracked,state:e.state};typeof a.completionValue<"u"&&(g.nextLevelAt=a.completionValue,typeof a.objectiveInProgressValueStyle<"u"&&(g.inProgressValueStyle=a.objectiveInProgressValueStyle),typeof a.objectiveCompletedValueStyle<"u"&&(g.completedValueStyle=a.objectiveCompletedValueStyle),typeof a.progress<"u"&&(g.progressToNextLevel=a.progress),typeof a.objectiveProgressDescription<"u"&&(g.description=this.replaceStringVariables(a.objectiveProgressDescription,n.profileStringVariables.integerValuesByHash)),y.push(g))}}return y},this.getCharacterRecords=function(n){let y=[],p=Object.keys(n.characterRecords.records);for(let o of p){let c=n.characterRecords.records[o];if(typeof c.objectives>"u"||(c.recordName??"").length===0)continue;let e=c.objectives.filter(i=>i.visible&&!i.complete);for(let i of e){let a={name:c.recordName,type:"characterRecord",order:100,icon:c.recordIcon,description:`${i.objectiveProgressDescription??""}`,progressToNextLevel:i.progress,nextLevelAt:i.completionValue,inProgressValueStyle:i.objectiveInProgressValueStyle,completedValueStyle:i.objectiveCompletedValueStyle,state:c.state};y.push(a)}}return y},this}}class he{constructor(u,v){m(this,"checkIfAuthenticated");m(this,"getToken");m(this,"refreshToken");m(this,"checkManifestVersion");m(this,"checkStoredDefinitions");m(this,"loadDestinyContentData");m(this,"loadDataFromStorage");m(this,"getManifest");m(this,"loadCommonSettings");m(this,"getUserToken");m(this,"getLinkedProfiles");m(this,"getUserProfile");m(this,"getLastPlayedCharacter");m(this,"getNamedDataObject");m(this,"getPresentationNodeFromHash");m(this,"mapHashesToDefinitionsInObject");m(this,"getTrackableData");m(this,"apiToken");m(this,"applicationName");m(this,"cachedManifest");m(this,"destinyDataDefinition");m(this,"lastVersion");m(this,"profile");m(this,"linkedProfiles");m(this,"trackedGoals");m(this,"goalApi");i("Initializing");const r=window.db,n=window.eventEmitter,y="https://o2g.itssimple.se",p="https://www.bungie.net",o="https://www.bungie.net/Platform",c=["DestinyActivityTypeDefinition","DestinyActivityDefinition","DestinyArtifactDefinition","DestinyChecklistDefinition","DestinyClassDefinition","DestinyDestinationDefinition","DestinyDamageTypeDefinition","DestinyFactionDefinition","DestinyGenderDefinition","DestinyItemCategoryDefinition","DestinyItemTierTypeDefinition","DestinyInventoryBucketDefinition","DestinyInventoryItemDefinition","DestinyMedalTierDefinition","DestinyMetricDefinition","DestinyMilestoneDefinition","DestinyObjectiveDefinition","DestinyPlaceDefinition","DestinyPresentationNodeDefinition","DestinyProgressionDefinition","DestinyRaceDefinition","DestinyRecordDefinition","DestinySeasonDefinition","DestinySeasonPassDefinition","DestinyStatDefinition","DestinyTraitDefinition"],e={None:0,Profiles:100,VendorReceipts:101,ProfileInventories:102,ProfileCurrencies:103,ProfileProgression:104,PlatformSilver:105,Characters:200,CharacterInventories:201,CharacterProgressions:202,CharacterRenderData:203,CharacterActivities:204,CharacterEquipment:205,ItemInstances:300,ItemObjectives:301,ItemPerks:302,ItemRenderData:303,ItemStats:304,ItemSockets:305,ItemTalentGrids:306,ItemCommonData:307,ItemPlugStates:308,ItemPlugObjectives:309,ItemReusablePlugs:310,Vendors:400,VendorCategories:401,VendorSales:402,Kiosks:500,CurrencyLookups:600,PresentationNodes:700,Collectibles:800,Records:900,Transitory:1e3,Metrics:1100,StringVariables:1200};this.lastVersion=null,this.applicationName=v,this.apiToken=u,this.destinyDataDefinition={},this.trackedGoals=[];function i(...d){V("D2API",d)}async function a(d,t,s=null,b=null){let l={};return(s!==null||b!==null)&&(l["Content-Type"]="application/json",l["x-api-key"]=h.apiToken,b!==null&&(l.authorization=`Bearer ${b}`)),s!==null?await fetch(t,{method:d,headers:l,body:s}):await fetch(t,{method:d,headers:l})}async function g(){await r.getItem("destinyTokenExpires")<Date.now()&&(i("Token expired, refreshing"),await h.refreshToken())}function P(d){if(d.error)return i("Error handling token",JSON.stringify(d)),r.removeItem("destinyToken"),r.removeItem("destinyRefreshToken"),r.removeItem("destinyTokenExpires"),r.removeItem("destinyRefreshTokenExpires"),r.removeItem("destinyBungieMembershipId"),!1;r.setItem("destinyToken",d.access_token),r.setItem("destinyRefreshToken",d.refresh_token);let t=Date.now()+d.expires_in*1e3;r.setItem("destinyTokenExpires",t);let s=Date.now()+d.refresh_expires_in*1e3;return r.setItem("destinyRefreshTokenExpires",s),r.setItem("destinyBungieMembershipId",d.membership_id),!0}this.loadDataFromStorage=async()=>{i("Loading data from storage");let d=await r.getItem("manifest");d!==null&&(h.cachedManifest=JSON.parse(d));let t=await r.getItem("manifestVersion");t!==null&&(h.lastVersion=t),h.checkStoredDefinitions();for(let l of c){let I=await r.getItem(`destinyContent-${l}`);I!==null&&(h.destinyDataDefinition[l]=JSON.parse(I))}let s=await r.getItem("destiny-profile");s!==null&&(h.profile=JSON.parse(s));let b=await r.getItem("destiny-linkedProfiles");b!==null&&(h.linkedProfiles=JSON.parse(b)),i("Data loaded from storage"),n.emit("destiny-data-loaded")},this.checkIfAuthenticated=async()=>{try{await g();const d=await r.getItem("destinyToken")!==null;return n.emit("destiny2:authenticated",d),d}catch(d){return i("Error checking if authenticated",d),n.emit("destiny2:authenticated",!1),!1}},this.getToken=async(d,t)=>{const s=await a("POST",`${y}/token/${h.applicationName}`,JSON.stringify({code:t}));if(s.status===200){let b=await s.json();return P(b)?n.emit("destiny2:auth-success"):n.emit("destiny2:auth-failed"),b}i("Error getting token",s.status,s.statusText,await s.text()),n.emit("destiny2:auth-failed")},this.refreshToken=async()=>{const d=await r.getItem("destinyRefreshToken");if(d==null)return n.emit("destiny2:refreshToken",null),null;const t=await a("POST",`${y}/refresh/${h.applicationName}`,JSON.stringify({refresh_token:d}));if(t.status===200){let s=await t.json();P(s)?n.emit("destiny2:refresh-success"):n.emit("destiny2:refresh-failed");return}else n.emit("destiny2:refresh-failed")},this.checkManifestVersion=async()=>(i("Checking manifest version"),new Promise(async function(d,t){let s=await h.getManifest();if(s==null)return i("Failed to fetch API"),null;let b=await r.getItem("manifestVersion")??"null";if(s.Response.version!==b){await r.removeItem("lastManifestUpdate"),await r.removeItem("manifest"),await r.removeItem("manifestVersion");for(let l of c)await r.removeItem(`destinyContent-${l}`);h.cachedManifest=s.Response,await r.setItem("manifestVersion",s.Response.version),await r.setItem("manifest",JSON.stringify(h.cachedManifest)),await r.setItem("lastManifestUpdate",Date.now()),d({updatedManifest:!0,version:h.lastVersion}),i("Manifest updated");return}h.cachedManifest=s.Response,d({updatedManifest:!1,version:h.lastVersion}),i("Manifest version is up to date")})),this.checkStoredDefinitions=async function(d=!0){let t=[];for(let s of c)await r.getItem(`destinyContent-${s}`)===null&&t.push(s);if(t.length>0&&d){for(let s of t)await r.removeItem(`destinyContent-${s}`);await h.loadDestinyContentData(t)}return t},this.loadDestinyContentData=async function(d=[]){for(let t of d)await j(t)};async function j(d){let t=h.cachedManifest;const s=d.replace("Destiny","").split(/(?=[A-Z])/).join(" ");n.emit("loading-text",`Loading ${s}`);const b=await a("GET",`${p}${t.jsonWorldComponentContentPaths.en[d]}`);b.headers.get("content-length");let l=0;const I=new Response(new ReadableStream({async start(C){const N=b.body.getReader();let k=0;for(;;){var L=await N.read();if(L.done)break;l+=L.value.byteLength,k++,k%30===0&&n.emit("loading-text",`Loading ${s} (${new Intl.NumberFormat("sv-SE").format(Math.round(l/1024/1024*100+Number.EPSILON)/100)} MB)`),C.enqueue(L.value)}n.emit("loading-text",`Loading ${s} (${new Intl.NumberFormat("sv-SE").format(Math.round(l/1024/1024*100+Number.EPSILON)/100)} MB)`),C.close()}}));if(b.status!==200){V("Manifest download error",await I.json());return}const w=await I.json();h.destinyDataDefinition[d]=w,r.setItem(`destinyContent-${d}`,JSON.stringify(w))}this.getManifest=async function(){let d=await r.getItem("lastManifestUpdate");if(i("Checking if manifest is cached"),d!==null&&Date.now()-d<6e4*60){let s=await r.getItem("manifest");if(s!==null)return i("Manifest is cached"),{Response:JSON.parse(s)}}let t=await a("GET",`${o}/Destiny2/Manifest/`);if(t.status===200){let s=await t.json();return s.ErrorStatus=="Success"?(r.setItem("lastManifestUpdate",Date.now()),r.setItem("manifest",JSON.stringify(s.Response)),i("Manifest updated from API"),{Response:s.Response}):(i("Manifesterror"),i(s.Response),null)}else{let s=t.json();return i("Error when fetching Manifest"),i(s),null}},this.loadCommonSettings=async function(){await g();const d=await a("GET",`${o}/Settings`,null,await this.getUserToken());return d.status===200?await d.json():(i("Error fetching common settings",d.status,d.statusText),null)},this.getUserToken=async function(){return await r.getItem("destinyToken")},this.getLinkedProfiles=async function(d=!1){return d&&(h.linkedProfiles=null),h.linkedProfiles!=null?h.linkedProfiles:(await g(),new Promise(async(t,s)=>{var b=await r.getItem("destinyBungieMembershipId");let l=await a("GET",`${o}/Destiny2/-1/Profile/${b}/LinkedProfiles/`,null,await this.getUserToken());if(l.status===200){let I=await l.json();r.setItem("destiny-linkedProfiles",JSON.stringify(I.Response)),h.linkedProfiles=I.Response,t(I.Response)}else h.refreshToken(),s(l)}))},this.getUserProfile=async function(d,t){let s=[e.Profiles,e.ProfileInventories,e.ProfileCurrencies,e.ProfileProgression,e.Characters,e.CharacterInventories,e.CharacterProgressions,e.CharacterActivities,e.CharacterEquipment,e.ItemInstances,e.ItemObjectives,e.ItemSockets,e.ItemTalentGrids,e.ItemCommonData,e.ItemPlugStates,e.ItemPlugObjectives,e.ItemReusablePlugs,e.Metrics,e.Records,e.Collectibles,e.StringVariables];return await g(),new Promise(async(b,l)=>{let I=await a("GET",`${o}/Destiny2/${t}/Profile/${d}/?components=${s.join(",")}`,null,await this.getUserToken());if(I.status===200){let w=await I.json();r.setItem("destiny-profile",JSON.stringify(w.Response)),h.profile=w.Response,b(w.Response)}else h.refreshToken(),l(I)})},this.getLastPlayedCharacter=async function(d=!1){await g();let t=h.profile;if(d&&(t=null),h.linkedProfiles===null)return null;if(await h.getLinkedProfiles(d),h.linkedProfiles!==null&&h.linkedProfiles.profiles!==null&&h.linkedProfiles.profiles.length>0){var s=h.linkedProfiles.profiles.sort((w,C)=>w.dateLastPlayed>C.dateLastPlayed?-1:1)[0];t=await h.getUserProfile(s.membershipId,s.membershipType)}let b=[];for(let w of t.profile.data.characterIds)b.push(t.characters.data[w]);let l=b.sort((w,C)=>w.dateLastPlayed>C.dateLastPlayed?-1:1)[0];return{characterInfo:l,characterProgression:t.characterProgressions.disabled?{}:t.characterProgressions.data[l.characterId],characterActivities:t.characterActivities.disabled?{}:t.characterActivities.data[l.characterId],characterUninstancedItemComponents:t.characterUninstancedItemComponents[l.characterId].objectives.data,characterInventory:t.characterInventories.data[l.characterId].items,characterEquipment:t.characterEquipment.data[l.characterId].items,characterPlugSets:t.characterPlugSets.disabled?{}:t.characterPlugSets.data[l.characterId].plugs,characterCollectibles:t.characterCollectibles.data[l.characterId].collectibles,characterRecords:t.characterRecords.data[l.characterId],characterStringVariables:t.characterStringVariables.data[l.characterId],profileProgression:t.profileProgression.data,metrics:t.metrics.data.metrics,itemComponents:t.itemComponents,records:t.profileRecords.data,profileInventory:t.profileInventory.data.items,profileCurrency:t.profileCurrencies.data.items,profilePlugSets:t.profilePlugSets.disabled?{}:t.profilePlugSets.data.plugs,profileCollectibles:t.profileCollectibles.data,profile:t.profile.data,profileStringVariables:t.profileStringVariables.data}},this.getNamedDataObject=async function(d=!1){let t=await h.getLastPlayedCharacter(d);if(t==null)return null;let s={...t};for(let l of Object.keys(s.characterInfo.stats))s.characterInfo.stats[l]={statValue:s.characterInfo.stats[l],statHash:l};for(let l of Object.keys(s.metrics))s.metrics[l]={...s.metrics[l],metricHash:l};for(let l of Object.keys(s.records.records))s.records.records[l]={...s.records.records[l],recordHash:l,parentNodeHashes:h.destinyDataDefinition.DestinyRecordDefinition[l].parentNodeHashes};for(let l of Object.keys(s.characterRecords.records))s.characterRecords.records[l]={...s.characterRecords.records[l],recordHash:l,parentNodeHashes:h.destinyDataDefinition.DestinyRecordDefinition[l].parentNodeHashes};return s=h.mapHashesToDefinitionsInObject(s),await r.getItem("destiny2-use-cachebreaker",!1)&&t.characterInventory.filter(I=>I.lockable&&I.inventoryitemItemType==3).length>0,n.emit("destiny2-api-update",s),s},this.getPresentationNodeFromHash=function(d){const t=[],s=h.destinyDataDefinition.DestinyPresentationNodeDefinition[d];if(s&&(t.unshift({name:s.displayProperties.name,description:s.displayProperties.description,icon:s.displayProperties.icon,hash:d}),s.parentNodeHashes))for(let b of s.parentNodeHashes){const l=h.getPresentationNodeFromHash(b);for(let I of l)t.push(I)}return t},this.mapHashesToDefinitionsInObject=function(d){let t={...d},s=Object.keys(t);for(let b of s){let l=typeof t[b],I=t[b];if(Array.isArray(I)){for(let w=0;w<I.length;w++){let C=I[w];typeof C=="object"?I[w]=h.mapHashesToDefinitionsInObject(C):I[w]=C}t[b]=I}else if(l==="object"&&I!==null)t[b]=h.mapHashesToDefinitionsInObject(t[b]);else{if(b.indexOf("Hash")>-1&&!Array.isArray(I)){let w=b.split("Hash")[0].replace("current","").toLowerCase();switch(w){case"item":case"plugitem":w="inventoryitem";break}let C=c.find(k=>k.toLowerCase()==`Destiny${w}Definition`.toLowerCase()),N=h.destinyDataDefinition[C];if(N&&N[I]&&N[I].displayProperties){const k=N[I];k.displayProperties.name&&k.displayProperties.name.length>0?t[`${w}Name`]=k.displayProperties.name:k.setData&&k.setData.questLineName&&k.setData.questLineName.length>0&&(t[`${w}Name`]=k.setData.questLineName),k.displayProperties.description&&k.displayProperties.description.length>0&&(t[`${w}Description`]=k.displayProperties.description),k.displayProperties.icon&&k.displayProperties.icon.length>0&&(t[`${w}Icon`]=k.displayProperties.icon),k.progressDescription&&k.progressDescription.length>0&&(t[`${w}ProgressDescription`]=k.progressDescription),typeof k.inProgressValueStyle<"u"&&(t[`${w}InProgressValueStyle`]=k.inProgressValueStyle),typeof k.completedValueStyle<"u"&&(t[`${w}CompletedValueStyle`]=k.completedValueStyle),typeof k.itemType<"u"&&(t[`${w}ItemType`]=k.itemType),typeof k.parentNodeHashes<"u"&&(t.parentNodeHashes=k.parentNodeHashes.map(L=>h.getPresentationNodeFromHash(L)))}}t[b]=I}}return t},this.getTrackableData=async function(d=!1){let t=await h.getNamedDataObject(d);if(t==null)return null;let s=h.destinyDataDefinition.DestinySeasonDefinition[t.profile.currentSeasonHash],b=h.destinyDataDefinition.DestinySeasonPassDefinition[s.seasonPassHash],l=[],I=h.goalApi.getMilestoneData(t);for(let S of I)l.push(S);let w=h.goalApi.getBounties(t);for(let S of w)l.push(S);let C=h.goalApi.getQuests(t);for(let S of C)l.push(S);let N=h.goalApi.getCharacterRecords(t);for(let S of N)l.push(S);function k(S,A){if(typeof S.nextLevelAt<"u"&&typeof A.nextLevelAt<"u"){let B=S.progressToNextLevel/S.nextLevelAt*100,q=A.progressToNextLevel/A.nextLevelAt*100;return B<q?1:-1}return typeof S.endDate<"u"?typeof A.endDate>"u"||S.endDate<A.endDate?-1:1:S.order<A.order?1:-1}const L=l.filter(S=>S.tracked).sort(k),H=l.filter(S=>S.endDate&&!S.tracked).sort(k),$=l.filter(S=>!S.endDate&&!S.tracked).sort(k);return l=[...L,...H,...$],l.unshift(h.goalApi.getSeasonRankData(t,s,b)),h.trackedGoals=l,n.emit("goal-list-update",l),l};let h=this;return this.goalApi=new pe(this),i("Initialized"),this}}V("MAIN","Starting app...");window.eventEmitter=new ue;window.db=new fe;window.apiClient=new he("5625a52ed6b54ecfb8246071cfcd6085","everversedata");function ye(){const f=E(!1),u=E(!1),v=E([]);return{isDataLoaded:f,isAuthenticated:u,goals:v}}const O=ye();window.appState=z(O);window.db.initializeDatabase().then(async()=>{V("MAIN","Database initialized, checking for updates..."),O.isAuthenticated.value=await window.apiClient.checkIfAuthenticated(),W(D(de,{}),document.getElementById("app"))});
//# sourceMappingURL=index-6584a70b.js.map
