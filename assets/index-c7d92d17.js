var U=Object.defineProperty;var G=(p,c,D)=>c in p?U(p,c,{enumerable:!0,configurable:!0,writable:!0,value:D}):p[c]=D;var y=(p,c,D)=>(G(p,typeof c!="symbol"?c+"":c,D),D);import{o as v,_ as N,R as F,q as K,D as Q,c as z,F as W,B as Y,d as M}from"./vendor-c23458f1.js";(function(){const c=document.createElement("link").relList;if(c&&c.supports&&c.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const m of n)if(m.type==="childList")for(const d of m.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&r(d)}).observe(document,{childList:!0,subtree:!0});function D(n){const m={};return n.integrity&&(m.integrity=n.integrity),n.referrerPolicy&&(m.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?m.credentials="include":n.crossOrigin==="anonymous"?m.credentials="omit":m.credentials="same-origin",m}function r(n){if(n.ep)return;n.ep=!0;const m=D(n);fetch(n.href,m)}})();function V(p,...c){console.log(`[${p}]`,JSON.stringify([...c]))}function Z(p){return p.isAuthenticated?(location.href="/#/logging-in",v(N,{})):v(N,{children:["Main page -"," ",v("a",{href:"https://o2g.itssimple.se/authenticate/everversedata?state=dataverse-"+new Date().getTime(),children:"Log in"})]})}function X(){const p=window.apiClient,c=F();V("Auth","Authenticated page, getting code",c);const r=new URL(c,location.origin).searchParams.get("code");return r?(p.getToken("",r).then(()=>{V("Auth","Got token, redirecting to dashboard"),location.href="/#/logging-in"}).catch(n=>{V("Auth","Failed to get token, redirecting to main page"),location.href="/"}),v(N,{children:"Authenticated, redirecting to Dashboard"})):(V("Auth","No code found, redirecting to main page"),location.href="/",v(N,{children:"Redirecting to main page"}))}function ee(p,c,D=!1){return!D&&!c?"Unknown, no end time":ie(ne(p,c))}function te(p,c,D){let r=[];return p>0&&r.push(`${p}d`),c>0&&r.push(`${c}h`),D>0&&r.push(`${D}m`),r.join(", ")}function ie(p){let{days:c,hours:D,minutes:r}=se(p);return te(c,D,r)}function ne(p,c){return c||(c=Date.now()),(c-p)/1e3}function se(p){let c=Math.floor(p/86400),D=Math.floor(p%(24*3600)/3600),r=Math.floor(p%3600/60),n=Math.floor(p%60);return{days:c,hours:D,minutes:r,seconds:n}}const H=new Intl.NumberFormat,ae="https://www.bungie.net";var O=15,x={milestones:!0,bounties:!0,quests:!0,records:!0,seasonRank:!0},A=[];function re(p){var f,i;const c=window.eventEmitter,D=window.db,r=window.apiClient;c.addEventListener("goal-list-update",d),c.addEventListener("tracked-items-changed",async()=>{x={milestones:JSON.parse(await D.getItem("d2-track-milestones")??!0),bounties:JSON.parse(await D.getItem("d2-track-bounties")??!0),quests:JSON.parse(await D.getItem("d2-track-quests")??!0),records:JSON.parse(await D.getItem("d2-track-records")??!0),seasonRank:JSON.parse(await D.getItem("d2-track-seasonrank")??!0)},A&&A.length>0&&d(A)}),c.addEventListener("visible-items-changed",e=>{O=e,A&&A.length>0&&d(A)}),async function(){await l(),await r.getTrackableData()}();function n(e){let s=null;switch(e.inProgressValueStyle===0&&e.nextLevelAt===1&&(e.inProgressValueStyle=2),e.inProgressValueStyle){case 2:s=v("span",{className:"goal-progress",children:e.progressToNextLevel==0?"Incomplete":"Complete"});break;case 3:let g=(e.progressToNextLevel/e.nextLevelAt*100).toFixed(0);s=v("span",{className:"goal-progress",children:[g," %"]});break;case 8:s="";break;case 12:s=v("span",{className:"goal-progress",children:[e.progressToNextLevel," %"]});break;case 6:default:s=v("span",{className:"goal-progress",children:[H.format(e.progressToNextLevel)," /"," ",H.format(e.nextLevelAt)]});break}return typeof e.nextLevelAt<"u"?v(N,{children:s}):null}function m(e){let s=typeof e.icon<"u"?v("img",{className:"goal-icon",src:`${ae}${e.icon}`}):null,g=typeof e.endDate<"u"?v(N,{children:[v("br",{}),v("i",{class:"fui body fiction goal-end",children:["Ends in ",ee(new Date,new Date(e.endDate))]})]}):null,S=n(e);return v("div",{className:"goal-item",children:[s,v("div",{className:"goal-body",children:[v("h5",{children:[e.name,S]}),e.description,g]})]})}async function d(e){let s=0,g=[];for(let S of e){if(O>0&&s>=O)break;let T=!0;switch(S.type){case"milestone":T=x.milestones;break;case"quest":T=x.quests;break;case"bounty":T=x.bounties;break;case"characterRecord":T=x.records;break;case"seasonrank":T=x.seasonRank;break}T&&(g.push(S),s++)}p.goals.value=g,A=e}async function l(){O=parseInt(await D.getItem("d2-visible-items")??0),x={milestones:JSON.parse(await D.getItem("d2-track-milestones")??!0),bounties:JSON.parse(await D.getItem("d2-track-bounties")??!0),quests:JSON.parse(await D.getItem("d2-track-quests")??!0),records:JSON.parse(await D.getItem("d2-track-records")??!0),seasonRank:JSON.parse(await D.getItem("d2-track-seasonrank")??!0)}}return v("div",{className:"goal-container",children:((i=(f=p.goals)==null?void 0:f.value)==null?void 0:i.length)>0?p.goals.value.map(e=>m(e)):v(N,{children:"Loading ..."})})}function oe(p){const c=window.apiClient;return!p.isAuthenticated.value||!p.isDataLoaded.value?(location.href="/",v(N,{})):(c.profile.profile,v(N,{children:v(re,{...p})}))}function le(){return v("footer",{className:"fui body fiction",children:["Â© 2023",new Date().getUTCFullYear()!=2023?" - "+new Date().getUTCFullYear():null," ","NoLifeKing85#2914"]})}function ce(p){const c=window.apiClient,D=window.eventEmitter;D.addEventListener("loading-text",n=>{n&&r(n)});function r(n){let m=document.getElementById("loading-text");m&&(m.innerText=n)}return c.checkIfAuthenticated().then(async n=>{if(!n){location.href="/";return}V("LOGIN","Authenticated, checking manifests"),r("Checking manifest ...");let m=await c.checkManifestVersion();if(m==null){r("Something is wrong with Destiny 2 (or this app), please reload the page.");return}V("LOGIN",m),r("Loading profile data"),await c.getLastPlayedCharacter(),r("Checking for missing definitions");let d=await c.checkStoredDefinitions(!1);d.length>0&&(r(`Downloading ${d.length} missing definition(s)`),await c.checkStoredDefinitions(!0)),r("Loading data..."),await c.loadDataFromStorage(),p.isDataLoaded.value=!0,setTimeout(()=>{r("Opening application..."),D.emit("manifests-loaded"),setTimeout(()=>{location.href="/#/dashboard"},1e3)},1e3)}),v(N,{children:v("span",{class:"fui body",id:"loading-text",children:"Logging in and loading data ..."})})}function de(){return v("header",{className:"header subscreen",children:"Dataverse"})}function fe(){const p=K(window.appState);return v(N,{children:[v(de,{}),v("div",{class:"app",children:v(Q,{history:z(),children:[v(N,{path:"/",children:v(Z,{...p})}),v(N,{path:"/authenticated",children:v(X,{})}),v(N,{path:"/logging-in",children:v(ce,{...p})}),v(N,{path:"/dashboard",children:v(oe,{...p})})]})}),v(le,{})]})}class ue{constructor(){y(this,"DBInstance");y(this,"initializeDatabase");y(this,"setItem");y(this,"setItems");y(this,"getItem");y(this,"removeItem");y(this,"setStorageItem");y(this,"setStorageItems");y(this,"getStorageItem");y(this,"getStorageItems");y(this,"removeStorageItem");this.DBInstance=null,this.initializeDatabase=async function(){return new Promise((d,l)=>{let f=window.indexedDB.open("destiny2-dataverse",2);f.onupgradeneeded=function(i){const e=f.result;V("DB","Old",i.oldVersion,"New",i.newVersion),i.oldVersion<1&&(V("DB","Creating first version of database, since it never existed on this installation."),e.createObjectStore("storage",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key")),i.oldVersion<2&&(V("DB","Creating object store for player/character activity"),e.createObjectStore("playerActivity",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"),e.createObjectStore("activityDetails",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"))},f.onsuccess=function(i){V("DB","Loaded database"),m.DBInstance=i.target.result,d()},f.onerror=function(i){V("DB","Failed to load database"),l(i)}})};async function c(d,l,f){return new Promise((i,e)=>{const S=m.DBInstance.transaction(d,"readwrite").objectStore(d).put({key:l,value:f});S.onsuccess=function(){i()},S.onerror=function(T){e(T)}})}async function D(d,l=null){return new Promise((f,i)=>{const g=m.DBInstance.transaction(d,"readonly").objectStore(d).getAll();g.onsuccess=function(){const S=g.result;f(l?S.filter(l):S)},g.onerror=function(S){i(S)}})}async function r(d,l,f=null){return new Promise((i,e)=>{const S=m.DBInstance.transaction(d,"readonly").objectStore(d).get(l);S.onsuccess=function(T){T.target.result?i(T.target.result.value):i(f)},S.onerror=function(T){e(T)}})}async function n(d,l){return new Promise((f,i)=>{const g=m.DBInstance.transaction(d,"readwrite").objectStore(d).delete(l);g.onsuccess=function(){f()},g.onerror=function(S){i(S)}})}this.setItem=async function(d,l){return await c("storage",d,l)},this.setItems=async function(d){for(let l of d)await c("storage",l.key,l.value)},this.getItem=async function(d,l=null){return await r("storage",d,l)},this.removeItem=async function(d){return await n("storage",d)},this.setStorageItem=async function(d,l,f){return await c(d,l,f)},this.setStorageItems=async function(d,l){for(let f of l)await c(d,f.key,f.value)},this.getStorageItem=async function(d,l,f=null){return await r(d,l,f)},this.getStorageItems=async function(d,l=null){return await D(d,l)},this.removeStorageItem=async function(d,l){return await n(d,l)};var m=this;return this}}class pe{constructor(){y(this,"eventListeners");y(this,"addEventListener");y(this,"emit");return this.eventListeners=[],this.addEventListener=function(c,D){V("EVENT:REGISTERED",c),this.eventListeners.push({eventName:c,handler:D})},this.emit=async function(c,...D){return JSON.parse(await window.db.getItem("d2-debugmode")??"false")?V("EVENT:EMITTING",c,...D):V("EVENT:EMITTING",c),new Promise((n,m)=>{this.eventListeners.filter(d=>d.eventName==c).forEach(async d=>{try{await d.handler(...D)}catch(l){V("EVENT:ERROR",c,l),console.error(l),m(l)}}),n(!0)})},V("EventEmitter","Initialized"),this}}var R=(p=>(p[p.None=0]="None",p[p.Locked=1]="Locked",p[p.Tracked=2]="Tracked",p[p.Masterwork=4]="Masterwork",p[p.Crafted=8]="Crafted",p[p.HighlightedObjective=16]="HighlightedObjective",p))(R||{});class he{constructor(c){y(this,"getSeasonRankData");y(this,"replaceStringVariables");y(this,"getMilestoneData");y(this,"getBounties");y(this,"getQuests");y(this,"getCharacterRecords");y(this,"destinyApiClient");this.destinyApiClient=c,this.getSeasonRankData=function(n,m,d){let l=n.characterProgression.progressions[m.seasonPassProgressionHash],f=n.characterProgression.progressions[d.prestigeProgressionHash],i=this.destinyApiClient.destinyDataDefinition.DestinyInventoryItemDefinition[m.artifactItemHash],e=l.level,s=l.nextLevelAt,g=l.progressToNextLevel;return l.level==l.levelCap&&(e+=f.level,s+=f.nextLevelAt,g+=f.progressToNextLevel),{name:`Season Rank ${e}`,description:m.displayProperties.name,icon:`${i.displayProperties.icon}`,startDate:m.startDate,endDate:m.endDate,nextLevelAt:s,progressToNextLevel:g,type:"seasonrank",order:-1,inProgressValueStyle:0,completedValueStyle:0}},this.replaceStringVariables=function(n,m){if(!n||n.indexOf("{var:")===-1)return n;var d=/{var:(\d+)}/g,l=n.match(d);let f=n;if(l)for(var i=0;i<l.length;i++){var e=l[i],s=e.match(/\d+/);if(s){var g=s[0],S=m[g];S&&(f=f.replace(e,S))}}return f},this.getMilestoneData=function(n){let m=[],d=Object.keys(n.characterProgression.milestones);for(let l of d){let f=n.characterProgression.milestones[l],i={name:this.replaceStringVariables(f.milestoneName,n.profileStringVariables.integerValuesByHash),description:this.replaceStringVariables(f.milestoneDescription,n.profileStringVariables.integerValuesByHash),order:f.order,icon:f.milestoneIcon,type:"milestone",inProgressValueStyle:0,completedValueStyle:0};if(f.startDate&&(i.startDate=f.startDate),f.endDate&&(i.endDate=f.endDate),f.availableQuests&&f.availableQuests.length>0){for(let e of f.availableQuests)if(e.tracked&&(i.tracked=!0),e.status.started&&!e.status.completed&&e.status.stepObjectives&&e.status.stepObjectives.length>0){for(let s of e.status.stepObjectives)if(!s.complete){typeof s.progress<"u"&&(i.progressToNextLevel=s.progress),typeof s.completionValue<"u"&&(i.nextLevelAt=s.completionValue),typeof s.objectiveInProgressValueStyle<"u"&&(i.inProgressValueStyle=s.objectiveInProgressValueStyle),typeof s.objectiveCompletedValueStyle<"u"&&(i.completedValueStyle=s.objectiveCompletedValueStyle),(i.icon??"").length==0&&typeof s.activityIcon<"u"&&(i.icon=s.activityIcon);break}}}if(f.activities&&f.activities.length>0)for(let e of f.activities){if(e.challenges&&e.challenges.length>0){for(let s of e.challenges)if(!s.objective.complete){typeof s.objective.progress<"u"&&(i.progressToNextLevel=s.objective.progress),typeof s.objectiveInProgressValueStyle<"u"&&(i.inProgressValueStyle=s.objectiveInProgressValueStyle),typeof s.objectiveCompletedValueStyle<"u"&&(i.completedValueStyle=s.objectiveCompletedValueStyle),typeof s.objective.completionValue<"u"&&(i.nextLevelAt=s.objective.completionValue);break}}break}m.push(i)}return m};const D=26;this.getBounties=function(n){let m=[];var d=n.characterInventory.filter(l=>l.inventoryitemItemType===D);for(let l of d){let i=n.itemComponents.objectives.data[l.itemInstanceId].objectives.filter(e=>!e.complete);if(i.length!==0)for(let e of i){let s={name:this.replaceStringVariables(l.inventoryitemName,n.profileStringVariables.integerValuesByHash),description:this.replaceStringVariables(l.inventoryitemDescription,n.profileStringVariables.integerValuesByHash),order:500,icon:l.inventoryitemIcon,type:"bounty",inProgressValueStyle:0,completedValueStyle:0,tracked:(l.state&R.Tracked)==R.Tracked,state:l.state};typeof l.expirationDate<"u"&&(s.endDate=l.expirationDate,new Date(l.expirationDate).getTime()<new Date().getTime())||typeof e.completionValue<"u"&&(s.nextLevelAt=e.completionValue,typeof e.objectiveInProgressValueStyle<"u"&&(s.inProgressValueStyle=e.objectiveInProgressValueStyle),typeof e.objectiveCompletedValueStyle<"u"&&(s.completedValueStyle=e.objectiveCompletedValueStyle),typeof e.progress<"u"&&(s.progressToNextLevel=e.progress),typeof e.objectiveProgressDescription<"u"&&(s.description=this.replaceStringVariables(e.objectiveProgressDescription,n.profileStringVariables.integerValuesByHash)),m.push(s))}}return m};const r=1345459588;return this.getQuests=function(n){let m=[];var d=n.characterInventory.filter(i=>i.bucketHash===r&&[D].filter(e=>e!=i.inventoryitemItemType).length>0);let l=d.filter(i=>typeof i.itemInstanceId<"u"),f=d.filter(i=>typeof i.itemInstanceId>"u");for(let i of l){let e=n.itemComponents.objectives.data[i.itemInstanceId];if(e){const s=e.objectives.filter(g=>g.visible&&!g.complete);for(let g of s){let S={name:this.replaceStringVariables(i.inventoryitemName,n.profileStringVariables.integerValuesByHash),description:this.replaceStringVariables(i.inventoryitemDescription,n.profileStringVariables.integerValuesByHash),order:1e3,icon:i.inventoryitemIcon,type:"quest",inProgressValueStyle:0,completedValueStyle:0,tracked:(i.state&R.Tracked)==R.Tracked,state:i.state};typeof g.completionValue<"u"&&(S.nextLevelAt=g.completionValue,typeof g.objectiveInProgressValueStyle<"u"&&(S.inProgressValueStyle=g.objectiveInProgressValueStyle),typeof g.objectiveCompletedValueStyle<"u"&&(S.completedValueStyle=g.objectiveCompletedValueStyle),typeof g.progress<"u"&&(S.progressToNextLevel=g.progress),typeof g.objectiveProgressDescription<"u"&&(S.description=this.replaceStringVariables(g.objectiveProgressDescription,n.profileStringVariables.integerValuesByHash)),m.push(S))}}}for(let i of f){let e=(n.characterProgression.uninstancedItemObjectives[i.itemHash]??[]).filter(s=>s.visible&&!s.complete);for(let s of e){let g={name:this.replaceStringVariables(i.inventoryitemName,n.profileStringVariables.integerValuesByHash),description:this.replaceStringVariables(i.inventoryitemDescription,n.profileStringVariables.integerValuesByHash),order:1e4,icon:i.inventoryitemIcon,type:"quest",inProgressValueStyle:0,completedValueStyle:0,tracked:(i.state&R.Tracked)==R.Tracked,state:i.state};typeof s.completionValue<"u"&&(g.nextLevelAt=s.completionValue,typeof s.objectiveInProgressValueStyle<"u"&&(g.inProgressValueStyle=s.objectiveInProgressValueStyle),typeof s.objectiveCompletedValueStyle<"u"&&(g.completedValueStyle=s.objectiveCompletedValueStyle),typeof s.progress<"u"&&(g.progressToNextLevel=s.progress),typeof s.objectiveProgressDescription<"u"&&(g.description=this.replaceStringVariables(s.objectiveProgressDescription,n.profileStringVariables.integerValuesByHash)),m.push(g))}}return m},this.getCharacterRecords=function(n){let m=[],d=Object.keys(n.characterRecords.records);for(let l of d){let f=n.characterRecords.records[l];if(typeof f.objectives>"u"||(f.recordName??"").length===0)continue;let i=f.objectives.filter(e=>e.visible&&!e.complete);for(let e of i){let s={name:f.recordName,type:"characterRecord",order:100,icon:f.recordIcon,description:`${e.objectiveProgressDescription??""}`,progressToNextLevel:e.progress,nextLevelAt:e.completionValue,inProgressValueStyle:e.objectiveInProgressValueStyle,completedValueStyle:e.objectiveCompletedValueStyle,state:f.state};m.push(s)}}return m},this}}class me{constructor(c,D){y(this,"checkIfAuthenticated");y(this,"getToken");y(this,"refreshToken");y(this,"checkManifestVersion");y(this,"checkStoredDefinitions");y(this,"loadDestinyContentData");y(this,"loadDataFromStorage");y(this,"getManifest");y(this,"loadCommonSettings");y(this,"getUserToken");y(this,"getLinkedProfiles");y(this,"getUserProfile");y(this,"getLastPlayedCharacter");y(this,"getNamedDataObject");y(this,"getPresentationNodeFromHash");y(this,"mapHashesToDefinitionsInObject");y(this,"getTrackableData");y(this,"apiToken");y(this,"applicationName");y(this,"cachedManifest");y(this,"destinyDataDefinition");y(this,"lastVersion");y(this,"profile");y(this,"linkedProfiles");y(this,"trackedGoals");y(this,"goalApi");e("Initializing");const r=window.db,n=window.eventEmitter,m="https://o2g.itssimple.se",d="https://www.bungie.net",l="https://www.bungie.net/Platform",f=["DestinyActivityTypeDefinition","DestinyActivityDefinition","DestinyArtifactDefinition","DestinyChecklistDefinition","DestinyClassDefinition","DestinyDestinationDefinition","DestinyDamageTypeDefinition","DestinyFactionDefinition","DestinyGenderDefinition","DestinyItemCategoryDefinition","DestinyItemTierTypeDefinition","DestinyInventoryBucketDefinition","DestinyInventoryItemDefinition","DestinyMedalTierDefinition","DestinyMetricDefinition","DestinyMilestoneDefinition","DestinyObjectiveDefinition","DestinyPlaceDefinition","DestinyPresentationNodeDefinition","DestinyProgressionDefinition","DestinyRaceDefinition","DestinyRecordDefinition","DestinySeasonDefinition","DestinySeasonPassDefinition","DestinyStatDefinition","DestinyTraitDefinition"],i={None:0,Profiles:100,VendorReceipts:101,ProfileInventories:102,ProfileCurrencies:103,ProfileProgression:104,PlatformSilver:105,Characters:200,CharacterInventories:201,CharacterProgressions:202,CharacterRenderData:203,CharacterActivities:204,CharacterEquipment:205,ItemInstances:300,ItemObjectives:301,ItemPerks:302,ItemRenderData:303,ItemStats:304,ItemSockets:305,ItemTalentGrids:306,ItemCommonData:307,ItemPlugStates:308,ItemPlugObjectives:309,ItemReusablePlugs:310,Vendors:400,VendorCategories:401,VendorSales:402,Kiosks:500,CurrencyLookups:600,PresentationNodes:700,Collectibles:800,Records:900,Transitory:1e3,Metrics:1100,StringVariables:1200};this.lastVersion=null,this.applicationName=D,this.apiToken=c,this.destinyDataDefinition={},this.trackedGoals=[];function e(...u){V("D2API",u)}async function s(u,t,a=null,b=null){let o={};return(a!==null||b!==null)&&(o["Content-Type"]="application/json",o["x-api-key"]=h.apiToken,b!==null&&(o.authorization=`Bearer ${b}`)),a!==null?await fetch(t,{method:u,headers:o,body:a}):await fetch(t,{method:u,headers:o})}async function g(){await r.getItem("destinyTokenExpires")<Date.now()&&(e("Token expired, refreshing"),await h.refreshToken())}function S(u){if(u.error)return e("Error handling token",JSON.stringify(u)),r.removeItem("destinyToken"),r.removeItem("destinyRefreshToken"),r.removeItem("destinyTokenExpires"),r.removeItem("destinyRefreshTokenExpires"),r.removeItem("destinyBungieMembershipId"),!1;r.setItem("destinyToken",u.access_token),r.setItem("destinyRefreshToken",u.refresh_token);let t=Date.now()+u.expires_in*1e3;r.setItem("destinyTokenExpires",t);let a=Date.now()+u.refresh_expires_in*1e3;return r.setItem("destinyRefreshTokenExpires",a),r.setItem("destinyBungieMembershipId",u.membership_id),!0}this.loadDataFromStorage=async()=>{e("Loading data from storage");let u=await r.getItem("manifest");u!==null&&(h.cachedManifest=JSON.parse(u));let t=await r.getItem("manifestVersion");t!==null&&(h.lastVersion=t),h.checkStoredDefinitions();for(let o of f){let I=await r.getItem(`destinyContent-${o}`);I!==null&&(h.destinyDataDefinition[o]=JSON.parse(I))}let a=await r.getItem("destiny-profile");a!==null&&(h.profile=JSON.parse(a));let b=await r.getItem("destiny-linkedProfiles");b!==null&&(h.linkedProfiles=JSON.parse(b)),e("Data loaded from storage"),n.emit("destiny-data-loaded")},this.checkIfAuthenticated=async()=>{try{await g();const u=await r.getItem("destinyToken")!==null;return n.emit("destiny2:authenticated",u),u}catch(u){return e("Error checking if authenticated",u),n.emit("destiny2:authenticated",!1),!1}},this.getToken=async(u,t)=>{const a=await s("POST",`${m}/token/${h.applicationName}`,JSON.stringify({code:t}));if(a.status===200){let b=await a.json();return S(b)?n.emit("destiny2:auth-success"):n.emit("destiny2:auth-failed"),b}e("Error getting token",a.status,a.statusText,await a.text()),n.emit("destiny2:auth-failed")},this.refreshToken=async()=>{const u=await r.getItem("destinyRefreshToken");if(u==null)return n.emit("destiny2:refreshToken",null),null;const t=await s("POST",`${m}/refresh/${h.applicationName}`,JSON.stringify({refresh_token:u}));if(t.status===200){let a=await t.json();S(a)?n.emit("destiny2:refresh-success"):n.emit("destiny2:refresh-failed");return}else n.emit("destiny2:refresh-failed")},this.checkManifestVersion=async()=>(e("Checking manifest version"),new Promise(async function(u,t){let a=await h.getManifest();if(a==null)return e("Failed to fetch API"),null;let b=await r.getItem("manifestVersion")??"null";if(a.Response.version!==b){await r.removeItem("lastManifestUpdate"),await r.removeItem("manifest"),await r.removeItem("manifestVersion");for(let o of f)await r.removeItem(`destinyContent-${o}`);h.cachedManifest=a.Response,await r.setItem("manifestVersion",a.Response.version),await r.setItem("manifest",JSON.stringify(h.cachedManifest)),await r.setItem("lastManifestUpdate",Date.now()),u({updatedManifest:!0,version:h.lastVersion}),e("Manifest updated");return}h.cachedManifest=a.Response,u({updatedManifest:!1,version:h.lastVersion}),e("Manifest version is up to date")})),this.checkStoredDefinitions=async function(u=!0){let t=[];for(let a of f)await r.getItem(`destinyContent-${a}`)===null&&t.push(a);if(t.length>0&&u){for(let a of t)await r.removeItem(`destinyContent-${a}`);await h.loadDestinyContentData(t)}return t},this.loadDestinyContentData=async function(u=[]){for(let t of u)await T(t)};async function T(u){let t=h.cachedManifest;const a=u.replace("Destiny","").split(/(?=[A-Z])/).join(" ");n.emit("loading-text",`Loading ${a}`);const b=await s("GET",`${d}${t.jsonWorldComponentContentPaths.en[u]}`);b.headers.get("content-length");let o=0;const I=new Response(new ReadableStream({async start(C){const j=b.body.getReader();let k=0;for(;;){var L=await j.read();if(L.done)break;o+=L.value.byteLength,k++,k%30===0&&n.emit("loading-text",`Loading ${a} (${new Intl.NumberFormat("sv-SE").format(Math.round(o/1024/1024*100+Number.EPSILON)/100)} MB)`),C.enqueue(L.value)}n.emit("loading-text",`Loading ${a} (${new Intl.NumberFormat("sv-SE").format(Math.round(o/1024/1024*100+Number.EPSILON)/100)} MB)`),C.close()}}));if(b.status!==200){V("Manifest download error",await I.json());return}const w=await I.json();h.destinyDataDefinition[u]=w,r.setItem(`destinyContent-${u}`,JSON.stringify(w))}this.getManifest=async function(){let u=await r.getItem("lastManifestUpdate");if(e("Checking if manifest is cached"),u!==null&&Date.now()-u<6e4*60){let a=await r.getItem("manifest");if(a!==null)return e("Manifest is cached"),{Response:JSON.parse(a)}}let t=await s("GET",`${l}/Destiny2/Manifest/`);if(t.status===200){let a=await t.json();return a.ErrorStatus=="Success"?(r.setItem("lastManifestUpdate",Date.now()),r.setItem("manifest",JSON.stringify(a.Response)),e("Manifest updated from API"),{Response:a.Response}):(e("Manifesterror"),e(a.Response),null)}else{let a=t.json();return e("Error when fetching Manifest"),e(a),null}},this.loadCommonSettings=async function(){await g();const u=await s("GET",`${l}/Settings`,null,await this.getUserToken());return u.status===200?await u.json():(e("Error fetching common settings",u.status,u.statusText),null)},this.getUserToken=async function(){return await r.getItem("destinyToken")},this.getLinkedProfiles=async function(u=!1){return u&&(h.linkedProfiles=null),h.linkedProfiles!=null?h.linkedProfiles:(await g(),new Promise(async(t,a)=>{var b=await r.getItem("destinyBungieMembershipId");let o=await s("GET",`${l}/Destiny2/-1/Profile/${b}/LinkedProfiles/`,null,await this.getUserToken());if(o.status===200){let I=await o.json();r.setItem("destiny-linkedProfiles",JSON.stringify(I.Response)),h.linkedProfiles=I.Response,t(I.Response)}else h.refreshToken(),a(o)}))},this.getUserProfile=async function(u,t){let a=[i.Profiles,i.ProfileInventories,i.ProfileCurrencies,i.ProfileProgression,i.Characters,i.CharacterInventories,i.CharacterProgressions,i.CharacterActivities,i.CharacterEquipment,i.ItemInstances,i.ItemObjectives,i.ItemSockets,i.ItemTalentGrids,i.ItemCommonData,i.ItemPlugStates,i.ItemPlugObjectives,i.ItemReusablePlugs,i.Metrics,i.Records,i.Collectibles,i.StringVariables];return await g(),new Promise(async(b,o)=>{let I=await s("GET",`${l}/Destiny2/${t}/Profile/${u}/?components=${a.join(",")}`,null,await this.getUserToken());if(I.status===200){let w=await I.json();r.setItem("destiny-profile",JSON.stringify(w.Response)),h.profile=w.Response,b(w.Response)}else h.refreshToken(),o(I)})},this.getLastPlayedCharacter=async function(u=!1){await g();let t=h.profile;if(u&&(t=null),h.linkedProfiles===null)return null;if(await h.getLinkedProfiles(u),h.linkedProfiles!==null&&h.linkedProfiles.profiles!==null&&h.linkedProfiles.profiles.length>0){var a=h.linkedProfiles.profiles.sort((w,C)=>w.dateLastPlayed>C.dateLastPlayed?-1:1)[0];t=await h.getUserProfile(a.membershipId,a.membershipType)}let b=[];for(let w of t.profile.data.characterIds)b.push(t.characters.data[w]);let o=b.sort((w,C)=>w.dateLastPlayed>C.dateLastPlayed?-1:1)[0];return{characterInfo:o,characterProgression:t.characterProgressions.disabled?{}:t.characterProgressions.data[o.characterId],characterActivities:t.characterActivities.disabled?{}:t.characterActivities.data[o.characterId],characterUninstancedItemComponents:t.characterUninstancedItemComponents[o.characterId].objectives.data,characterInventory:t.characterInventories.data[o.characterId].items,characterEquipment:t.characterEquipment.data[o.characterId].items,characterPlugSets:t.characterPlugSets.disabled?{}:t.characterPlugSets.data[o.characterId].plugs,characterCollectibles:t.characterCollectibles.data[o.characterId].collectibles,characterRecords:t.characterRecords.data[o.characterId],characterStringVariables:t.characterStringVariables.data[o.characterId],profileProgression:t.profileProgression.data,metrics:t.metrics.data.metrics,itemComponents:t.itemComponents,records:t.profileRecords.data,profileInventory:t.profileInventory.data.items,profileCurrency:t.profileCurrencies.data.items,profilePlugSets:t.profilePlugSets.disabled?{}:t.profilePlugSets.data.plugs,profileCollectibles:t.profileCollectibles.data,profile:t.profile.data,profileStringVariables:t.profileStringVariables.data}},this.getNamedDataObject=async function(u=!1){let t=await h.getLastPlayedCharacter(u);if(t==null)return null;let a={...t};for(let o of Object.keys(a.characterInfo.stats))a.characterInfo.stats[o]={statValue:a.characterInfo.stats[o],statHash:o};for(let o of Object.keys(a.metrics))a.metrics[o]={...a.metrics[o],metricHash:o};for(let o of Object.keys(a.records.records))a.records.records[o]={...a.records.records[o],recordHash:o,parentNodeHashes:h.destinyDataDefinition.DestinyRecordDefinition[o].parentNodeHashes};for(let o of Object.keys(a.characterRecords.records))a.characterRecords.records[o]={...a.characterRecords.records[o],recordHash:o,parentNodeHashes:h.destinyDataDefinition.DestinyRecordDefinition[o].parentNodeHashes};return a=h.mapHashesToDefinitionsInObject(a),await r.getItem("destiny2-use-cachebreaker",!1)&&t.characterInventory.filter(I=>I.lockable&&I.inventoryitemItemType==3).length>0,n.emit("destiny2-api-update",a),a},this.getPresentationNodeFromHash=function(u){const t=[],a=h.destinyDataDefinition.DestinyPresentationNodeDefinition[u];if(a&&(t.unshift({name:a.displayProperties.name,description:a.displayProperties.description,icon:a.displayProperties.icon,hash:u}),a.parentNodeHashes))for(let b of a.parentNodeHashes){const o=h.getPresentationNodeFromHash(b);for(let I of o)t.push(I)}return t},this.mapHashesToDefinitionsInObject=function(u){let t={...u},a=Object.keys(t);for(let b of a){let o=typeof t[b],I=t[b];if(Array.isArray(I)){for(let w=0;w<I.length;w++){let C=I[w];typeof C=="object"?I[w]=h.mapHashesToDefinitionsInObject(C):I[w]=C}t[b]=I}else if(o==="object"&&I!==null)t[b]=h.mapHashesToDefinitionsInObject(t[b]);else{if(b.indexOf("Hash")>-1&&!Array.isArray(I)){let w=b.split("Hash")[0].replace("current","").toLowerCase();switch(w){case"item":case"plugitem":w="inventoryitem";break}let C=f.find(k=>k.toLowerCase()==`Destiny${w}Definition`.toLowerCase()),j=h.destinyDataDefinition[C];if(j&&j[I]&&j[I].displayProperties){const k=j[I];k.displayProperties.name&&k.displayProperties.name.length>0?t[`${w}Name`]=k.displayProperties.name:k.setData&&k.setData.questLineName&&k.setData.questLineName.length>0&&(t[`${w}Name`]=k.setData.questLineName),k.displayProperties.description&&k.displayProperties.description.length>0&&(t[`${w}Description`]=k.displayProperties.description),k.displayProperties.icon&&k.displayProperties.icon.length>0&&(t[`${w}Icon`]=k.displayProperties.icon),k.progressDescription&&k.progressDescription.length>0&&(t[`${w}ProgressDescription`]=k.progressDescription),typeof k.inProgressValueStyle<"u"&&(t[`${w}InProgressValueStyle`]=k.inProgressValueStyle),typeof k.completedValueStyle<"u"&&(t[`${w}CompletedValueStyle`]=k.completedValueStyle),typeof k.itemType<"u"&&(t[`${w}ItemType`]=k.itemType),typeof k.parentNodeHashes<"u"&&(t.parentNodeHashes=k.parentNodeHashes.map(L=>h.getPresentationNodeFromHash(L)))}}t[b]=I}}return t},this.getTrackableData=async function(u=!1){let t=await h.getNamedDataObject(u);if(t==null)return null;let a=h.destinyDataDefinition.DestinySeasonDefinition[t.profile.currentSeasonHash],b=h.destinyDataDefinition.DestinySeasonPassDefinition[a.seasonPassHash],o=[],I=h.goalApi.getMilestoneData(t);for(let P of I)o.push(P);let w=h.goalApi.getBounties(t);for(let P of w)o.push(P);let C=h.goalApi.getQuests(t);for(let P of C)o.push(P);let j=h.goalApi.getCharacterRecords(t);for(let P of j)o.push(P);function k(P,E){if(typeof P.nextLevelAt<"u"&&typeof E.nextLevelAt<"u"){let _=P.progressToNextLevel/P.nextLevelAt*100,J=E.progressToNextLevel/E.nextLevelAt*100;return _<J?1:-1}return typeof P.endDate<"u"?typeof E.endDate>"u"||P.endDate<E.endDate?-1:1:P.order<E.order?1:-1}const L=o.filter(P=>P.tracked).sort(k),B=o.filter(P=>P.endDate&&!P.tracked).sort(k),q=o.filter(P=>!P.endDate&&!P.tracked).sort(k);return o=[...L,...B,...q],o.unshift(h.goalApi.getSeasonRankData(t,a,b)),h.trackedGoals=o,n.emit("goal-list-update",o),o};let h=this;return this.goalApi=new he(this),e("Initialized"),this}}V("MAIN","Starting app...");window.eventEmitter=new pe;window.db=new ue;window.apiClient=new me("5625a52ed6b54ecfb8246071cfcd6085","everversedata");function ge(){const p=M(!1),c=M(!1),D=M([]);return{isDataLoaded:p,isAuthenticated:c,goals:D}}const $=ge();window.appState=W($);window.db.initializeDatabase().then(async()=>{V("MAIN","Database initialized, checking for updates..."),$.isAuthenticated.value=await window.apiClient.checkIfAuthenticated(),Y(v(fe,{}),document.getElementById("app"))});
//# sourceMappingURL=index-c7d92d17.js.map
