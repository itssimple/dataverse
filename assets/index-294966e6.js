var x=Object.defineProperty;var O=(u,s,y)=>s in u?x(u,s,{enumerable:!0,configurable:!0,writable:!0,value:y}):u[s]=y;var c=(u,s,y)=>(O(u,typeof s!="symbol"?s+"":s,y),y);import{o as h,_ as k,R as C,q as R,D as j,c as B,F as V,B as $,d as L}from"./vendor-c23458f1.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))e(a);new MutationObserver(a=>{for(const l of a)if(l.type==="childList")for(const n of l.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&e(n)}).observe(document,{childList:!0,subtree:!0});function y(a){const l={};return a.integrity&&(l.integrity=a.integrity),a.referrerPolicy&&(l.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?l.credentials="include":a.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function e(a){if(a.ep)return;a.ep=!0;const l=y(a);fetch(a.href,l)}})();function p(u,...s){console.log(`[${u}]`,JSON.stringify([...s]))}function _(u){return u.isAuthenticated?(location.href="/#/logging-in",h(k,{})):h(k,{children:["Main page -"," ",h("a",{href:"https://o2g.itssimple.se/authenticate/everversedata?state=dataverse-"+new Date().getTime(),children:"Log in"})]})}function U(){const u=window.apiClient,s=C();p("Auth","Authenticated page, getting code",s);const e=new URL(s,location.origin).searchParams.get("code");return e?(u.getToken("",e).then(()=>{p("Auth","Got token, redirecting to dashboard"),location.href="/#/logging-in"}).catch(a=>{p("Auth","Failed to get token, redirecting to main page"),location.href="/"}),h(k,{children:"Authenticated, redirecting to Dashboard"})):(p("Auth","No code found, redirecting to main page"),location.href="/",h(k,{children:"Redirecting to main page"}))}function F(u){return u.isAuthenticated.value?u.isDataLoaded.value?h(k,{children:"Blep"}):(location.href="/#/logging-in",h(k,{})):(location.href="/",h(k,{}))}function J(){return h("footer",{className:"fui body fiction",children:["Â© 2023",new Date().getUTCFullYear()!=2023?" - "+new Date().getUTCFullYear():null," ","NoLifeKing85#2914"]})}function G(u){const s=window.apiClient,y=window.eventEmitter;y.addEventListener("loading-text",a=>{a&&e(a)});function e(a){let l=document.getElementById("loading-text");l&&(l.innerText=a)}return s.checkIfAuthenticated().then(async a=>{if(!a){location.href="/";return}p("LOGIN","Authenticated, checking manifests"),e("Checking manifest ...");let l=await s.checkManifestVersion();if(l==null){e("Something is wrong with Destiny 2, please reload the page.");return}p("LOGIN",l),e("Loading profile data"),await s.getLinkedProfiles(),e("Checking for missing definitions");let n=await s.checkStoredDefinitions(!1);n.length>0&&(e(`Downloading ${n.length} missing definition(s)`),await s.checkStoredDefinitions(!0)),e("Loading data..."),await s.loadDataFromStorage(),e("Loading data... done"),u.isDataLoaded.value=!0,setTimeout(()=>{e("Opening application..."),y.emit("manifests-loaded"),setTimeout(()=>{location.href="/#/dashboard"},1e3)},1e3)}),h(k,{children:h("span",{class:"fui body",id:"loading-text",children:"Logging in and loading data ..."})})}function q(){const u=R(window.appState);return h(k,{children:[h("header",{className:"header subscreen",children:"Dataverse"}),h("div",{class:"app",children:h(j,{history:B(),children:[h(k,{path:"/",children:h(_,{...u})}),h(k,{path:"/authenticated",children:h(U,{})}),h(k,{path:"/logging-in",children:h(G,{...u})}),h(k,{path:"/dashboard",children:h(F,{...u})})]})}),h(J,{})]})}class z{constructor(){c(this,"DBInstance");c(this,"initializeDatabase");c(this,"setItem");c(this,"setItems");c(this,"getItem");c(this,"removeItem");c(this,"setStorageItem");c(this,"setStorageItems");c(this,"getStorageItem");c(this,"getStorageItems");c(this,"removeStorageItem");this.DBInstance=null,this.initializeDatabase=async function(){return new Promise((n,r)=>{let m=window.indexedDB.open("destiny2-dataverse",2);m.onupgradeneeded=function(o){const D=m.result;p("DB","Old",o.oldVersion,"New",o.newVersion),o.oldVersion<1&&(p("DB","Creating first version of database, since it never existed on this installation."),D.createObjectStore("storage",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key")),o.oldVersion<2&&(p("DB","Creating object store for player/character activity"),D.createObjectStore("playerActivity",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"),D.createObjectStore("activityDetails",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"))},m.onsuccess=function(o){p("DB","Loaded database"),l.DBInstance=o.target.result,n()},m.onerror=function(o){p("DB","Failed to load database"),r(o)}})};async function s(n,r,m){return new Promise((o,D)=>{const I=l.DBInstance.transaction(n,"readwrite").objectStore(n).put({key:r,value:m});I.onsuccess=function(){o()},I.onerror=function(d){D(d)}})}async function y(n,r=null){return new Promise((m,o)=>{const S=l.DBInstance.transaction(n,"readonly").objectStore(n).getAll();S.onsuccess=function(){const I=S.result;m(r?I.filter(r):I)},S.onerror=function(I){o(I)}})}async function e(n,r,m=null){return new Promise((o,D)=>{const I=l.DBInstance.transaction(n,"readonly").objectStore(n).get(r);I.onsuccess=function(d){d.target.result?o(d.target.result.value):o(m)},I.onerror=function(d){D(d)}})}async function a(n,r){return new Promise((m,o)=>{const S=l.DBInstance.transaction(n,"readwrite").objectStore(n).delete(r);S.onsuccess=function(){m()},S.onerror=function(I){o(I)}})}this.setItem=async function(n,r){return await s("storage",n,r)},this.setItems=async function(n){for(let r of n)await s("storage",r.key,r.value)},this.getItem=async function(n,r=null){return await e("storage",n,r)},this.removeItem=async function(n){return await a("storage",n)},this.setStorageItem=async function(n,r,m){return await s(n,r,m)},this.setStorageItems=async function(n,r){for(let m of r)await s(n,m.key,m.value)},this.getStorageItem=async function(n,r,m=null){return await e(n,r,m)},this.getStorageItems=async function(n,r=null){return await y(n,r)},this.removeStorageItem=async function(n,r){return await a(n,r)};var l=this;return this}}class H{constructor(){c(this,"eventListeners");c(this,"addEventListener");c(this,"emit");return this.eventListeners=[],this.addEventListener=function(s,y){p("EVENT:REGISTERED",s),this.eventListeners.push({eventName:s,handler:y})},this.emit=async function(s,...y){return JSON.parse(await window.db.getItem("d2-debugmode")??"false")?p("EVENT:EMITTING",s,...y):p("EVENT:EMITTING",s),new Promise((a,l)=>{this.eventListeners.filter(n=>n.eventName==s).forEach(async n=>{try{await n.handler(...y)}catch(r){p("EVENT:ERROR",s,r),console.error(r),l(r)}}),a(!0)})},p("EventEmitter","Initialized"),this}}class K{constructor(s,y){c(this,"checkIfAuthenticated");c(this,"getToken");c(this,"refreshToken");c(this,"checkManifestVersion");c(this,"checkStoredDefinitions");c(this,"loadDestinyContentData");c(this,"loadDataFromStorage");c(this,"getManifest");c(this,"loadCommonSettings");c(this,"getUserToken");c(this,"getLinkedProfiles");c(this,"apiToken");c(this,"applicationName");c(this,"cachedManifest");c(this,"destinyDataDefinition");c(this,"lastVersion");c(this,"profile");c(this,"linkedProfiles");o("Initializing");const e=window.db,a=window.eventEmitter,l="https://o2g.itssimple.se",n="https://www.bungie.net",r="https://www.bungie.net/Platform",m=["DestinyActivityTypeDefinition","DestinyActivityDefinition","DestinyArtifactDefinition","DestinyChecklistDefinition","DestinyClassDefinition","DestinyDestinationDefinition","DestinyDamageTypeDefinition","DestinyFactionDefinition","DestinyGenderDefinition","DestinyItemCategoryDefinition","DestinyItemTierTypeDefinition","DestinyInventoryBucketDefinition","DestinyInventoryItemDefinition","DestinyMedalTierDefinition","DestinyMetricDefinition","DestinyMilestoneDefinition","DestinyObjectiveDefinition","DestinyPlaceDefinition","DestinyPresentationNodeDefinition","DestinyProgressionDefinition","DestinyRaceDefinition","DestinyRecordDefinition","DestinySeasonDefinition","DestinySeasonPassDefinition","DestinyStatDefinition","DestinyTraitDefinition"];this.lastVersion=null,this.applicationName=y,this.apiToken=s,this.destinyDataDefinition={};function o(...t){p("D2API",t)}async function D(t,f,i=null,g=null){let w={};return(i!==null||g!==null)&&(w["Content-Type"]="application/json",w["x-api-key"]=d.apiToken,g!==null&&(w.authorization=`Bearer ${g}`)),i!==null?await fetch(f,{method:t,headers:w,body:i}):await fetch(f,{method:t,headers:w})}async function T(){await e.getItem("destinyTokenExpires")<Date.now()&&(o("Token expired, refreshing"),await d.refreshToken())}function S(t){if(t.error)return o("Error handling token",JSON.stringify(t)),e.removeItem("destinyToken"),e.removeItem("destinyRefreshToken"),e.removeItem("destinyTokenExpires"),e.removeItem("destinyRefreshTokenExpires"),e.removeItem("destinyBungieMembershipId"),!1;e.setItem("destinyToken",t.access_token),e.setItem("destinyRefreshToken",t.refresh_token);let f=Date.now()+t.expires_in*1e3;e.setItem("destinyTokenExpires",f);let i=Date.now()+t.refresh_expires_in*1e3;return e.setItem("destinyRefreshTokenExpires",i),e.setItem("destinyBungieMembershipId",t.membership_id),!0}this.loadDataFromStorage=async()=>{o("Loading data from storage");let t=await e.getItem("manifest");t!==null&&(d.cachedManifest=JSON.parse(t));let f=await e.getItem("manifestVersion");f!==null&&(d.lastVersion=f),d.checkStoredDefinitions();for(let w of m){let v=await e.getItem(`destinyContent-${w}`);v!==null&&(d.destinyDataDefinition[w]=JSON.parse(v))}let i=await e.getItem("destiny-profile");i!==null&&(d.profile=JSON.parse(i));let g=await e.getItem("destiny-linkedProfiles");g!==null&&(d.linkedProfiles=JSON.parse(g)),o("Data loaded from storage"),a.emit("destiny-data-loaded")},this.checkIfAuthenticated=async()=>{try{await T();const t=await e.getItem("destinyToken")!==null;return a.emit("destiny2:authenticated",t),t}catch(t){return o("Error checking if authenticated",t),a.emit("destiny2:authenticated",!1),!1}},this.getToken=async(t,f)=>{const i=await D("POST",`${l}/token/${d.applicationName}`,JSON.stringify({code:f}));if(i.status===200){let g=await i.json();return S(g)?a.emit("destiny2:auth-success"):a.emit("destiny2:auth-failed"),g}o("Error getting token",i.status,i.statusText,await i.text()),a.emit("destiny2:auth-failed")},this.refreshToken=async()=>{const t=await e.getItem("destinyRefreshToken");if(t==null)return a.emit("destiny2:refreshToken",null),null;const f=await D("POST",`${l}/refresh/${d.applicationName}`,JSON.stringify({refresh_token:t}));if(f.status===200){let i=await f.json();S(i)?a.emit("destiny2:refresh-success"):a.emit("destiny2:refresh-failed");return}else a.emit("destiny2:refresh-failed")},this.checkManifestVersion=async()=>(o("Checking manifest version"),new Promise(async function(t,f){let i=await d.getManifest();if(i==null)return o("Failed to fetch API"),null;let g=await e.getItem("manifestVersion")??"null";if(console.log(i,g),i.Response.version!==g){await e.removeItem("lastManifestUpdate"),await e.removeItem("manifest"),await e.removeItem("manifestVersion");for(let w of m)await e.removeItem(`destinyContent-${w}`);d.cachedManifest=i.Response,await e.setItem("manifestVersion",i.Response.version),await e.setItem("manifest",JSON.stringify(d.cachedManifest)),await e.setItem("lastManifestUpdate",Date.now()),t({updatedManifest:!0,version:d.lastVersion}),o("Manifest updated");return}d.cachedManifest=i.Response,t({updatedManifest:!1,version:d.lastVersion}),o("Manifest version is up to date")})),this.checkStoredDefinitions=async function(t=!0){let f=[];for(let i of m)await e.getItem(`destinyContent-${i}`)===null&&f.push(i);if(f.length>0&&t){for(let i of f)await e.removeItem(`destinyContent-${i}`);await d.loadDestinyContentData(f)}return f},this.loadDestinyContentData=async function(t=[]){for(let f of t)await I(f)};async function I(t){let f=d.cachedManifest;const i=t.replace("Destiny","").split(/(?=[A-Z])/).join(" ");a.emit("loading-text",`Loading ${i}`);const g=await D("GET",`${n}${f.jsonWorldComponentContentPaths.en[t]}`);g.headers.get("content-length");let w=0;const v=new Response(new ReadableStream({async start(M){const N=g.body.getReader();let P=0;for(;;){var b=await N.read();if(b.done)break;w+=b.value.byteLength,P++,P%30===0&&a.emit("loading-text",`Loading ${i} (${new Intl.NumberFormat("sv-SE").format(Math.round(w/1024/1024*100+Number.EPSILON)/100)} MB)`),M.enqueue(b.value)}a.emit("loading-text",`Loading ${i} (${new Intl.NumberFormat("sv-SE").format(Math.round(w/1024/1024*100+Number.EPSILON)/100)} MB)`),M.close()}}));if(g.status!==200){p("Manifest download error",await v.json());return}const E=await v.json();d.destinyDataDefinition[t]=E,e.setItem(`destinyContent-${t}`,JSON.stringify(E))}this.getManifest=async function(){let t=await e.getItem("lastManifestUpdate");if(o("Checking if manifest is cached"),t!==null&&Date.now()-t<6e4*60){let i=await e.getItem("manifest");if(i!==null)return o("Manifest is cached"),{Response:JSON.parse(i)}}let f=await D("GET",`${r}/Destiny2/Manifest/`);if(f.status===200){let i=await f.json();return i.ErrorStatus=="Success"?(e.setItem("lastManifestUpdate",Date.now()),e.setItem("manifest",JSON.stringify(i.Response)),o("Manifest updated from API"),{Response:i.Response}):(o("Manifesterror"),o(i.Response),null)}else{let i=f.json();return o("Error when fetching Manifest"),o(i),null}},this.loadCommonSettings=async function(){await T();const t=await D("GET",`${r}/Settings`,null,await this.getUserToken());return t.status===200?await t.json():(o("Error fetching common settings",t.status,t.statusText),null)},this.getUserToken=async function(){return await e.getItem("destinyToken")},this.getLinkedProfiles=async function(){return await T(),new Promise(async(t,f)=>{var i=await e.getItem("destinyBungieMembershipId");let g=await D("GET",`${r}/Destiny2/-1/Profile/${i}/LinkedProfiles/`,null,await this.getUserToken());if(g.status===200){let w=await g.json();e.setItem("destiny-linkedProfiles",JSON.stringify(w.Response)),d.linkedProfiles=w.Response,t(w.Response)}else d.refreshToken(),f(g)})};let d=this;return o("Initialized"),this}}p("MAIN","Starting app...");window.eventEmitter=new H;window.db=new z;window.apiClient=new K("5625a52ed6b54ecfb8246071cfcd6085","everversedata");function W(){const u=L(!1),s=L(!1);return{isDataLoaded:u,isAuthenticated:s}}const A=W();window.appState=V(A);window.db.initializeDatabase().then(async()=>{p("MAIN","Database initialized, checking for updates..."),A.isAuthenticated.value=await window.apiClient.checkIfAuthenticated(),$(h(q,{}),document.getElementById("app"))});
//# sourceMappingURL=index-294966e6.js.map
