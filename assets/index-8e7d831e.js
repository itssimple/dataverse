var b=Object.defineProperty;var v=(f,i,g)=>i in f?b(f,i,{enumerable:!0,configurable:!0,writable:!0,value:g}):f[i]=g;var c=(f,i,g)=>(v(f,typeof i!="symbol"?i+"":i,g),g);import{o as d,_ as k,R as E,D as M,c as A,B as C}from"./vendor-d09b161a.js";(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const u of r)if(u.type==="childList")for(const e of u.addedNodes)e.tagName==="LINK"&&e.rel==="modulepreload"&&t(e)}).observe(document,{childList:!0,subtree:!0});function g(r){const u={};return r.integrity&&(u.integrity=r.integrity),r.referrerPolicy&&(u.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?u.credentials="include":r.crossOrigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function t(r){if(r.ep)return;r.ep=!0;const u=g(r);fetch(r.href,u)}})();function h(f,...i){console.log(`[${f}]`,JSON.stringify([...i]))}function j(f){return f.authenticated?(location.href="/#/logging-in",d(k,{})):d(k,{children:["Main page -"," ",d("a",{href:"https://o2g.itssimple.se/authenticate/everversedata?state=dataverse-"+new Date().getTime(),children:"Log in"})]})}function P(){const f=window.apiClient,i=E();h("Auth","Authenticated page, getting code",i);const t=new URL(i,location.origin).searchParams.get("code");return h("Auth","Code",t),t?(f.getToken("",t).then(()=>{h("Auth","Got token, redirecting to dashboard"),location.href="/#/logging-in"}).catch(r=>{h("Auth","Failed to get token, redirecting to main page"),location.href="/"}),d(k,{children:"Authenticated, redirecting to Dashboard"})):(h("Auth","No code found, redirecting to main page"),location.href="/",d(k,{children:"Redirecting to main page"}))}function x(){return window.apiClient.checkIfAuthenticated().then(i=>{i||(location.href="/")}),d(k,{children:"Blep"})}function R(){return d("footer",{className:"fui body fiction",children:["Â© 2023",new Date().getUTCFullYear()!=2023?" - "+new Date().getUTCFullYear():null," ","NoLifeKing85#2914"]})}function N(){const f=window.apiClient;return f.checkIfAuthenticated().then(async i=>{if(!i){location.href="/";return}h("LOGIN","Authenticated, checking manifests"),await f.checkManifestVersion()}),d(k,{children:"Logging in and checking manifests"})}function O(f){return d(k,{children:[d("header",{className:"header subscreen",children:"Dataverse"}),d("div",{class:"app",children:d(M,{history:A(),children:[d(k,{path:"/",children:d(j,{...f})}),d(k,{path:"/authenticated",children:d(P,{})}),d(k,{path:"/logging-in",children:d(N,{})}),d(k,{path:"/dashboard",children:d(x,{})})]})}),d(R,{})]})}class B{constructor(){c(this,"DBInstance");c(this,"initializeDatabase");c(this,"setItem");c(this,"setItems");c(this,"getItem");c(this,"removeItem");c(this,"setStorageItem");c(this,"setStorageItems");c(this,"getStorageItem");c(this,"getStorageItems");c(this,"removeStorageItem");this.DBInstance=null,this.initializeDatabase=async function(){return new Promise((e,a)=>{let l=window.indexedDB.open("destiny2-dataverse",2);l.onupgradeneeded=function(o){const p=l.result;h("DB","Old",o.oldVersion,"New",o.newVersion),o.oldVersion<1&&(h("DB","Creating first version of database, since it never existed on this installation."),p.createObjectStore("storage",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key")),o.oldVersion<2&&(h("DB","Creating object store for player/character activity"),p.createObjectStore("playerActivity",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"),p.createObjectStore("activityDetails",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"))},l.onsuccess=function(o){h("DB","Loaded database"),u.DBInstance=o.target.result,e()},l.onerror=function(o){h("DB","Failed to load database"),a(o)}})};async function i(e,a,l){return new Promise((o,p)=>{const D=u.DBInstance.transaction(e,"readwrite").objectStore(e).put({key:a,value:l});D.onsuccess=function(){o()},D.onerror=function(y){p(y)}})}async function g(e,a=null){return new Promise((l,o)=>{const w=u.DBInstance.transaction(e,"readonly").objectStore(e).getAll();w.onsuccess=function(){const D=w.result;l(a?D.filter(a):D)},w.onerror=function(D){o(D)}})}async function t(e,a,l=null){return new Promise((o,p)=>{const D=u.DBInstance.transaction(e,"readonly").objectStore(e).get(a);D.onsuccess=function(y){y.target.result?o(y.target.result.value):o(l)},D.onerror=function(y){p(y)}})}async function r(e,a){return new Promise((l,o)=>{const w=u.DBInstance.transaction(e,"readwrite").objectStore(e).delete(a);w.onsuccess=function(){l()},w.onerror=function(D){o(D)}})}this.setItem=async function(e,a){return await i("storage",e,a)},this.setItems=async function(e){for(let a of e)await i("storage",a.key,a.value)},this.getItem=async function(e,a=null){return await t("storage",e,a)},this.removeItem=async function(e){return await r("storage",e)},this.setStorageItem=async function(e,a,l){return await i(e,a,l)},this.setStorageItems=async function(e,a){for(let l of a)await i(e,l.key,l.value)},this.getStorageItem=async function(e,a,l=null){return await t(e,a,l)},this.getStorageItems=async function(e,a=null){return await g(e,a)},this.removeStorageItem=async function(e,a){return await r(e,a)};var u=this;return this}}class V{constructor(){c(this,"eventListeners");c(this,"addEventListener");c(this,"emit");return this.eventListeners=[],this.addEventListener=function(i,g){h("EVENT:REGISTERED",i),this.eventListeners.push({eventName:i,handler:g})},this.emit=async function(i,...g){return JSON.parse(await window.db.getItem("d2-debugmode")??"false")?h("EVENT:EMITTING",i,...g):h("EVENT:EMITTING",i),new Promise((r,u)=>{this.eventListeners.filter(e=>e.eventName==i).forEach(async e=>{try{await e.handler(...g)}catch(a){h("EVENT:ERROR",i,a),console.error(a),u(a)}}),r(!0)})},h("EventEmitter","Initialized"),this}}class L{constructor(i,g){c(this,"checkIfAuthenticated");c(this,"getToken");c(this,"refreshToken");c(this,"checkManifestVersion");c(this,"checkStoredDefinitions");c(this,"loadDestinyContentData");c(this,"apiToken");c(this,"applicationName");c(this,"cachedManifest");c(this,"destinyDataDefinition");c(this,"lastVersion");c(this,"getManifest");h("Destiny2ApiClient","Initializing");const t=window.db,r=window.eventEmitter,u="https://o2g.itssimple.se",e="https://www.bungie.net",a="https://www.bungie.net/Platform",l=["DestinyActivityTypeDefinition","DestinyActivityDefinition","DestinyArtifactDefinition","DestinyChecklistDefinition","DestinyClassDefinition","DestinyDestinationDefinition","DestinyDamageTypeDefinition","DestinyFactionDefinition","DestinyGenderDefinition","DestinyItemCategoryDefinition","DestinyItemTierTypeDefinition","DestinyInventoryBucketDefinition","DestinyInventoryItemDefinition","DestinyMedalTierDefinition","DestinyMetricDefinition","DestinyMilestoneDefinition","DestinyObjectiveDefinition","DestinyPlaceDefinition","DestinyPresentationNodeDefinition","DestinyProgressionDefinition","DestinyRaceDefinition","DestinyRecordDefinition","DestinySeasonDefinition","DestinySeasonPassDefinition","DestinyStatDefinition","DestinyTraitDefinition"];this.lastVersion=null,this.applicationName=g,this.apiToken=i,this.destinyDataDefinition={};function o(...n){h("Destiny2ApiClient",n)}async function p(n,m,s=null,I=null){return s!==null?await fetch(m,{method:n,headers:{"x-api-key":y.apiToken,authorization:I!=null?`Bearer ${I}`:"","Content-Type":"application/json"},body:s}):await fetch(m,{method:n,headers:{"x-api-key":y.apiToken,authorization:I!=null?`Bearer ${I}`:""}})}async function T(){await t.getItem("destinyTokenExpires")<Date.now()&&(o("Token expired, refreshing"),await y.refreshToken())}function w(n){if(n.error)return o("Error handling token",JSON.stringify(n)),t.removeItem("destinyToken"),t.removeItem("destinyRefreshToken"),t.removeItem("destinyTokenExpires"),t.removeItem("destinyRefreshTokenExpires"),t.removeItem("destinyBungieMembershipId"),!1;t.setItem("destinyToken",n.access_token),t.setItem("destinyRefreshToken",n.refresh_token);let m=Date.now()+n.expires_in*1e3;t.setItem("destinyTokenExpires",m);let s=Date.now()+n.refresh_expires_in*1e3;return t.setItem("destinyRefreshTokenExpires",s),t.setItem("destinyBungieMembershipId",n.membership_id),!0}this.checkIfAuthenticated=async()=>{try{await T();const n=await t.getItem("destinyToken")!==null;return r.emit("destiny2:authenticated",n),n}catch(n){return o("Error checking if authenticated",n),r.emit("destiny2:authenticated",!1),!1}},this.getToken=async(n,m)=>{const s=await p("POST",`${u}/token/${y.applicationName}`,JSON.stringify({code:m}));if(s.status===200){let I=await s.json();return w(I)?r.emit("destiny2:auth-success"):r.emit("destiny2:auth-failed"),I}o("Error getting token",s.status,s.statusText,await s.text()),r.emit("destiny2:auth-failed")},this.refreshToken=async()=>{const n=await t.getItem("destinyRefreshToken");if(n==null)return r.emit("destiny2:refreshToken",null),null;const m=await p("POST",`${u}/refresh/${y.applicationName}`,JSON.stringify({refresh_token:n}));if(m.status===200){let s=await m.json();w(s)?r.emit("destiny2:refresh-success"):r.emit("destiny2:refresh-failed");return}else r.emit("destiny2:refresh-failed")},this.checkManifestVersion=async()=>(o("Checking manifest version"),new Promise(async function(n,m){let s=await y.getManifest();if(s==null)return h("D2API","Failed to fetch API"),null;let I=await t.getItem("manifestVersion")??"null";if(s.Response.version!==I){await t.removeItem("lastManifestUpdate"),await t.removeItem("manifest"),await t.removeItem("manifestVersion");for(let S of l)await t.removeItem(`destinyContent-${S}`);y.cachedManifest=s.Response,await t.setItem("manifestVersion",s.Response.version),await t.setItem("manifest",JSON.stringify(y.cachedManifest)),await t.setItem("lastManifestUpdate",Date.now()),n({updatedManifest:!0,version:y.lastVersion}),o("Manifest updated");return}y.cachedManifest=s.Response,n({updatedManifest:!1,version:y.lastVersion}),o("Manifest version is up to date")})),this.checkStoredDefinitions=async function(n=!0){let m=[];for(let s of l)await t.getItem(`destinyContent-${s}`)===null&&m.push(s);if(m.length>0&&n){for(let s of m)await t.removeItem(`destinyContent-${s}`);await y.loadDestinyContentData()}return m},this.loadDestinyContentData=async function(){for(let n of l)await D(n)};async function D(n){let m=y.cachedManifest;r.emit("loading-text",`Loading ${n.replace("Destiny","")}`);const s=await p("GET",`${e}${m.jsonWorldComponentContentPaths.en[n]}`);if(s.status!==200){h("Manifest download error",await s.json());return}const I=await s.json();y.destinyDataDefinition[n]=I,t.setItem(`destinyContent-${n}`,JSON.stringify(I))}this.getManifest=async function(){let n=await t.getItem("lastManifestUpdate");if(o("Checking if manifest is cached"),n!==null&&Date.now()-n<6e4*60&&await t.getItem("manifest")!==null)return o("Manifest is cached"),{Response:JSON.parse(await t.getItem("manifest"))};let m=await p("GET",`${a}/Destiny2/Manifest/`);if(m.status===200){let s=await m.json();return s.ErrorStatus=="Success"?(t.setItem("lastManifestUpdate",Date.now()),t.setItem("manifest",JSON.stringify(s.Response)),o("Manifest updated"),{Response:s.Response}):(o("Manifesterror"),o(s.Response),null)}else{let s=m.json();return o("Error when fetching Manifest"),o(s),null}};let y=this;return o("Initialized"),this}}h("MAIN","Starting app...");window.eventEmitter=new V;window.db=new B;window.apiClient=new L("5625a52ed6b54ecfb8246071cfcd6085","everversedata");window.db.initializeDatabase().then(async()=>{h("MAIN","Database initialized, checking for updates...");const f=await window.apiClient.checkIfAuthenticated();C(d(O,{authenticated:f}),document.getElementById("app"))});
//# sourceMappingURL=index-8e7d831e.js.map
