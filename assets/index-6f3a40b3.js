var w=Object.defineProperty;var k=(m,i,u)=>i in m?w(m,i,{enumerable:!0,configurable:!0,writable:!0,value:u}):m[i]=u;var h=(m,i,u)=>(k(m,typeof i!="symbol"?i+"":i,u),u);import{o as y,_ as I,R as b,D as T,c as S,B as E}from"./vendor-d09b161a.js";(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))l(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const e of a.addedNodes)e.tagName==="LINK"&&e.rel==="modulepreload"&&l(e)}).observe(document,{childList:!0,subtree:!0});function u(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function l(n){if(n.ep)return;n.ep=!0;const a=u(n);fetch(n.href,a)}})();function o(m,...i){console.log(`[${m}]`,JSON.stringify([...i]))}function D(){return y(I,{children:["Main page -"," ",y("a",{href:"https://o2g.itssimple.se/authenticate/everversedata?state=dataverse-"+new Date().getTime(),children:"Log in"})]})}const v=window.apiClient;function A(){const m=b();o("Auth","Authenticated page, getting code",m);const u=new URL(m,location.origin).searchParams.get("code");return o("Auth","Code",u),u?(v.getToken("",u).then(()=>{o("Auth","Got token, redirecting to dashboard"),location.href="/#/dashboard"}).catch(l=>{o("Auth","Failed to get token, redirecting to main page"),location.href="/"}),y(I,{children:"Authenticated, redirecting to Dashboard"})):(o("Auth","No code found, redirecting to main page"),location.href="/",y(I,{children:"Redirecting to main page"}))}function x(){return y(I,{children:"Blep"})}function B(){return y("footer",{className:"fui body fiction",children:["Â© 2023",new Date().getUTCFullYear()!=2023?" - "+new Date().getUTCFullYear():null," ","NoLifeKing85#2914"]})}function P(){return y(I,{children:[y("header",{className:"header tooltip",children:"Dataverse"}),y("div",{class:"app",children:y(T,{history:S(),children:[y(I,{path:"/",children:y(D,{})}),y(I,{path:"/authenticated",children:y(A,{})}),y(I,{path:"/dashboard",children:y(x,{})})]})}),y(B,{})]})}class j{constructor(){h(this,"DBInstance");h(this,"initializeDatabase");h(this,"setItem");h(this,"setItems");h(this,"getItem");h(this,"removeItem");h(this,"setStorageItem");h(this,"setStorageItems");h(this,"getStorageItem");h(this,"getStorageItems");h(this,"removeStorageItem");this.DBInstance=null,this.initializeDatabase=async function(){return new Promise((e,t)=>{let c=window.indexedDB.open("destiny2-dataverse",2);c.onupgradeneeded=function(d){const p=c.result;o("DB","Old",d.oldVersion,"New",d.newVersion),d.oldVersion<1&&(o("DB","Creating first version of database, since it never existed on this installation."),p.createObjectStore("storage",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key")),d.oldVersion<2&&(o("DB","Creating object store for player/character activity"),p.createObjectStore("playerActivity",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"),p.createObjectStore("activityDetails",{autoIncrement:!1,keyPath:"key"}).createIndex("by_key","key"))},c.onsuccess=function(d){o("DB","Loaded database"),a.DBInstance=d.target.result,e()},c.onerror=function(d){o("DB","Failed to load database"),t(d)}})};async function i(e,t,c){return new Promise((d,p)=>{const s=a.DBInstance.transaction(e,"readwrite").objectStore(e).put({key:t,value:c});s.onsuccess=function(){d()},s.onerror=function(g){p(g)}})}async function u(e,t=null){return new Promise((c,d)=>{const f=a.DBInstance.transaction(e,"readonly").objectStore(e).getAll();f.onsuccess=function(){const s=f.result;c(t?s.filter(t):s)},f.onerror=function(s){d(s)}})}async function l(e,t,c=null){return new Promise((d,p)=>{const s=a.DBInstance.transaction(e,"readonly").objectStore(e).get(t);s.onsuccess=function(g){g.target.result?d(g.target.result.value):d(c)},s.onerror=function(g){p(g)}})}async function n(e,t){return new Promise((c,d)=>{const f=a.DBInstance.transaction(e,"readwrite").objectStore(e).delete(t);f.onsuccess=function(){c()},f.onerror=function(s){d(s)}})}this.setItem=async function(e,t){return await i("storage",e,t)},this.setItems=async function(e){for(let t of e)await i("storage",t.key,t.value)},this.getItem=async function(e,t=null){return await l("storage",e,t)},this.removeItem=async function(e){return await n("storage",e)},this.setStorageItem=async function(e,t,c){return await i(e,t,c)},this.setStorageItems=async function(e,t){for(let c of t)await i(e,c.key,c.value)},this.getStorageItem=async function(e,t,c=null){return await l(e,t,c)},this.getStorageItems=async function(e,t=null){return await u(e,t)},this.removeStorageItem=async function(e,t){return await n(e,t)};var a=this;return this}}class O{constructor(){h(this,"eventListeners");h(this,"addEventListener");h(this,"emit");return this.eventListeners=[],this.addEventListener=function(i,u){o("EVENT:REGISTERED",i),this.eventListeners.push({eventName:i,handler:u})},this.emit=async function(i,...u){return JSON.parse(await window.db.getItem("d2-debugmode")??"false")?o("EVENT:EMITTING",i,...u):o("EVENT:EMITTING",i),new Promise((n,a)=>{this.eventListeners.filter(e=>e.eventName==i).forEach(async e=>{try{await e.handler(...u)}catch(t){o("EVENT:ERROR",i,t),console.error(t),a(t)}}),n(!0)})},o("EventEmitter","Initialized"),this}}class _{constructor(i,u){h(this,"checkIfAuthenticated");h(this,"getToken");h(this,"refreshToken");h(this,"apiToken");o("Destiny2ApiClient","Initializing");const l=window.db,n=window.eventEmitter,a="https://o2g.itssimple.se";let e=u;this.apiToken=i;async function t(r,f,s=null,g=null){return s!==null?await fetch(f,{method:r,headers:{"x-api-key":p.apiToken,authorization:g!=null?`Bearer ${g}`:"","Content-Type":"application/json"},body:s}):await fetch(f,{method:r,headers:{"x-api-key":p.apiToken,authorization:g!=null?`Bearer ${g}`:""}})}async function c(){await l.getItem("destinyTokenExpires")<Date.now()&&(o("Destiny2ApiClient","Token expired, refreshing"),await p.refreshToken())}function d(r){if(r.error)return o("Destiny2ApiClient","Error handling token",JSON.stringify(r)),l.removeItem("destinyToken"),l.removeItem("destinyRefreshToken"),l.removeItem("destinyTokenExpires"),l.removeItem("destinyRefreshTokenExpires"),l.removeItem("destinyBungieMembershipId"),!1;l.setItem("destinyToken",r.access_token),l.setItem("destinyRefreshToken",r.refresh_token);let f=Date.now()+r.expires_in*1e3;l.setItem("destinyTokenExpires",f);let s=Date.now()+r.refresh_expires_in*1e3;return l.setItem("destinyRefreshTokenExpires",s),l.setItem("destinyBungieMembershipId",r.membership_id),!0}this.checkIfAuthenticated=async()=>{try{await c();const r=await l.getItem("destinyToken")!==null;return n.emit("destiny2:authenticated",r),r}catch(r){return o("Destiny2ApiClient","Error checking if authenticated",r),n.emit("destiny2:authenticated",!1),!1}},this.getToken=async(r,f)=>{const s=await t("POST",`${a}/token/${e}`,JSON.stringify({code:f}));if(s.status===200){let g=await s.json();return d(g)?n.emit("destiny2:auth-success"):n.emit("destiny2:auth-failed"),g}o("Destiny2ApiClient","Error getting token",s.status,s.statusText,await s.text()),n.emit("destiny2:auth-failed")},this.refreshToken=async()=>{const r=await l.getItem("destinyRefreshToken");if(r==null)return n.emit("destiny2:refreshToken",null),null;const f=await t("POST",`${a}/refresh/${e}`,JSON.stringify({refresh_token:r}));if(f.status===200){let s=await f.json();d(s)?n.emit("destiny2:refresh-success"):n.emit("destiny2:refresh-failed");return}else n.emit("destiny2:refresh-failed")};let p=this;return o("Destiny2ApiClient","Initialized"),this}}o("MAIN","Starting app...");window.eventEmitter=new O;window.db=new j;window.apiClient=new _("5625a52ed6b54ecfb8246071cfcd6085",{}.VITE_BUNGIE_API_APP);window.db.initializeDatabase().then(async()=>{o("MAIN","Database initialized, checking for updates...")});E(y(P,{}),document.getElementById("app"));
//# sourceMappingURL=index-6f3a40b3.js.map
